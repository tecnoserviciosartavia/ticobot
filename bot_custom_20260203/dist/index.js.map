{"version":3,"sources":["../src/config.ts","../src/logger.ts","../src/reminder-processor.ts","../src/api-client.ts","../src/whatsapp-client.ts","../src/utils/phone.ts","../src/index.ts"],"sourcesContent":["import dotenv from 'dotenv';\nimport { z } from 'zod';\n\ndotenv.config({ path: process.env.BOT_ENV_PATH ?? undefined });\n\nconst configSchema = z.object({\n  apiBaseUrl: z.string().url(),\n  apiToken: z.string().min(1, 'Se requiere un token de API para autenticar el bot'),\n  pollIntervalMs: z\n    .string()\n    .optional()\n    .transform((value) => (value ? Number.parseInt(value, 10) : 30000))\n    .pipe(z.number().int().min(5000).max(600000)),\n  lookAheadMinutes: z\n    .string()\n    .optional()\n    .transform((value) => (value ? Number.parseInt(value, 10) : 30))\n    .pipe(z.number().int().min(1).max(240)),\n  maxBatch: z\n    .string()\n    .optional()\n    .transform((value) => (value ? Number.parseInt(value, 10) : 20))\n    .pipe(z.number().int().min(1).max(100)),\n  sessionPath: z.string().default('storage/whatsapp-session'),\n  defaultCountryCode: z.string().default('506'),\n  logLevel: z.string().default('info')\n  ,\n  menuPath: z.string().optional()\n  ,\n  paymentContact: z.string().optional(),\n  bankAccountsRaw: z.string().optional(),\n  beneficiaryName: z.string().optional(),\n  serviceName: z.string().optional()\n});\n\nconst parsed = configSchema.parse({\n  apiBaseUrl: process.env.BOT_API_BASE_URL,\n  apiToken: process.env.BOT_API_TOKEN,\n  pollIntervalMs: process.env.BOT_POLL_INTERVAL_MS,\n  lookAheadMinutes: process.env.BOT_LOOK_AHEAD_MINUTES,\n  maxBatch: process.env.BOT_MAX_BATCH,\n  sessionPath: process.env.BOT_SESSION_PATH,\n  defaultCountryCode: process.env.BOT_DEFAULT_COUNTRY_CODE,\n  logLevel: process.env.BOT_LOG_LEVEL\n  ,\n  menuPath: process.env.BOT_MENU_PATH\n  ,\n  paymentContact: process.env.BOT_PAYMENT_CONTACT,\n  bankAccountsRaw: process.env.BOT_BANK_ACCOUNTS,\n  beneficiaryName: process.env.BOT_BENEFICIARY_NAME,\n  serviceName: process.env.BOT_SERVICE_NAME\n});\n\nexport type AppConfig = z.infer<typeof configSchema> & {\n  pollIntervalMs: number;\n  lookAheadMinutes: number;\n  maxBatch: number;\n  bankAccounts: string[];\n  paymentContact?: string;\n  beneficiaryName?: string;\n  serviceName?: string;\n};\n\nexport const config: AppConfig = {\n  ...parsed,\n  pollIntervalMs: parsed.pollIntervalMs,\n  lookAheadMinutes: parsed.lookAheadMinutes,\n  maxBatch: parsed.maxBatch\n  // expose parsed bank accounts as array\n  ,\n  bankAccounts: (parsed as any).bankAccountsRaw\n    ? String((parsed as any).bankAccountsRaw)\n        .split(/\\r?\\n|;/)\n        .map((s: string) => s.trim())\n        .filter(Boolean)\n    : [],\n  paymentContact: (parsed as any).paymentContact ?? ''\n  ,\n  beneficiaryName: (parsed as any).beneficiaryName ?? '',\n  serviceName: (parsed as any).serviceName ?? ''\n};\n","import pino from 'pino';\nimport { config } from './config.js';\n\nexport const logger = pino({\n  name: 'ticobot-whatsapp',\n  level: config.logLevel,\n  transport: process.env.NODE_ENV === 'production'\n    ? undefined\n    : {\n        target: 'pino-pretty',\n        options: {\n          colorize: true,\n          translateTime: 'HH:MM:ss'\n        }\n      }\n});\n","import pRetry, { FailedAttemptError } from 'p-retry';\nimport { apiClient } from './api-client.js';\nimport { logger } from './logger.js';\nimport { WhatsAppClient } from './whatsapp-client.js';\nimport { ReminderMessagePayload, ReminderRecord } from './types.js';\nimport { config } from './config.js';\n\nconst buildMessage = (reminder: ReminderRecord): ReminderMessagePayload => {\n  const payload = reminder.payload ?? {};\n  const lines: string[] = [];\n\n  // Helper: render a template replacing known tags with actual values\n  function renderTemplate(tpl: string) {\n    return String(tpl)\n      .replace(/\\{client_name\\}/g, reminder.client?.name ?? '')\n      .replace(/\\{amount\\}/g, String(payload.amount ?? ''))\n      .replace(/\\{due_date\\}/g, String(payload.due_date ?? ''));\n  }\n\n  // Build a detailed subscription reminder similar to the provided template\n  const clientName = reminder.client?.name ?? '';\n  // service name: prefer payload, then config, then fallback\n  const serviceName = payload.service_name ?? (config.serviceName || 'TicoCast');\n  \n  // Get due date from payload or contract\n  let dueDate = payload.due_date ?? '';\n  if (!dueDate && reminder.contract?.next_due_date) {\n    const dueDateObj = new Date(reminder.contract.next_due_date);\n    dueDate = dueDateObj.toLocaleDateString('es-CR', { day: '2-digit', month: 'long', year: 'numeric' });\n  }\n  \n  // amount: prefer contract amount (from contract summary), then payload.amount\n  const rawAmount = reminder.contract?.amount ?? payload.amount ?? '0';\n  // normalize string like \"10000\" or \"10000.00\" or with currency symbols\n  const amountNum = Number(String(rawAmount).replace(/[^0-9\\.\\-]/g, '')) || 0;\n  const amountFmt = amountNum ? amountNum.toLocaleString('es-CR') : '0';\n\n  lines.push(`${serviceName}, le informa que su Suscripción de Servicios de Entretenimiento:\\n`);\n  if (dueDate) lines.push(`Ha Vencido ${dueDate}`);\n  lines.push(`Total: ₡${amountFmt}`);\n  lines.push('');\n  lines.push('En caso de no recibir respuesta, nos vemos en la necesidad de Liberar el Perfil de su Suscripción.');\n  lines.push('');\n  lines.push('Si desea volver a disfrutar de nuestros servicios, puede realizar el pago correspondiente y con gusto le proporcionaremos una Cuenta Nueva.');\n  lines.push('');\n  lines.push('Renovarla es fácil!, solo realice el pago y envíenos el comprobante.');\n  lines.push('');\n  if (config.paymentContact && String(config.paymentContact).trim()) {\n    lines.push(`Sinpemóvil: ${String(config.paymentContact).trim()}`);\n  }\n  lines.push('');\n  lines.push('Para depósitos:');\n  lines.push('');\n  // Use configured bank accounts from system settings (no hardcoded fallbacks)\n  if (Array.isArray(config.bankAccounts) && config.bankAccounts.length) {\n    for (const acct of config.bankAccounts) {\n      lines.push(acct);\n    }\n  }\n  lines.push('');\n  // Beneficiario: use configured beneficiary name when available\n  if (config.beneficiaryName && String(config.beneficiaryName).trim()) {\n    lines.push(`Todas a nombre de ${String(config.beneficiaryName).trim()}`);\n  }\n  lines.push('');\n  lines.push('Si ya canceló, omita el mensaje');\n\n  // If backend provided a custom message template, append it rendered\n  if (payload.message) {\n    lines.push('');\n    lines.push(renderTemplate(String(payload.message)));\n  }\n\n  if (payload.options?.length) {\n    lines.push('Responda con una de las siguientes opciones:');\n    payload.options.forEach((option) => {\n      lines.push(`${option.key}. ${option.label}`);\n    });\n  }\n\n  return {\n    content: lines.join('\\n'),\n    attachments: []\n  };\n};\n\nexport class ReminderProcessor {\n  private lastResendCheck: Date | null = null;\n\n  constructor(private readonly whatsapp: WhatsAppClient) {}\n\n  async runBatch(): Promise<void> {\n    // Primero procesar recordatorios pendientes normales\n    const reminders = await apiClient.fetchPendingReminders();\n\n    if (!reminders.length) {\n      logger.debug('No hay recordatorios pendientes por enviar.');\n    } else {\n      for (const reminder of reminders) {\n        await this.processReminder(reminder);\n      }\n    }\n\n    // Después de las 5 PM, reenviar recordatorios del día que no han sido conciliados\n    await this.checkAndResendUnpaidReminders();\n  }\n\n  private async processReminder(reminder: ReminderRecord): Promise<void> {\n    try {\n      await apiClient.markQueued(reminder);\n\n      await pRetry(() => this.sendReminder(reminder), {\n        retries: 3,\n        factor: 2,\n        onFailedAttempt: (error: FailedAttemptError) => {\n          logger.warn({\n            attempt: error.attemptNumber,\n            retriesLeft: error.retriesLeft,\n            reminderId: reminder.id,\n            cause: error.cause\n          }, 'Fallo al enviar recordatorio, reintentando');\n        }\n      });\n\n      await apiClient.markSent(reminder.id);\n      logger.info({ reminderId: reminder.id }, 'Recordatorio enviado correctamente');\n    } catch (error) {\n      logger.error({ err: error, reminderId: reminder.id }, 'No se pudo enviar el recordatorio');\n\n      // Intentar devolver el recordatorio a estado 'pending' para que pueda ser reintentado\n      try {\n        const attempts = typeof reminder.attempts === 'number' ? reminder.attempts : undefined;\n        await apiClient.revertToPending(reminder.id, attempts);\n        logger.info({ reminderId: reminder.id }, 'Recordatorio revertido a pending para reintento futuro');\n      } catch (err) {\n        logger.error({ err, reminderId: reminder.id }, 'Error revirtiendo recordatorio a pending');\n      }\n    }\n  }\n\n  private async sendReminder(reminder: ReminderRecord): Promise<void> {\n    // If the backend didn't include contract details in the reminder, fetch it so we can read the amount\n    if (!reminder.contract && reminder.contract_id) {\n      try {\n        const c = await apiClient.getContract(reminder.contract_id);\n        if (c) reminder.contract = c;\n      } catch (err: any) {\n        logger.warn({ err, reminderId: reminder.id, contractId: reminder.contract_id }, 'No se pudo obtener contrato para el recordatorio');\n        // proceed anyway; buildMessage will fallback to payload.amount or 0\n      }\n    }\n\n  const payload = reminder.payload ?? {};\n  const rawAmount = reminder.contract?.amount ?? payload.amount ?? '0';\n  logger.info({ reminderId: reminder.id, contractId: reminder.contract_id, rawAmount }, 'Resolved amount for reminder');\n\n  const messagePayload = buildMessage(reminder);\n    await this.whatsapp.sendReminder(reminder, messagePayload);\n  }\n\n  /**\n   * Verifica si es después de las 5 PM y reenvía recordatorios del día que no han sido conciliados\n   */\n  private async checkAndResendUnpaidReminders(): Promise<void> {\n    const now = new Date();\n    const hour = now.getHours();\n    \n    // Solo ejecutar después de las 5 PM (17:00)\n    if (hour < 17) {\n      return;\n    }\n\n    // Solo ejecutar una vez al día (evitar múltiples ejecuciones)\n    if (this.lastResendCheck) {\n      const lastCheckDate = this.lastResendCheck.toDateString();\n      const currentDate = now.toDateString();\n      if (lastCheckDate === currentDate) {\n        return; // Ya se ejecutó hoy\n      }\n    }\n\n    try {\n      logger.info('Verificando recordatorios del día sin conciliar para reenvío...');\n\n      // Obtener recordatorios enviados hoy que no tienen pagos conciliados\n      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);\n      const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);\n\n      const sentReminders = await apiClient.fetchSentRemindersWithoutPayment(\n        todayStart.toISOString(),\n        todayEnd.toISOString()\n      );\n\n      if (!sentReminders.length) {\n        logger.debug('No hay recordatorios del día sin conciliar.');\n        this.lastResendCheck = now;\n        return;\n      }\n\n      logger.info({ count: sentReminders.length }, 'Reenviando recordatorios sin conciliar del día');\n\n      for (const reminder of sentReminders) {\n        try {\n          // Modificar el mensaje para indicar que es un recordatorio adicional\n          const originalPayload = reminder.payload ?? {};\n          const resendPayload = {\n            ...originalPayload,\n            message: '⚠️ RECORDATORIO ADICIONAL ⚠️\\n\\nNo hemos recibido su comprobante de pago del día de hoy.\\n\\n' + (originalPayload.message || '')\n          };\n          \n          const reminderWithResendMessage = { ...reminder, payload: resendPayload };\n          const messagePayload = buildMessage(reminderWithResendMessage);\n          \n          await this.whatsapp.sendReminder(reminder, messagePayload);\n          logger.info({ reminderId: reminder.id }, 'Recordatorio reenviado exitosamente');\n          \n          // Pequeña pausa entre mensajes para no saturar\n          await new Promise(resolve => setTimeout(resolve, 2000));\n        } catch (error) {\n          logger.error({ err: error, reminderId: reminder.id }, 'Error reenviando recordatorio');\n        }\n      }\n\n      this.lastResendCheck = now;\n      logger.info('Proceso de reenvío completado');\n    } catch (error) {\n      logger.error({ err: error }, 'Error en verificación de recordatorios sin conciliar');\n    }\n  }\n}\n","import axios, { AxiosInstance } from 'axios';\nimport pRetry from 'p-retry';\nimport { config } from './config.js';\nimport { AcknowledgePayload, ReminderRecord } from './types.js';\nimport { logger } from './logger.js';\n\nclass ApiClient {\n  private readonly http: AxiosInstance;\n\n  constructor() {\n    this.http = axios.create({\n      baseURL: `${config.apiBaseUrl.replace(/\\/$/, '')}/`,\n      headers: {\n        Accept: 'application/json',\n        Authorization: `Bearer ${config.apiToken}`\n      },\n      timeout: 15000\n    });\n  }\n\n  async fetchPendingReminders(): Promise<ReminderRecord[]> {\n    const response = await this.http.get<ReminderRecord[]>('reminders/pending', {\n      params: {\n        look_ahead: config.lookAheadMinutes,\n        limit: config.maxBatch\n      }\n    });\n\n    return response.data;\n  }\n\n  async acknowledgeReminder(reminderId: number, payload: AcknowledgePayload): Promise<void> {\n    await this.http.post(`reminders/${reminderId}/acknowledge`, payload);\n  }\n\n  async markQueued(reminder: ReminderRecord): Promise<void> {\n    // Capear attempts para evitar valores inesperadamente grandes que puedan\n    // provocar errores en el backend si la columna es pequeña.\n    const nextAttempts = Math.min((reminder.attempts || 0) + 1, 100);\n    await this.http.patch(`reminders/${reminder.id}`, {\n      status: 'queued',\n      attempts: nextAttempts,\n      queued_at: new Date().toISOString()\n    });\n  }\n\n  /**\n   * Revert a reminder previously claimed (queued) back to pending so it can be retried later.\n   */\n  async revertToPending(reminderId: number, attempts?: number): Promise<void> {\n    const payload: any = {\n      status: 'pending',\n      queued_at: null,\n    };\n    if (typeof attempts === 'number') payload.attempts = attempts;\n    await this.http.patch(`reminders/${reminderId}`, payload);\n  }\n\n  async markSent(reminderId: number): Promise<void> {\n    await pRetry(async () => {\n      try {\n        await this.http.patch(`reminders/${reminderId}`, {\n          status: 'sent',\n          sent_at: new Date().toISOString()\n        });\n      } catch (err: any) {\n        // Log helpful details for debugging and rethrow to trigger retry\n        logger.warn({ reminderId, err: err?.response?.data ?? err?.message ?? err }, 'Error marcando recordatorio como enviado, reintentando');\n        throw err;\n      }\n    }, { retries: 2 });\n  }\n\n  async reportWhatsappQr(qr: string): Promise<void> {\n    await this.http.post('whatsapp/qr', { qr });\n  }\n\n  async markWhatsappReady(): Promise<void> {\n    await this.http.post('whatsapp/ready');\n  }\n\n  async markWhatsappDisconnected(reason?: string): Promise<void> {\n    const payload = reason && reason.trim().length > 0 ? { reason } : {};\n    await this.http.post('whatsapp/disconnected', payload);\n  }\n\n  async fetchBotMenu(): Promise<Array<{ keyword: string; reply_message: string; options?: any }>> {\n    const response = await this.http.get('whatsapp/menu');\n    return response.data;\n  }\n\n  // --- Admin / management helper endpoints (asunciones sobre la API) ---\n  async findCustomerByPhone(phone: string) {\n    const onlyDigits = (s: string) => String(s || '').replace(/[^0-9]/g, '');\n    const pd = onlyDigits(phone);\n    const last8 = pd.slice(-8);\n\n    // Query by last8 first to hit phones saved con o sin 506 o símbolos\n    const candidates: any[] = [];\n    const pushUnique = (arr: any[], item: any) => {\n      if (!item) return; const id = item.id ?? item.ID ?? JSON.stringify(item);\n      if (!arr.find(x => (x.id ?? x.ID) === id)) arr.push(item);\n    };\n\n    const tryFetch = async (term: string) => {\n      const res = await this.http.get('clients', { params: { search: term, per_page: 50 } });\n      const list = Array.isArray(res.data) ? res.data : (res.data && Array.isArray(res.data.data) ? res.data.data : []);\n      for (const it of list) pushUnique(candidates, it);\n    };\n\n    try { if (last8 && last8.length >= 4) await tryFetch(last8); } catch {}\n    try { await tryFetch(pd); } catch {}\n    try { await tryFetch(phone); } catch {}\n\n    // Prefer exact digits-only match, then endsWith last8, otherwise first\n    const exact = candidates.find(c => onlyDigits(c.phone || '') === pd);\n    if (exact) return exact;\n    const ends = candidates.find(c => onlyDigits(c.phone || '').endsWith(last8));\n    if (ends) return ends;\n    return candidates.length ? candidates[0] : null;\n  }\n\n  async upsertCustomer(payload: { phone: string; name?: string; active?: number }) {\n    // The backend requires 'name' and 'status' for creating clients. Ensure defaults.\n    const body: any = Object.assign({}, payload);\n    if (!body.name) body.name = String(body.phone || '');\n    if (!body.status) body.status = 'active';\n    const res = await this.http.post('clients', body);\n    return res.data;\n  }\n\n  async createSubscription(payload: any) {\n    const res = await this.http.post('subscriptions', payload);\n    return res.data;\n  }\n\n  async listSubscriptions(phone?: string) {\n    const res = await this.http.get('subscriptions', { params: phone ? { phone } : {} });\n    return res.data;\n  }\n\n  async listContracts(params?: any) {\n    const res = await this.http.get('contracts', { params: params || {} });\n    const body: any = res.data;\n    if (Array.isArray(body)) return body;\n    if (body && Array.isArray(body.data)) return body.data;\n    return [] as any[];\n  }\n\n  async getContract(id: number | string) {\n    const res = await this.http.get(`contracts/${id}`);\n    return res.data;\n  }\n\n  async listPaymentsUpcoming(phone?: string, days?: number) {\n    const res = await this.http.get('payments/upcoming', { params: { phone, days } });\n    return res.data;\n  }\n\n  async listTransactions(phone?: string, limit = 20) {\n    const res = await this.http.get('transactions', { params: { phone, limit } });\n    return res.data;\n  }\n\n  async deleteTransaction(id: number) {\n    const res = await this.http.delete(`transactions/${id}`);\n    return res.data;\n  }\n\n  async listReceiptsByDate(date: string) {\n    const res = await this.http.get('receipts', { params: { date } });\n    return res.data;\n  }\n\n  async createReceiptForClient(payload: any) {\n    // Try a few candidate endpoints to be tolerant to backend route differences.\n    const candidates = ['receipts/for-client', 'receipts', 'payments/receipts', 'receipts/create'];\n    let lastErr: any = null;\n    for (const ep of candidates) {\n      try {\n        const res = await this.http.post(ep, payload);\n        if (ep !== candidates[0]) {\n          logger.info({ ep, payload }, 'createReceiptForClient used fallback endpoint');\n        }\n        return res.data;\n      } catch (err: any) {\n        lastErr = err;\n        // If 404, try next candidate; otherwise rethrow to let caller handle unexpected errors\n        const status = err && err.response && err.response.status;\n        if (status === 404) {\n          logger.debug({ ep, status, body: err.response && err.response.data }, 'Endpoint no disponible, probando siguiente fallback');\n          continue;\n        }\n        // non-404: rethrow\n        throw err;\n      }\n    }\n    // If we get here, all candidates returned 404 or failed; throw helpful error including last response\n    const info: any = { message: 'No disponible endpoint para createReceiptForClient' };\n    if (lastErr && lastErr.response) {\n      info.status = lastErr.response.status;\n      info.data = lastErr.response.data;\n    }\n    logger.warn(info, 'createReceiptForClient fallo en todos los endpoints candidatos');\n    const e = new Error('createReceiptForClient failed: ' + JSON.stringify(info));\n    throw e;\n  }\n\n  async createPayment(payload: any) {\n    const res = await this.http.post('payments', payload);\n    return res.data;\n  }\n\n  async getSettings() {\n    const res = await this.http.get('settings');\n    return res.data || {};\n  }\n\n  async updatePayment(paymentId: number | string, payload: any) {\n    const res = await this.http.patch(`payments/${paymentId}`, payload);\n    return res.data;\n  }\n\n  async sendReceipt(receiptId: number) {\n    const res = await this.http.post(`receipts/${receiptId}/send`);\n    return res.data;\n  }\n\n  async deleteCustomer(id: number) {\n    const res = await this.http.delete(`clients/${id}`);\n    return res.data;\n  }\n\n  async deleteSubscriptionsByPhone(phone: string) {\n    const res = await this.http.delete('subscriptions', { params: { phone } });\n    return res.data;\n  }\n\n  async deleteContractsByPhone(phone: string) {\n    // Delete all contracts for a given phone\n    const client = await this.findCustomerByPhone(phone);\n    if (!client) throw new Error('Cliente no encontrado');\n    const contracts = await this.listContracts({ client_id: client.id });\n    for (const c of contracts) {\n      await this.http.delete(`contracts/${c.id}`);\n    }\n    return { deleted: contracts.length };\n  }\n\n  async listPayments(params?: any) {\n    const res = await this.http.get('payments', { params: params || {} });\n    const body: any = res.data;\n    if (Array.isArray(body)) return body;\n    if (body && Array.isArray(body.data)) return body.data;\n    return [] as any[];\n  }\n\n  async getPayment(id: number | string) {\n    const res = await this.http.get(`payments/${id}`);\n    return res.data;\n  }\n\n  async createConciliation(payload: any) {\n    const res = await this.http.post('conciliations', payload);\n    return res.data;\n  }\n\n  async storeReceiptFromBot(payload: {\n    payment_id?: number;\n    client_phone?: string;\n    file_base64?: string;\n    file_path?: string;\n    file_name: string;\n    mime_type: string;\n    received_at?: string;\n    metadata?: Record<string, any>;\n  }) {\n    const res = await this.http.post('payments/receipts/bot', payload);\n    return res.data;\n  }\n\n  async fetchSentRemindersWithoutPayment(startDate: string, endDate: string): Promise<ReminderRecord[]> {\n    const response = await this.http.get<ReminderRecord[]>('reminders/sent-without-payment', {\n      params: {\n        start_date: startDate,\n        end_date: endDate\n      }\n    });\n\n    return response.data;\n  }\n\n  /**\n   * Fetch data from the backend API (generic helper).\n   */\n  async fetchFromBackend(path: string): Promise<any> {\n    try {\n      const response = await this.http.get(path);\n      return response.data;\n    } catch (error: any) {\n      logger.debug({ error: error?.message, path }, 'fetchFromBackend error');\n      throw error;\n    }\n  }\n\n  private async requestToBackend(method: 'GET' | 'POST' | 'PATCH' | 'DELETE', path: string, data?: any): Promise<any> {\n    try {\n      const res = await this.http.request({ method, url: path, data });\n      return res.data;\n    } catch (error: any) {\n      logger.debug({ error: error?.message, method, path }, 'requestToBackend error');\n      throw error;\n    }\n  }\n\n  /**\n   * Get payment status for a phone number.\n   */\n  async getPaymentStatus(phone: string): Promise<any> {\n    return this.fetchFromBackend(`/payment-status/${phone}`);\n  }\n\n  /**\n   * Check if a contact is paused.\n   */\n  async checkPausedContact(whatsappNumber: string): Promise<boolean> {\n    try {\n      const res = await this.fetchFromBackend(`/paused-contacts/check/${whatsappNumber}`);\n      return res?.is_paused === true;\n    } catch (e) {\n      return false;\n    }\n  }\n\n  async pauseContact(payload: { client_id?: number | null; whatsapp_number: string; reason?: string }): Promise<any> {\n    return this.requestToBackend('POST', '/paused-contacts', payload);\n  }\n\n  async resumeContact(payload: { client_id: number; whatsapp_number: string }): Promise<any> {\n    const { client_id, whatsapp_number } = payload;\n    return this.requestToBackend('DELETE', `/paused-contacts/${client_id}/${whatsapp_number}`);\n  }\n\n  async resumeContactByNumber(payload: { whatsapp_number: string }): Promise<any> {\n    const { whatsapp_number } = payload;\n    return this.requestToBackend('DELETE', `/paused-contacts/by-number/${whatsapp_number}`);\n  }\n\n  async listPausedContacts(): Promise<any> {\n    return this.requestToBackend('GET', '/paused-contacts');\n  }\n}\n\nexport const apiClient = new ApiClient();\n\n","import pkg from 'whatsapp-web.js';\nimport qrcode from 'qrcode-terminal';\nimport QRCode from 'qrcode';\nimport { config } from './config.js';\nimport { logger } from './logger.js';\nimport { ReminderMessagePayload, ReminderRecord } from './types.js';\nimport { formatWhatsAppId } from './utils/phone.js';\nimport { apiClient } from './api-client.js';\nimport { exec as _exec } from 'node:child_process';\nimport { promisify } from 'node:util';\n\nconst { Client, LocalAuth, MessageMedia } = pkg;\n\nconst exec = promisify(_exec);\n\nfunction parseEnvBool(value: string | undefined, defaultValue: boolean): boolean {\n  if (value == null) return defaultValue;\n  const v = String(value).trim().toLowerCase();\n  if (['1', 'true', 'yes', 'y', 'on'].includes(v)) return true;\n  if (['0', 'false', 'no', 'n', 'off'].includes(v)) return false;\n  return defaultValue;\n}\n\nexport type IncomingMessageHandler = (message: pkg.Message) => Promise<void> | void;\n\nexport class WhatsAppClient {\n  private readonly client: pkg.Client;\n  private inboundHandler?: IncomingMessageHandler;\n  private listenersAttached = false;\n  private restartInProgress = false;\n  private isReady = false;\n  private authenticatedAt: number | null = null;\n  private authStuckTimer: NodeJS.Timeout | null = null;\n  private authStuckRestarted = false;\n  private lastRestartAt: number | null = null;\n  private restartCountWindow: Array<number> = [];\n  private readonly debugMessages: boolean;\n  private readonly enableMessagePolling: boolean;\n  private readonly markMessagesRead: boolean;\n  private readonly enableAutoRestartOnStuck: boolean;\n  private readonly stuckCheckIntervalMs: number;\n  private messagePollTimer: NodeJS.Timeout | null = null;\n  private messagePollNextAt: number | null = null;\n  private processedMessageIds = new Map<string, number>();\n  private messagePollConsecutiveFailures = 0;\n  private messagePollingDisabledLogged = false;\n  private wwebjsStubsApplied = false;\n\n  private async applyWwebjsSafetyStubs(): Promise<void> {\n    try {\n      const page: any = (this.client as any).pupPage;\n      if (page && typeof page.evaluate === 'function') {\n        await page.evaluate(() => {\n          try {\n            if (!(window as any).WWebJS) (window as any).WWebJS = {};\n            // algunos builds referencian markedUnread; asegurar que exista\n            (window as any).WWebJS.markedUnread = false;\n\n            // Evitar que whatsapp-web.js explote al intentar hacer sendSeen.\n            // En builds recientes hemos visto errores tipo: reading 'markedUnread'.\n            (window as any).WWebJS.sendSeen = async () => {\n              return;\n            };\n\n            // En algunos builds recientes, whatsapp-web.js asume módulos de Store que no existen\n            // (p.ej. Store.GroupMetadata.update), lo que rompe getChats()/fetchMessages.\n            // Creamos stubs mínimos para evitar TypeError: reading 'update'.\n            const Store: any = (window as any).Store;\n            if (Store) {\n              if (!Store.GroupMetadata) Store.GroupMetadata = {};\n              if (typeof Store.GroupMetadata.update !== 'function') {\n                Store.GroupMetadata.update = async () => {\n                  return;\n                };\n              }\n\n              if (!Store.NewsletterMetadataCollection) Store.NewsletterMetadataCollection = {};\n              if (typeof Store.NewsletterMetadataCollection.update !== 'function') {\n                Store.NewsletterMetadataCollection.update = async () => {\n                  return;\n                };\n              }\n            }\n          } catch {\n            // ignore\n          }\n        });\n      }\n    } catch (e) {\n      logger.debug({ e }, 'No se pudo aplicar sendSeen noop');\n    }\n  }\n\n  private async ensureWwebjsStubsApplied(): Promise<void> {\n    if (this.wwebjsStubsApplied) return;\n    try {\n      await this.applyWwebjsSafetyStubs();\n      this.wwebjsStubsApplied = true;\n    } catch {\n      // best-effort; no bloquear\n    }\n  }\n\n  private async listUnreadChatsLightweight(maxChats: number): Promise<Array<{ id: string; unreadCount: number }>> {\n    try {\n      const page: any = (this.client as any).pupPage;\n      if (!page || typeof page.evaluate !== 'function') return [];\n\n      const result = await page.evaluate((limit: number) => {\n        try {\n          const Store: any = (window as any).Store;\n          const arr: any[] = Store?.Chat?.getModelsArray?.() || [];\n          return arr\n            .map((c: any) => ({ id: c?.id?._serialized ? String(c.id._serialized) : null, unreadCount: Number(c?.unreadCount || 0) }))\n            .filter((x: any) => x && x.id && x.unreadCount > 0)\n            .sort((a: any, b: any) => b.unreadCount - a.unreadCount)\n            .slice(0, Math.max(1, Number(limit || 1)));\n        } catch {\n          return [];\n        }\n      }, maxChats);\n\n      if (!Array.isArray(result)) return [];\n      return result\n        .filter((x: any) => x && typeof x.id === 'string')\n        .map((x: any) => ({ id: String(x.id), unreadCount: Number(x.unreadCount || 0) }));\n    } catch (error) {\n      logger.debug({ err: error }, 'No se pudo listar chats no leídos (lightweight)');\n      return [];\n    }\n  }\n\n  private async markChatIdAsReadBestEffort(chatId: string): Promise<void> {\n    if (!this.markMessagesRead) return;\n    if (!chatId) return;\n    if (String(chatId).endsWith('@broadcast')) return;\n\n    try {\n      const page: any = (this.client as any).pupPage;\n      if (page && typeof page.evaluate === 'function') {\n        await page.evaluate(async (cid: string) => {\n          try {\n            const chat = await (window as any).WWebJS?.getChat?.(cid, { getAsModel: false });\n            const cmd = (window as any).Store?.Cmd;\n            if (chat && cmd && typeof cmd.markChatUnread === 'function') {\n              await cmd.markChatUnread(chat, false);\n            }\n          } catch {\n            // ignore\n          }\n        }, chatId);\n      }\n    } catch (error) {\n      logger.debug({ err: error, chatId }, 'No se pudo marcar chat como leído (markChatUnread=false)');\n    }\n  }\n\n  private async markChatAsSeenBestEffort(message: pkg.Message): Promise<void> {\n    if (!this.markMessagesRead) return;\n    try {\n      if ((message as any).fromMe) return;\n      if (String((message as any).from || '').endsWith('@broadcast')) return;\n\n      const chatId = String((message as any).from || '');\n      if (!chatId) return;\n\n      // Evitar sendSeen (en tu build tira markedUnread y enlentece). Usar markChatUnread(false).\n      await this.markChatIdAsReadBestEffort(chatId);\n    } catch (error: any) {\n      const msg = error?.message || String(error);\n      // No bloquear el bot por errores internos (markedUnread, etc.)\n      logger.debug({ err: error, msg }, 'No se pudo marcar chat como leído (ignored)');\n    }\n  }\n\n  private markProcessedMessage(id: string): void {\n    const now = Date.now();\n    this.processedMessageIds.set(id, now);\n\n    // limpieza simple para evitar crecimiento infinito\n    const TTL_MS = 24 * 60 * 60 * 1000;\n    if (this.processedMessageIds.size > 5000) {\n      for (const [key, ts] of this.processedMessageIds) {\n        if (now - ts > TTL_MS) this.processedMessageIds.delete(key);\n      }\n      // si aún es grande, recortar por orden de inserción\n      while (this.processedMessageIds.size > 5000) {\n        const oldestKey = this.processedMessageIds.keys().next().value as string | undefined;\n        if (!oldestKey) break;\n        this.processedMessageIds.delete(oldestKey);\n      }\n    }\n  }\n\n  private stopMessagePolling(): void {\n    if (this.messagePollTimer) {\n      clearInterval(this.messagePollTimer);\n      this.messagePollTimer = null;\n    }\n    this.messagePollNextAt = null;\n  }\n\n  private kickMessagePollingSoon(): void {\n    if (!this.enableMessagePolling) return;\n    if (!this.inboundHandler) return;\n    if (!this.isReady) return;\n\n    const now = Date.now();\n    const desiredAt = now + 250;\n    if (this.messagePollTimer && this.messagePollNextAt && this.messagePollNextAt <= desiredAt) {\n      return;\n    }\n    if (this.messagePollTimer) {\n      clearTimeout(this.messagePollTimer as any);\n      this.messagePollTimer = null;\n    }\n    this.messagePollNextAt = desiredAt;\n    this.messagePollTimer = setTimeout(() => {\n      this.messagePollTimer = null;\n      void this.runMessagePollingTick();\n    }, Math.max(0, desiredAt - now));\n  }\n\n  private async runMessagePollingTick(): Promise<void> {\n    if (!this.isReady) return;\n    if (!this.inboundHandler) return;\n\n  // Cuando estamos en polling fallback, el idleInterval define el peor caso de latencia.\n  // Prioridad:\n  // 1) BOT_MESSAGE_POLL_IDLE_MS (si existe)\n  // 2) default 3000ms\n  // Nota: BOT_MESSAGE_POLL_MS existe en algunos deploys legacy como 15000ms; no queremos que domine.\n  const idleIntervalMs = Number(process.env.BOT_MESSAGE_POLL_IDLE_MS || 3000);\n    const activeIntervalMs = Number(process.env.BOT_MESSAGE_POLL_ACTIVE_MS || 2000);\n    const maxChats = Number(process.env.BOT_MESSAGE_POLL_MAX_CHATS || 5);\n    const maxPerChat = Number(process.env.BOT_MESSAGE_POLL_MAX_PER_CHAT || 15);\n\n    let nextDelay = idleIntervalMs;\n\n    try {\n      const unreadChats = await this.listUnreadChatsLightweight(maxChats);\n      this.messagePollConsecutiveFailures = 0;\n\n      if (unreadChats.length > 0) {\n        nextDelay = activeIntervalMs;\n      }\n\n      for (const c of unreadChats) {\n        const unreadCount = Math.min(Number(c.unreadCount || 0), Math.max(1, maxPerChat));\n        if (unreadCount <= 0) continue;\n\n        let chat: any | null = null;\n        let messages: pkg.Message[] = [];\n        try {\n          chat = await (this.client as any).getChatById?.(c.id);\n          if (!chat) continue;\n          messages = await chat.fetchMessages({ limit: Math.max(8, Math.min(maxPerChat, unreadCount + 3)) });\n        } catch (error) {\n          logger.debug({ err: error, chatId: c.id }, 'No se pudo fetchMessages en polling');\n          continue;\n        }\n\n        for (const message of messages) {\n          const id = (message as any)?.id?._serialized;\n          if (!id) continue;\n          if ((message as any).fromMe) continue;\n          if (this.processedMessageIds.has(id)) continue;\n          if (String((message as any).from || '').endsWith('@broadcast')) continue;\n\n          this.markProcessedMessage(id);\n          logger.info(\n            { id, from: (message as any).from, chatId: c.id, unreadCount: chat?.unreadCount ?? unreadCount },\n            'Procesando mensaje vía polling (fallback)'\n          );\n\n          try {\n            await this.inboundHandler(message);\n          } catch (error) {\n            logger.error({ err: error }, 'Error manejando mensaje entrante (polling)');\n          }\n        }\n\n        await this.markChatIdAsReadBestEffort(c.id);\n      }\n    } catch (error) {\n      this.messagePollConsecutiveFailures += 1;\n      const failures = this.messagePollConsecutiveFailures;\n      logger.warn({ err: error, failures }, 'Polling de mensajes falló');\n      nextDelay = Math.max(5000, idleIntervalMs);\n\n      if (failures >= 3) {\n        logger.error({ failures }, 'Polling de mensajes falló repetidamente; deteniendo polling y reiniciando WhatsApp');\n        this.stopMessagePolling();\n        void this.safeRestart('message_polling_failed');\n        return;\n      }\n    }\n\n    // re-programar el siguiente tick (sin solapar)\n    const now = Date.now();\n    const delay = Math.max(250, Number.isFinite(nextDelay) ? nextDelay : idleIntervalMs);\n    this.messagePollNextAt = now + delay;\n    this.messagePollTimer = setTimeout(() => {\n      this.messagePollTimer = null;\n      void this.runMessagePollingTick();\n    }, delay);\n  }\n\n  private startMessagePolling(): void {\n    if (!this.enableMessagePolling) {\n      if (!this.messagePollingDisabledLogged) {\n        this.messagePollingDisabledLogged = true;\n        logger.info('Polling de mensajes (fallback) deshabilitado; setea BOT_ENABLE_MESSAGE_POLLING=true para activarlo.');\n      }\n      return;\n    }\n    // Sólo sirve si hay handler registrado\n    if (!this.inboundHandler) return;\n    if (this.messagePollTimer) return;\n\n  // Mantener el default consistente con runMessagePollingTick.\n  const idleIntervalMs = Number(process.env.BOT_MESSAGE_POLL_IDLE_MS || 3000);\n    const activeIntervalMs = Number(process.env.BOT_MESSAGE_POLL_ACTIVE_MS || 2000);\n    logger.warn({ idleIntervalMs, activeIntervalMs }, 'Iniciando polling de mensajes (fallback)');\n\n    // primera ejecución inmediata\n    this.messagePollNextAt = Date.now();\n    this.messagePollTimer = setTimeout(() => {\n      this.messagePollTimer = null;\n      void this.runMessagePollingTick();\n    }, 0);\n  }\n\n  constructor() {\n    const headless = parseEnvBool(process.env.BOT_HEADLESS, true);\n    const userAgent = (process.env.BOT_USER_AGENT ||\n      'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36'\n    ).trim();\n\n    const wwebVersion = (process.env.BOT_WWEB_VERSION || '').trim() || undefined;\n    const wwebCacheType = (process.env.BOT_WWEB_CACHE_TYPE || '').trim() || undefined; // local|remote|none\n    const wwebCacheStrict = parseEnvBool(process.env.BOT_WWEB_CACHE_STRICT, Boolean(wwebVersion));\n    const wwebCachePath = (process.env.BOT_WWEB_CACHE_PATH || '').trim() || undefined;\n    const wwebRemotePath =\n      (process.env.BOT_WWEB_CACHE_REMOTE_PATH || '').trim() ||\n      'https://cdn.jsdelivr.net/gh/wppconnect-team/wa-version@main/html/{version}.html';\n\n    const disableWwebjsPatches = parseEnvBool(process.env.BOT_DISABLE_WWEBJS_PATCHES, false);\n    this.debugMessages = parseEnvBool(process.env.BOT_DEBUG_MESSAGES, false);\n    this.enableMessagePolling = parseEnvBool(process.env.BOT_ENABLE_MESSAGE_POLLING, false);\n    this.markMessagesRead = parseEnvBool(process.env.BOT_MARK_MESSAGES_READ, true);\n    // Auto-restart can cause Puppeteer session locks (\"browser already running\") if Chrome doesn't exit cleanly.\n    // Keep it OFF by default; can be enabled when the environment is stable.\n    this.enableAutoRestartOnStuck = parseEnvBool(process.env.BOT_AUTO_RESTART_ON_STUCK, false);\n    this.stuckCheckIntervalMs = Number(process.env.BOT_STUCK_CHECK_INTERVAL_MS || 120000); // 2 min\n\n    logger.info(\n      {\n        headless,\n        hasCustomUserAgent: Boolean(process.env.BOT_USER_AGENT),\n        wwebVersion: wwebVersion ?? null,\n        wwebCacheType: wwebCacheType ?? null,\n        wwebCacheStrict,\n        disableWwebjsPatches,\n        debugMessages: this.debugMessages,\n        enableMessagePolling: this.enableMessagePolling,\n        markMessagesRead: this.markMessagesRead\n      },\n      'Inicializando WhatsApp (puppeteer)'\n    );\n\n    this.client = new Client({\n      authStrategy: new LocalAuth({ dataPath: config.sessionPath }),\n      ...(wwebVersion\n        ? {\n            webVersion: wwebVersion,\n            webVersionCache:\n              wwebCacheType === 'none'\n                ? { type: 'none' as const }\n                : wwebCacheType === 'local'\n                  ? { type: 'local' as const, path: wwebCachePath, strict: wwebCacheStrict }\n                  : {\n                      // default al usar BOT_WWEB_VERSION: remote cache\n                      type: 'remote' as const,\n                      remotePath: wwebRemotePath,\n                      strict: wwebCacheStrict\n                    }\n          }\n        : {}),\n      ...(disableWwebjsPatches\n        ? {}\n        : {\n            evalOnNewDoc: () => {\n              try {\n                if (!(window as any).WWebJS) (window as any).WWebJS = {};\n                (window as any).WWebJS.markedUnread = false;\n              } catch (e) {\n                // ignore\n              }\n            }\n          }),\n      puppeteer: {\n        headless,\n        // Allow overriding Chromium/Chrome executable via env var BOT_CHROMIUM_PATH\n        // If not provided, puppeteer will use the bundled or system browser.\n        executablePath: process.env.BOT_CHROMIUM_PATH || undefined,\n        args: [\n          '--no-sandbox',\n          '--disable-setuid-sandbox',\n          '--disable-dev-shm-usage',\n          `--user-agent=${userAgent}`\n        ]\n      }\n    });\n\n    // Stubs de compatibilidad (no deberían deshabilitar sendSeen).\n    // Se aplican luego en `ready`/ready-inferido.\n    \n    // Wrap original sendMessage to catch page evaluation errors (markedUnread) that\n    // ocurren dentro de la página y evitar que el bot falle completamente.\n    const originalSendMessage = (this.client as any).sendMessage?.bind(this.client);\n    if (originalSendMessage) {\n      (this.client as any).sendMessage = async (...args: any[]) => {\n        await this.ensureWwebjsStubsApplied();\n        const patchedArgs = [...args];\n        // whatsapp-web.js suele hacer sendSeen() por defecto al enviar; en algunos builds eso truena con markedUnread.\n        // Forzamos sendSeen:false para evitar el bug y mejorar performance.\n        if (patchedArgs.length >= 2) {\n          const opts = patchedArgs[2];\n          if (!opts || typeof opts !== 'object') patchedArgs[2] = { sendSeen: false };\n          else patchedArgs[2] = { ...(opts as any), sendSeen: false };\n        }\n        try {\n          return await originalSendMessage(...patchedArgs);\n        } catch (err: any) {\n          const msg = err?.message || String(err);\n          if (msg.includes('markedUnread') || msg.includes('marked unread')) {\n            // En algunos entornos este error ocurre *después* de que WhatsApp envía el mensaje.\n            // No queremos que el bot se caiga o quede en loop reintentando; registramos y continuamos.\n            logger.warn({ err }, 'Interceptado markedUnread error en sendMessage — ignorando para mantener el bot operativo');\n\n            // Aplicar stubs y reintentar una vez. Si sigue fallando, no botar el proceso.\n            await this.applyWwebjsSafetyStubs();\n            try {\n              return await originalSendMessage(...patchedArgs);\n            } catch (err2: any) {\n              logger.error({ err: err2 }, 'sendMessage sigue fallando tras stubs; se ignora para no tumbar el bot');\n              return;\n            }\n          }\n          throw err;\n        }\n      };\n    }\n\n    if (!disableWwebjsPatches) {\n      // Intentamos inyectar un script lo antes posible en nuevas páginas para evitar\n      // que WhatsApp Web ejecute código que provoque `markedUnread`/`sendSeen` errors.\n      // Esto escucha nuevos targets del browser y aplica `evaluateOnNewDocument`.\n      (async () => {\n        try {\n          const attach = async () => {\n            const browser: any = (this.client as any).browser;\n            if (!browser) return false;\n\n            // Interceptar creación de nuevas páginas\n            try {\n              browser.on && browser.on('targetcreated', async (target: any) => {\n                try {\n                  if (typeof target.type === 'function' && target.type() === 'page') {\n                    const page = await target.page();\n                    if (page && typeof page.evaluateOnNewDocument === 'function') {\n                      await page.evaluateOnNewDocument(() => {\n                        try {\n                          if (!(window as any).WWebJS) (window as any).WWebJS = {};\n                          (window as any).WWebJS.sendSeen = async () => {\n                            return;\n                          };\n                          (window as any).WWebJS.markedUnread = false;\n                        } catch (e) {\n                          // ignore\n                        }\n                      });\n                    } else if (page && typeof page.addInitScript === 'function') {\n                      // fallback para algunas versiones de puppeteer\n                      await page.addInitScript(() => {\n                        try {\n                          if (!(window as any).WWebJS) (window as any).WWebJS = {};\n                          (window as any).WWebJS.sendSeen = async () => {\n                            return;\n                          };\n                          (window as any).WWebJS.markedUnread = false;\n                        } catch (e) {}\n                      });\n                    }\n                  }\n                } catch (e) {\n                  // ignore per-target failures\n                }\n              });\n            } catch (e) {\n              // ignore\n            }\n\n            // Aplicar a páginas ya abiertas\n            try {\n              const pages = await browser.pages();\n              for (const p of pages) {\n                try {\n                  if (p && typeof p.evaluateOnNewDocument === 'function') {\n                    await p.evaluateOnNewDocument(() => {\n                      try {\n                        if (!(window as any).WWebJS) (window as any).WWebJS = {};\n                        (window as any).WWebJS.sendSeen = async () => {\n                          return;\n                        };\n                        (window as any).WWebJS.markedUnread = false;\n                      } catch (e) {}\n                    });\n                  } else if (p && typeof p.addInitScript === 'function') {\n                    await p.addInitScript(() => {\n                      try {\n                        if (!(window as any).WWebJS) (window as any).WWebJS = {};\n                        (window as any).WWebJS.sendSeen = async () => {\n                          return;\n                        };\n                        (window as any).WWebJS.markedUnread = false;\n                      } catch (e) {}\n                    });\n                  }\n                } catch (e) {\n                  // ignore per-page failures\n                }\n              }\n            } catch (e) {\n              // ignore\n            }\n\n            return true;\n          };\n\n          // Small polling to wait until puppeteer browser becomes available\n          for (let i = 0; i < 20; i++) {\n            const ok = await attach();\n            if (ok) break;\n            await new Promise((r) => setTimeout(r, 250));\n          }\n        } catch (e) {\n          logger.debug({ e }, 'No se pudo instalar inyección evaluateOnNewDocument');\n        }\n      })();\n    }\n  }\n\n  private async safeRestart(triggerReason: string): Promise<void> {\n    const now = Date.now();\n    const WINDOW_MS = 10 * 60 * 1000;\n    const MAX_RESTARTS_IN_WINDOW = 3;\n\n    // limpiar ventana\n    this.restartCountWindow = this.restartCountWindow.filter((t) => now - t < WINDOW_MS);\n    if (this.restartCountWindow.length >= MAX_RESTARTS_IN_WINDOW) {\n      logger.error(\n        { triggerReason, restartsInWindow: this.restartCountWindow.length },\n        'Demasiados reinicios en ventana; no se reiniciará automáticamente para evitar loop'\n      );\n      return;\n    }\n\n    if (this.restartInProgress) {\n      logger.warn({ triggerReason }, 'Reinicio ya en progreso; omitiendo');\n      return;\n    }\n\n    const last = this.lastRestartAt;\n    const COOLDOWN_MS = 15000;\n    if (last && now - last < COOLDOWN_MS) {\n      logger.warn({ triggerReason, cooldownMs: COOLDOWN_MS }, 'Reinicio en cooldown; omitiendo');\n      return;\n    }\n\n    this.restartInProgress = true;\n    this.lastRestartAt = now;\n    this.restartCountWindow.push(now);\n\n    // Backoff pequeño para evitar carreras con eventos internos.\n    await new Promise((r) => setTimeout(r, 5000));\n\n    try {\n      logger.warn({ triggerReason }, 'Reiniciando cliente WhatsApp (destroy + initialize)');\n\n      try {\n        await this.client.destroy();\n      } catch (error) {\n        logger.warn({ err: error }, 'No se pudo destruir el cliente antes de reiniciar');\n      }\n\n      // Reset de flags locales\n      this.isReady = false;\n      this.stopMessagePolling();\n      this.authenticatedAt = null;\n\n      await this.client.initialize();\n      logger.info({ triggerReason }, 'Reinicio de WhatsApp iniciado');\n    } catch (error) {\n      logger.error({ err: error, triggerReason }, 'No se pudo reiniciar el cliente de WhatsApp');\n    } finally {\n      this.restartInProgress = false;\n    }\n  }\n\n  async initialize(): Promise<void> {\n    if (this.listenersAttached) {\n      logger.warn('WhatsAppClient.initialize() llamado más de una vez; evitando duplicar listeners.');\n    } else {\n      this.listenersAttached = true;\n\n    this.client.on('qr', (qr: string) => {\n      logger.info('Escanee el código QR para iniciar sesión.');\n      this.isReady = false;\n      this.stopMessagePolling();\n      this.authenticatedAt = null;\n      this.authStuckRestarted = false;\n      if (this.authStuckTimer) {\n        clearTimeout(this.authStuckTimer);\n        this.authStuckTimer = null;\n      }\n      qrcode.generate(qr, { small: true });\n\n  void QRCode.toDataURL(qr)\n        .then(async (dataUrl: string) => {\n          try {\n            await apiClient.reportWhatsappQr(dataUrl);\n          } catch (error) {\n            logger.error({ err: error }, 'No se pudo enviar el QR al backend');\n          }\n        })\n        .catch((error: unknown) => {\n          logger.error({ err: error }, 'No se pudo generar el QR en formato de imagen');\n        });\n    });\n\n    this.client.on('authenticated', () => {\n      if (!this.authenticatedAt) this.authenticatedAt = Date.now();\n      logger.info({ authenticatedAt: this.authenticatedAt }, 'WhatsApp autenticado (session establecida).');\n\n      // Loguear identidad del cliente cuando esté disponible (útil para confirmar a qué número está conectado)\n      try {\n        const info: any = (this.client as any).info;\n        const wid = info?.wid?._serialized || info?.wid?.user || null;\n        const pushname = info?.pushname || null;\n        if (wid || pushname) {\n          logger.info({ wid, pushname }, 'Identidad WhatsApp (info)');\n        }\n      } catch {\n        // ignore\n      }\n\n      // Si quedamos autenticados pero nunca llegamos a `ready`, normalmente es un atasco interno.\n      // Hacemos polling corto y un reinicio controlado (máx 1 vez por ciclo QR/auth) para recuperar.\n      if (this.authStuckTimer) clearTimeout(this.authStuckTimer);\n      this.authStuckTimer = setTimeout(() => {\n        void (async () => {\n          if (this.isReady) return;\n\n          let state: string | null = null;\n          try {\n            // whatsapp-web.js expone getState()\n            state = await (this.client as any).getState?.();\n          } catch (error) {\n            logger.debug({ err: error }, 'No se pudo obtener getState()');\n          }\n\n          logger.warn(\n            {\n              state,\n              authenticatedSecondsAgo: this.authenticatedAt ? Math.round((Date.now() - this.authenticatedAt) / 1000) : null,\n              alreadyRestarted: this.authStuckRestarted\n            },\n            'WhatsApp autenticado pero aún no está listo (posible atasco)'\n          );\n\n          // Workaround: a veces WhatsApp queda en CONNECTED pero whatsapp-web.js no emite `ready`.\n          // Si podemos hacer una llamada real (getContacts) asumimos que está usable y marcamos listo.\n          if (state === 'CONNECTED') {\n            try {\n              const contacts = await Promise.race([\n                this.client.getContacts(),\n                new Promise<never>((_, reject) => setTimeout(() => reject(new Error('getContacts timeout')), 10000))\n              ]);\n\n              logger.info(\n                { contactsCount: Array.isArray(contacts) ? contacts.length : null },\n                'Cliente de WhatsApp usable sin evento ready (ready inferido)'\n              );\n\n              // Aun sin evento `ready`, aplicar stubs de compatibilidad para evitar crashes internos.\n              await this.applyWwebjsSafetyStubs();\n\n              this.isReady = true;\n              this.authenticatedAt = null;\n              this.authStuckRestarted = false;\n              if (this.authStuckTimer) {\n                clearTimeout(this.authStuckTimer);\n                this.authStuckTimer = null;\n              }\n\n              void apiClient.markWhatsappReady().catch((error: unknown) => {\n                logger.error({ err: error }, 'No se pudo notificar al backend que WhatsApp está listo (inferido)');\n              });\n\n              // Si los eventos de whatsapp-web.js no están fluyendo, el polling permite operar igual.\n              this.startMessagePolling();\n\n              return;\n            } catch (error) {\n              logger.warn({ err: error }, 'Estado CONNECTED pero no se pudo confirmar usabilidad (getContacts)');\n            }\n          }\n\n          if (!this.authStuckRestarted) {\n            if (!this.enableAutoRestartOnStuck) {\n              logger.warn(\n                {\n                  state,\n                  authenticatedSecondsAgo: this.authenticatedAt\n                    ? Math.round((Date.now() - this.authenticatedAt) / 1000)\n                    : null\n                },\n                'Auto-restart por stuck deshabilitado; se evita reinicio para no bloquear la sesión de Chrome'\n              );\n              return;\n            }\n\n            this.authStuckRestarted = true;\n            await this.safeRestart('stuck_after_authenticated');\n          }\n        })();\n      }, 30000);\n    });\n\n    this.client.on('loading_screen', (percent: number, message: string) => {\n      logger.debug({ percent, message }, 'WhatsApp loading_screen');\n    });\n\n    this.client.on('change_state', (state: string) => {\n      logger.info({ state }, 'WhatsApp change_state');\n    });\n\n    this.client.on('ready', () => {\n      logger.info('Cliente de WhatsApp listo.');\n      this.isReady = true;\n      this.authenticatedAt = null;\n      this.authStuckRestarted = false;\n      if (this.authStuckTimer) {\n        clearTimeout(this.authStuckTimer);\n        this.authStuckTimer = null;\n      }\n\n      // Aplicar stubs de compatibilidad para evitar crashes internos\n      void this.applyWwebjsSafetyStubs();\n\n      this.startMessagePolling();\n\n      void apiClient.markWhatsappReady().catch((error: unknown) => {\n        logger.error({ err: error }, 'No se pudo notificar al backend que WhatsApp está listo');\n      });\n    });\n\n    this.client.on('auth_failure', (message: string) => {\n      logger.error({ message }, 'Fallo de autenticación en WhatsApp');\n\n      void apiClient.markWhatsappDisconnected(message).catch((error: unknown) => {\n        logger.error({ err: error }, 'No se pudo notificar la desconexión por fallo de autenticación');\n      });\n    });\n\n    this.client.on('disconnected', (reason: string) => {\n      logger.warn({ reason }, 'Cliente de WhatsApp desconectado');\n      this.isReady = false;\n      this.stopMessagePolling();\n\n      void apiClient.markWhatsappDisconnected(reason).catch((error: unknown) => {\n        logger.error({ err: error }, 'No se pudo notificar la desconexión de WhatsApp');\n      });\n\n      if (this.restartInProgress) {\n        logger.warn({ reason }, 'Reinicio ya en progreso; omitiendo reinicio adicional');\n        return;\n      }\n      void this.safeRestart(reason);\n    });\n\n    }\n\n    if (this.debugMessages) {\n      this.client.on('message_create', (message: pkg.Message) => {\n        try {\n          const body = String((message as any).body ?? '');\n          const bodyPreview = body.length > 200 ? body.slice(0, 200) + '…' : body;\n          logger.info(\n            {\n              id: (message as any).id?._serialized,\n              from: (message as any).from,\n              to: (message as any).to,\n              fromMe: Boolean((message as any).fromMe),\n              hasMedia: Boolean((message as any).hasMedia),\n              type: (message as any).type,\n              bodyPreview\n            },\n            'WhatsApp message_create (debug)'\n          );\n        } catch (e) {\n          logger.debug({ e }, 'No se pudo loguear message_create');\n        }\n      });\n    }\n\n    this.client.on('message', async (message: pkg.Message) => {\n      try {\n        const id = (message as any)?.id?._serialized;\n        if (id) this.markProcessedMessage(id);\n        if (this.debugMessages) {\n          const body = String((message as any).body ?? '');\n          const bodyPreview = body.length > 200 ? body.slice(0, 200) + '…' : body;\n          logger.info(\n            {\n              id: (message as any).id?._serialized,\n              from: (message as any).from,\n              to: (message as any).to,\n              fromMe: Boolean((message as any).fromMe),\n              hasMedia: Boolean((message as any).hasMedia),\n              type: (message as any).type,\n              bodyPreview\n            },\n            'WhatsApp message (debug)'\n          );\n        }\n        if (this.inboundHandler) {\n          await this.inboundHandler(message);\n        }\n\n        await this.markChatAsSeenBestEffort(message);\n\n        // Si la sesión está \"media rota\" y dependemos de polling, acelerar el siguiente tick.\n        this.kickMessagePollingSoon();\n      } catch (error) {\n        logger.error({ err: error }, 'Error manejando mensaje entrante');\n      }\n    });\n\n    try {\n      await this.client.initialize();\n    } catch (error) {\n      // log the full error stack to help debugging puppeteer/protocol issues\n      logger.fatal({ err: error }, 'Error inicializando cliente de WhatsApp');\n      throw error;\n    }\n  }\n\n  registerInboundHandler(handler: IncomingMessageHandler): void {\n    this.inboundHandler = handler;\n\n    // Si ya estamos listos, arrancar polling inmediatamente\n    if (this.isReady) {\n      this.startMessagePolling();\n    }\n  }\n\n  async sendReminder(reminder: ReminderRecord, payload: ReminderMessagePayload): Promise<void> {\n    if (!reminder.client?.phone) {\n      throw new Error(`El cliente ${reminder.client?.name ?? reminder.client_id} no tiene teléfono configurado.`);\n    }\n\n    const chatId = formatWhatsAppId(reminder.client.phone);\n    await this.client.sendMessage(chatId, payload.content);\n\n    if (payload.attachments?.length) {\n      for (const attachment of payload.attachments) {\n        const base64Data = typeof attachment.data === 'string'\n          ? attachment.data.replace(/^data:[^,]+,/, '')\n          : attachment.data.toString('base64');\n\n        const media = new MessageMedia(attachment.mimeType, base64Data, attachment.filename);\n        await this.client.sendMessage(chatId, media);\n      }\n    }\n  }\n\n  // Enviar texto arbitrario a un chat (útil para admin queue u otros usos)\n  async sendText(chatId: string, text: string): Promise<void> {\n    await this.client.sendMessage(chatId, text);\n  }\n\n  // Enviar media (base64) a un chat\n  async sendMedia(chatId: string, base64Data: string, mimeType: string, filename?: string): Promise<void> {\n    const media = new MessageMedia(mimeType, base64Data, filename);\n    await this.client.sendMessage(chatId, media);\n  }\n\n  async getState(): Promise<{ state: string | null; info: any }> {\n    try {\n      const state = await this.client.getState();\n      const info = (this.client as any).info ?? null;\n      let webVersion: string | null = null;\n      try {\n        webVersion = (await (this.client as any).getWWebVersion?.()) ?? null;\n      } catch {\n        // ignore\n      }\n      return { state: state ?? null, info: { ...info, webVersion } };\n    } catch (error) {\n      logger.error({ err: error }, 'No se pudo obtener el estado del cliente de WhatsApp');\n      return { state: null, info: null };\n    }\n  }\n\n  async debugGetChatsSummary(): Promise<{\n    ok: boolean;\n    totalChats?: number;\n    unreadChats?: number;\n    sample?: Array<{ id: string; unreadCount: number; isGroup: boolean }>;\n    error?: string;\n  }> {\n    try {\n      const chats = await this.client.getChats();\n      const unread = chats.filter((c: any) => (c?.unreadCount || 0) > 0);\n\n      const sample = (unread as any[]).slice(0, 5).map((c: any) => ({\n        id: c?.id?._serialized ?? String(c?.id ?? ''),\n        unreadCount: Number(c?.unreadCount || 0),\n        isGroup: Boolean(c?.isGroup)\n      }));\n\n      return {\n        ok: true,\n        totalChats: chats.length,\n        unreadChats: unread.length,\n        sample\n      };\n    } catch (error: any) {\n      return {\n        ok: false,\n        error: error?.message ? String(error.message) : String(error)\n      };\n    }\n  }\n\n  /**\n   * Limpia chats (del lado del bot) para números que NO están permitidos.\n   *\n   * Importante:\n   * - WhatsApp Web no siempre permite “borrar chat” desde librerías. Lo más estable es:\n   *   - limpiar mensajes (clearMessages) si está disponible\n   *   - archivar el chat\n   * - Esta función está diseñada para ser llamada desde el menú admin.\n   */\n  async cleanupChats(options: {\n    /** Si true, no ejecuta acciones destructivas; solo reporta qué haría */\n    dryRun?: boolean;\n    /** Incluir chats con mensajes no leídos (default: false) */\n    includeUnread?: boolean;\n    /** Incluir grupos (default: false) */\n    includeGroups?: boolean;\n    /** Máximo de chats a procesar (default: 200) */\n    limit?: number;\n    /** Función que retorna true si el número es permitido (cliente/admin/whitelist/etc) */\n    isAllowedNumber: (whatsappNumber: string) => Promise<boolean>;\n  }): Promise<{\n    ok: boolean;\n    scanned: number;\n    candidates: number;\n    acted: number;\n    skippedUnread: number;\n    skippedGroup: number;\n    errors: number;\n    sample: Array<{ chatId: string; phone: string; action: 'skip' | 'clear' | 'archive' | 'delete' | 'none'; reason?: string }>;\n  }> {\n    const dryRun = options.dryRun !== false; // default true\n    const includeUnread = options.includeUnread === true;\n    const includeGroups = options.includeGroups === true;\n    const limit = Number(options.limit || 200);\n\n    const result = {\n      ok: true,\n      scanned: 0,\n      candidates: 0,\n      acted: 0,\n      skippedUnread: 0,\n      skippedGroup: 0,\n      errors: 0,\n      sample: [] as Array<{ chatId: string; phone: string; action: 'skip' | 'clear' | 'archive' | 'delete' | 'none'; reason?: string }>\n    };\n\n    try {\n      const chats: any[] = await this.client.getChats();\n      const slice = chats.slice(0, Math.max(0, limit));\n      for (const c of slice) {\n        result.scanned++;\n\n        const chatId = c?.id?._serialized ?? String(c?.id ?? '');\n        const isGroup = Boolean(c?.isGroup);\n        const unreadCount = Number(c?.unreadCount || 0);\n\n        if (isGroup && !includeGroups) {\n          result.skippedGroup++;\n          if (result.sample.length < 20) result.sample.push({ chatId, phone: '', action: 'skip', reason: 'group' });\n          continue;\n        }\n\n        if (unreadCount > 0 && !includeUnread) {\n          result.skippedUnread++;\n          if (result.sample.length < 20) result.sample.push({ chatId, phone: '', action: 'skip', reason: 'unread' });\n          continue;\n        }\n\n        const phone = String(chatId).replace(/@c\\.us$/, '').replace(/[^0-9]/g, '');\n        if (!phone || phone.length < 8) {\n          if (result.sample.length < 20) result.sample.push({ chatId, phone: phone || '', action: 'skip', reason: 'invalid_phone' });\n          continue;\n        }\n\n        let allowed = false;\n        try {\n          allowed = await options.isAllowedNumber(phone);\n        } catch {\n          // Si el check falla, no destruimos nada.\n          allowed = true;\n        }\n\n        if (allowed) {\n          if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'none', reason: 'allowed' });\n          continue;\n        }\n\n        // Candidato a limpiar\n        result.candidates++;\n        if (dryRun) {\n          if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'none', reason: 'dry_run' });\n          continue;\n        }\n\n  // Acciones:\n  // 1) intentar borrar el chat (delete) si está disponible\n  //    - primero vía Client.deleteChat(chatId) si existe (más directo)\n  //    - luego vía Chat.delete() si existe\n  // 2) fallback: clearMessages (NO archivar automáticamente)\n        try {\n          const chat: any = await this.client.getChatById(chatId);\n\n          let didSomething = false;\n          let deleteAttempted = false;\n\n          // Borrar chat (lo más parecido a “eliminar chat” desde WhatsApp Web)\n          // En whatsapp-web.js 1.34.x existe Chat.delete(): Promise<boolean>\n          // 1a) intentar con client.deleteChat(chatId) si está disponible\n          try {\n            const clientAny: any = this.client as any;\n            if (clientAny && typeof clientAny.deleteChat === 'function') {\n              deleteAttempted = true;\n              const deleted = await clientAny.deleteChat(chatId);\n              didSomething = Boolean(deleted) || didSomething;\n              if (Boolean(deleted)) {\n                result.acted++;\n                if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'delete' });\n              } else {\n                if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'none', reason: 'client_deleteChat_returned_false' });\n              }\n            }\n          } catch (e: any) {\n            deleteAttempted = true;\n            if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'none', reason: `client_deleteChat_error:${String(e?.message || e)}`.slice(0, 120) });\n          }\n\n          // 1b) fallback a chat.delete() (si existe)\n          if (!didSomething && chat && typeof chat.delete === 'function') {\n            deleteAttempted = true;\n            const deleted = await chat.delete();\n            didSomething = Boolean(deleted) || didSomething;\n            if (Boolean(deleted)) {\n              result.acted++;\n              if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'delete' });\n            } else {\n              if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'none', reason: 'chat_delete_returned_false' });\n            }\n          }\n\n          // Si intentamos delete y devolvió false, es común que sea por restricciones de WhatsApp Web.\n          // En ese caso seguimos con fallback (clear/archive) para que al menos no moleste.\n\n          // Si se borró, no tiene sentido intentar clear/archive (y además puede fallar)\n          if (didSomething) {\n            // best-effort: refrescar chats para que el estado se sincronice lo antes posible\n            try {\n              if ((this.client as any) && typeof (this.client as any).getChats === 'function') {\n                await (this.client as any).getChats();\n              }\n            } catch {\n              // ignore\n            }\n            continue;\n          }\n\n          if (chat && typeof chat.clearMessages === 'function') {\n            const cleared = await chat.clearMessages();\n            didSomething = Boolean(cleared) || didSomething;\n            if (Boolean(cleared)) {\n              result.acted++;\n              if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'clear' });\n            } else {\n              if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'none', reason: 'clear_returned_false' });\n            }\n          }\n\n          // Nota: se eliminó el archivado automático para no ocultar chats de contactos no-clientes.\n          // Si se desea archivar, se hará manualmente desde WhatsApp o se puede reintroducir como opción.\n\n          if (!didSomething) {\n            if (result.sample.length < 20) {\n              result.sample.push({\n                chatId,\n                phone,\n                action: 'none',\n                reason: deleteAttempted ? 'delete_not_supported_or_failed_no_fallback' : 'no_supported_actions'\n              });\n            }\n          }\n        } catch (e: any) {\n          result.errors++;\n          logger.warn({ chatId, phone, err: e?.message || e }, 'cleanupChats: error procesando chat');\n          if (result.sample.length < 20) result.sample.push({ chatId, phone, action: 'skip', reason: 'error' });\n        }\n      }\n\n      return result;\n    } catch (e: any) {\n      logger.error({ err: e }, 'cleanupChats: fallo general');\n      return { ...result, ok: false, errors: result.errors + 1 };\n    }\n  }\n\n  async shutdown(): Promise<void> {\n    this.stopMessagePolling();\n    try {\n      await this.client.destroy();\n      return;\n    } catch (err) {\n      logger.warn({ err }, 'WhatsAppClient.destroy falló; intentando cleanup alternativo');\n    }\n\n    // Fallback: intentar cerrar el browser de puppeteer si está disponible\n    try {\n      const browser: any = (this.client as any).pupBrowser;\n      if (browser && typeof browser.close === 'function') {\n        await browser.close();\n        return;\n      }\n    } catch (err) {\n      logger.warn({ err }, 'No se pudo cerrar pupBrowser en fallback');\n    }\n\n    // Último recurso: matar procesos que estén usando el userDataDir (evita lock persistente)\n    try {\n      const userDataDir = (this.client as any)?.options?.puppeteer?.userDataDir;\n      if (userDataDir && typeof userDataDir === 'string' && userDataDir.trim().length > 0) {\n        const escaped = userDataDir.replace(/'/g, \"'\\\\''\");\n        await exec(`pkill -f '${escaped}' || true`);\n      }\n    } catch (err) {\n      logger.warn({ err }, 'No se pudo ejecutar pkill de cleanup para WhatsApp');\n    }\n  }\n}\n","import { config } from '../config.js';\n\nexport const digitsOnly = (s: string) => String(s || '').replace(/[^0-9]/g, '');\n\nexport const normalizeToCR = (rawPhone: string): string => {\n  const digits = digitsOnly(rawPhone);\n  if (digits.length === 8) return `${config.defaultCountryCode}${digits}`;\n  return digits;\n}\n\nexport const formatWhatsAppId = (rawPhone: string): string => {\n  const digits = digitsOnly(rawPhone);\n  if (digits.length < 8) {\n    throw new Error(`El número ${rawPhone} no parece válido para WhatsApp.`);\n  }\n  const hasCountry = digits.length >= 11;\n  const normalized = hasCountry ? digits : `${config.defaultCountryCode}${digits.replace(/^0+/, '')}`;\n  return `${normalized}@c.us`;\n};\n","import { config } from './config.js';\nimport { logger } from './logger.js';\nimport { ReminderProcessor } from './reminder-processor.js';\nimport { WhatsAppClient } from './whatsapp-client.js';\nimport { apiClient } from './api-client.js';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport http from 'http';\nimport { URL } from 'url';\nimport axios from 'axios';\n\nconst whatsappClient = new WhatsAppClient();\nconst processor = new ReminderProcessor(whatsappClient);\n\nconst runBatch = async () => {\n  try {\n    await processor.runBatch();\n  } catch (error) {\n    logger.error({ err: error }, 'Error procesando lote de recordatorios');\n  }\n};\n\nasync function main(): Promise<void> {\n  // per-chat menu state: whether a menu was just shown and we're awaiting selection\n  const menuShown = new Map<string, boolean>();\n  // store last shown menu items per chat to support numeric selection\n  const lastMenuItems = new Map<string, Array<any>>();\n  // per-chat agent mode: when true the user is interacting with a human agent and the bot should pause\n  const agentMode = new Map<string, boolean>();\n  // throttle admin notifications per chat to avoid spamming admins\n  const adminNotifiedAt = new Map<string, number>();\n  const AGENT_NOTIFY_THROTTLE_MS = Number(process.env.AGENT_NOTIFY_THROTTLE_MS || 30 * 60 * 1000); // default 30 minutes\n  // awaiting receipt uploads per chat\n  const awaitingReceipt = new Map<string, boolean>();\n  // pending confirmation for an unsolicited media receipt: store downloaded media until user confirms\n  const pendingConfirmReceipt = new Map<string, { data: string; mimetype: string; filename?: string; text?: string }>();\n  // after we save receipt (and optionally create backend payment) we ask how many months are being paid\n  const awaitingMonths = new Map<string, { receiptId: string; backendReceiptId?: number | null; backendPaymentId?: number | null }>();\n  const RECEIPTS_DIR = path.join(process.cwd(), 'data', 'receipts');\n  const RECEIPTS_INDEX = path.join(RECEIPTS_DIR, 'index.json');\n\n  // ----- Admin / timeout / business hours helpers (portadas desde el otro repo) -----\n  let TIMEZONE = process.env.TIMEZONE || 'America/Costa_Rica';\n\n  function onlyDigits(s?: string) { return String(s || '').replace(/[^0-9]/g, ''); }\n  function normalizeCR(s?: string) {\n    const d = onlyDigits(s);\n    if (d.length === 8) return (config.defaultCountryCode || '506') + d;\n    return d;\n  }\n\n  const ADMIN_PHONES_RAW = (process.env.BOT_ADMIN_PHONES && process.env.BOT_ADMIN_PHONES.trim().length ? process.env.BOT_ADMIN_PHONES : '50672140974')\n    .split(',')\n    .map(s => s.trim())\n    .filter(Boolean);\n\n  const ADMIN_PHONES = Array.from(new Set([\n    ...ADMIN_PHONES_RAW.map(s => s),\n    ...ADMIN_PHONES_RAW.map(s => normalizeCR(s))\n  ]));\n\n  function normalizeToChatId(num?: string) {\n    if (!num) return null;\n    const digits = String(num).replace(/[^0-9]/g, '');\n    let phone = digits;\n    if (phone.length === 8) phone = (config.defaultCountryCode || '506') + phone;\n    if (!/^[0-9]{8,15}$/.test(phone)) return null;\n    return phone.endsWith('@c.us') ? phone : phone + '@c.us';\n  }\n\n  function isAdminChatId(chatId?: string) {\n    if (!chatId) return false;\n    const user = chatId.replace(/@c\\.us$/, '');\n    const normalized = normalizeCR(user);\n    return ADMIN_PHONES.includes(user) || ADMIN_PHONES.includes(normalized);\n  }\n\n  async function isAllowedForChatCleanup(phoneDigits: string): Promise<boolean> {\n    // Admins nunca se limpian\n    if (ADMIN_PHONES.includes(phoneDigits) || ADMIN_PHONES.includes(normalizeCR(phoneDigits))) return true;\n\n    // Si está pausado, igual es “conocido” (es un contacto gestionado), entonces lo dejamos\n    try {\n      const paused = await apiClient.checkPausedContact(phoneDigits);\n      if (paused) return true;\n    } catch {\n      // ignore\n    }\n\n    // Cliente existente\n    try {\n      const client = await apiClient.findCustomerByPhone(phoneDigits);\n      return Boolean(client);\n    } catch {\n      // Si backend no responde, no limpiamos por seguridad\n      return true;\n    }\n  }\n\n  // Timeouts: default 10 minutes for bot menu inactivity\n  const BOT_TIMEOUT_MS = Number(process.env.BOT_TIMEOUT_MS || 10 * 60 * 1000);\n  const _AGENT_TIMEOUT_MS = Number(process.env.AGENT_TIMEOUT_MS || 60 * 60 * 1000);\n  const chatTimeoutMs = new Map<string, number>();\n  const chatTimers = new Map<string, NodeJS.Timeout>();\n\n  function clearTimer(chatId: string) {\n    const t = chatTimers.get(chatId);\n    if (t) {\n      clearTimeout(t);\n      chatTimers.delete(chatId);\n    }\n  }\n\n  function touchTimer(chatId: string) {\n    clearTimer(chatId);\n    const timeout = chatTimeoutMs.get(chatId) || BOT_TIMEOUT_MS;\n    const timer = setTimeout(() => {\n      menuShown.delete(chatId);\n      lastMenuItems.delete(chatId);\n      agentMode.delete(chatId);  // Limpiar modo agente después del timeout\n      awaitingReceipt.delete(chatId);  // Limpiar espera de comprobante\n      awaitingMonths.delete(chatId);  // Limpiar espera de meses\n      pendingConfirmReceipt.delete(chatId);  // Limpiar confirmación pendiente\n      chatTimeoutMs.delete(chatId);\n      chatTimers.delete(chatId);\n      logger.info({ chatId, timeoutMs: timeout }, 'Chat timeout: estado limpiado por inactividad');\n    }, timeout);\n    chatTimers.set(chatId, timer);\n  }\n\n  // Business hours config (simple default, puede ampliarse desde env si es necesario)\n  // Default business hours (can be overridden by env BOT_BUSINESS_HOURS as JSON or by backend settings.business_hours)\n  let BUSINESS_HOURS: Record<number, { open: string; close: string }> = {\n    0: { open: '08:00', close: '19:00' },\n    1: { open: '08:00', close: '19:00' },\n    2: { open: '08:00', close: '19:00' },\n    3: { open: '08:00', close: '19:00' },\n    4: { open: '08:00', close: '19:00' },\n    5: { open: '08:00', close: '19:00' },\n    6: { open: '08:00', close: '19:00' }\n  };\n\n  // Allow override from environment variable BOT_BUSINESS_HOURS (JSON string)\n  try {\n    const envHours = process.env.BOT_BUSINESS_HOURS;\n    if (envHours && envHours.trim().length) {\n      const parsed = JSON.parse(envHours);\n      if (parsed && typeof parsed === 'object') {\n        BUSINESS_HOURS = Object.assign({}, BUSINESS_HOURS, parsed);\n      }\n    }\n  } catch (e) {\n    logger.debug({ e }, 'BOT_BUSINESS_HOURS parse failed, using defaults');\n  }\n\n  function hhmmToMinutes(hhmm: string) {\n    const [h, m] = hhmm.split(':').map(Number);\n    return h * 60 + (m || 0);\n  }\n\n  function getTZParts(date = new Date()) {\n    const parts = new Intl.DateTimeFormat('en-US', {\n      timeZone: TIMEZONE,\n      weekday: 'short',\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: false\n    }).formatToParts(date);\n    const obj: Record<string, string> = {};\n    for (const p of parts) obj[p.type] = p.value;\n    const dayMap: Record<string, number> = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };\n    return {\n      day: dayMap[obj.weekday] ?? 0,\n      minutes: Number(obj.hour) * 60 + Number(obj.minute)\n    };\n  }\n\n  function _isWithinBusinessHours(now = new Date()) {\n    const { day, minutes } = getTZParts(now);\n    const configHours = BUSINESS_HOURS[day];\n    if (!configHours) return false;\n    const start = hhmmToMinutes(configHours.open);\n    const end = hhmmToMinutes(configHours.close);\n    return minutes >= start && minutes <= end;\n  }\n\n  function formatBusinessHours(): string {\n    try {\n      const names = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];\n      const parts: string[] = [];\n      for (let d = 1; d <= 5; d++) {\n        if (BUSINESS_HOURS[d]) parts.push(`${names[d]} ${BUSINESS_HOURS[d].open}-${BUSINESS_HOURS[d].close}`);\n      }\n      // include weekend if differs\n      if (BUSINESS_HOURS[0]) parts.push(`Dom ${BUSINESS_HOURS[0].open}-${BUSINESS_HOURS[0].close}`);\n      if (BUSINESS_HOURS[6]) parts.push(`Sáb ${BUSINESS_HOURS[6].open}-${BUSINESS_HOURS[6].close}`);\n      return parts.join(', ');\n    } catch (e) {\n      return 'Horario no disponible';\n    }\n  }\n\n  const afterHoursNotified = new Map<string, number>();\n  function _shouldNotifyAfterHours(id: string) {\n    const last = afterHoursNotified.get(id);\n    const now = Date.now();\n    const THRESHOLD = 30 * 60 * 1000; // 30 minutos\n    if (!last || now - last > THRESHOLD) {\n      afterHoursNotified.set(id, now);\n      return true;\n    }\n    return false;\n  }\n\n  // Admin flows (asistente simple)\n  const adminFlows = new Map<string, any>();\n  // auxiliares para asistentes admin\n  function parseAmountCRC(s?: string) {\n    const digits = String(s || '').replace(/[^0-9]/g, '');\n    const n = Number(digits || 0);\n    return isNaN(n) ? 0 : n;\n  }\n  function validHHMM(s?: string) { return /^\\d{1,2}:\\d{2}$/.test(String(s || '')); }\n  function toHHMM(s?: string, def = '08:00') {\n    const t = String(s || '').trim();\n    if (!t) return def;\n    if (!validHHMM(t)) return null;\n    let [h, m] = t.split(':').map(x => Number(x));\n    if (h < 0 || h > 23 || m < 0 || m > 59) return null;\n    return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');\n  }\n  // ----------------------------------------------------------------------------------\n\n  // --- Menu resolver: intenta API -> BOT_MENU_PATH -> local cache (bot/data/menu.json)\n  async function resolveMenu(): Promise<Array<any> | null> {\n    // Cache en memoria para evitar tocar red/FS en cada request de menú.\n    // Esto mejora mucho la latencia percibida en el primer saludo/\"menu\".\n    const now = Date.now();\n    const ttlMs = Number(process.env.BOT_MENU_CACHE_TTL_MS || 5 * 60 * 1000); // 5 min\n    // @ts-ignore: cache estática sobre la función\n    if ((resolveMenu as any)._cache && (now - (resolveMenu as any)._cacheAt) < ttlMs) {\n      // @ts-ignore: cache estática sobre la función\n      return (resolveMenu as any)._cache;\n    }\n\n    const DATA_DIR = path.join(process.cwd(), 'data');\n    const localMenuPath = path.join(DATA_DIR, 'menu.json');\n    // 1) Try API\n    try {\n      const remote = await apiClient.fetchBotMenu();\n      if (Array.isArray(remote) && remote.length) {\n        try {\n          await fs.mkdir(DATA_DIR, { recursive: true });\n          await fs.writeFile(localMenuPath, JSON.stringify(remote, null, 2), { encoding: 'utf8' });\n        } catch (e) {\n          logger.debug({ e }, 'No se pudo persistir menú remoto en cache local');\n        }\n        // @ts-ignore: cache estática sobre la función\n        (resolveMenu as any)._cache = remote;\n        // @ts-ignore: cache estática sobre la función\n        (resolveMenu as any)._cacheAt = Date.now();\n        return remote;\n      }\n    } catch (e) {\n      logger.debug({ e }, 'fetchBotMenu falló');\n    }\n\n    // 2) Try configured BOT_MENU_PATH\n    if (config.menuPath) {\n      try {\n        const raw = await fs.readFile(config.menuPath, { encoding: 'utf8' });\n        const parsed = JSON.parse(raw) as Array<any>;\n        if (Array.isArray(parsed) && parsed.length) {\n          // @ts-ignore: cache estática sobre la función\n          (resolveMenu as any)._cache = parsed;\n          // @ts-ignore: cache estática sobre la función\n          (resolveMenu as any)._cacheAt = Date.now();\n          return parsed;\n        }\n      } catch (err) {\n        logger.debug({ err }, 'No se pudo leer BOT_MENU_PATH');\n      }\n    }\n\n    // 3) Try local cached menu\n    try {\n      const raw = await fs.readFile(localMenuPath, { encoding: 'utf8' });\n      const parsed = JSON.parse(raw) as Array<any>;\n      if (Array.isArray(parsed) && parsed.length) {\n        // @ts-ignore: cache estática sobre la función\n        (resolveMenu as any)._cache = parsed;\n        // @ts-ignore: cache estática sobre la función\n        (resolveMenu as any)._cacheAt = Date.now();\n        return parsed;\n      }\n    } catch {\n      // ignore\n    }\n\n    return null;\n  }\n\n\n  whatsappClient.registerInboundHandler(async (message) => {\n  const t0 = Date.now();\n  const timings: Record<string, number> = {};\n  const mark = (k: string) => {\n    timings[k] = Date.now() - t0;\n  };\n  // Ignore WhatsApp 'status' / broadcast messages (ej: status@broadcast)\n  if (String(message.from || '').endsWith('@broadcast')) return;\n\n  // Evitar logging pesado del body completo (puede ser grande y mete I/O).\n  // Log muestreado y truncado.\n  try {\n    const sampleRate = Number(process.env.BOT_INBOUND_LOG_SAMPLE_RATE || 0.1); // 10%\n    if (!Number.isFinite(sampleRate) || sampleRate <= 0) {\n      logger.info({ from: message.from }, 'Mensaje entrante de WhatsApp');\n    } else if (Math.random() < Math.min(1, sampleRate)) {\n      const b = String(message.body ?? '');\n      logger.info({ from: message.from, body: b.slice(0, 200) }, 'Mensaje entrante de WhatsApp');\n    }\n  } catch {\n    logger.info({ from: message.from }, 'Mensaje entrante de WhatsApp');\n  }\n\n  const body = String(message.body ?? '').trim();\n  // allow empty textual body if there's media attached (media-only messages)\n  if (!body && !((message as any).hasMedia)) return;\n\n  const lc = body.toLowerCase();\n  mark('parsed');\n    const chatId = message.from;\n    const fromUser = String(chatId || '').replace(/@c\\.us$/, '');\n    const fromNorm = normalizeCR(fromUser);\n    const slowMs = Number(process.env.BOT_SLOW_MESSAGE_MS || 2500);\n    const send = async (text: string) => {\n      const tSend0 = Date.now();\n      try {\n        await whatsappClient.sendText(chatId, text);\n      } finally {\n        timings.sendTextMs = (timings.sendTextMs || 0) + (Date.now() - tSend0);\n        mark('sent');\n        const total = Date.now() - t0;\n        // Log sólo si es lento o si está habilitada la traza\n        const traceLatency = (() => {\n          const v = String(process.env.BOT_TRACE_LATENCY || '').trim().toLowerCase();\n          return v === '1' || v === 'true' || v === 'yes' || v === 'on';\n        })();\n\n        if (traceLatency || (Number.isFinite(slowMs) && total >= slowMs)) {\n          logger.info(\n            {\n              chatId,\n              fromNorm,\n              totalMs: total,\n              timings\n            },\n            'Latencia handler WhatsApp'\n          );\n        }\n      }\n    };\n\n    // Admin definido temprano para poder aplicar reglas de silencio.\n    const isAdminUserEarly = isAdminChatId(chatId) || fromNorm === '50672140974';\n\n    // Atajo: si un admin escribe adminmenu, responder inmediatamente.\n    // Esto evita esperas por checks de backend (paused/settings) cuando estamos en modo polling fallback.\n    if (isAdminUserEarly && (lc === 'adminmenu' || lc === 'admin' || lc === 'menuadmin')) {\n      const adminMenuText = [\n        '🔧 *MENÚ ADMIN* 🔧',\n        '',\n        'Envía el número de la opción deseada:',\n        '',\n        '1️⃣ Crear cliente + contrato',\n        '2️⃣ Ver detalles de cliente',\n        '3️⃣ Ver mis detalles',\n        '4️⃣ Listar comprobantes del día',\n        '5️⃣ Generar comprobante para cliente',\n        '6️⃣ Enviar comprobante por ID',\n        '7️⃣ Listar transacciones',\n        '8️⃣ Ejecutar scheduler',\n        '',\n        '💰 *PAGOS Y CONCILIACIÓN*',\n        '9️⃣ Registrar pago manual',\n        '🔟 Conciliar pago',\n        '1️⃣1️⃣ Listar pagos pendientes',\n        '',\n        '🗑️ *ELIMINACIÓN*',\n        '1️⃣2️⃣ Eliminar cliente',\n        '1️⃣3️⃣ Eliminar contrato',\n        '1️⃣4️⃣ Eliminar transacción',\n        '',\n        '1️⃣5️⃣ Estado del bot',\n        '1️⃣6️⃣ Pausar / reanudar contacto (silenciar bot)',\n  '1️⃣7️⃣ Limpiar chats no-clientes (borrar/limpiar)',\n        '',\n        '📋 Escribe *help para ver comandos de texto',\n        '❌ Escribe salir para cancelar',\n      ].join('\\n');\n      await send(adminMenuText);\n      menuShown.set(chatId, true);\n      lastMenuItems.set(chatId, [{ type: 'admin_menu' }]);\n      return;\n    }\n\n    // Modo silencio por contacto pausado: si un número está en paused-contacts, el bot NO responde.\n    // Esto está pensado para que puedas chatear manualmente con el cliente sin que el bot \"se meta\".\n    // Excepciones: admins siempre pasan; y permitimos comandos explícitos de unpause.\n    try {\n      if (!isAdminUserEarly) {\n        // Permitir que un admin pueda escribir \"unpause\" aunque el contacto esté pausado\n        // (si alguien reenvía mensajes, etc.). Para usuarios normales, nada.\n        const allowIfUserWantsUnpause = (lc === 'unpause' || lc === 'reanudar');\n        if (!allowIfUserWantsUnpause) {\n          const paused = await apiClient.checkPausedContact(fromNorm);\n          mark('pausedCheck');\n          if (paused) {\n            logger.info({ chatId, fromNorm }, 'Contacto pausado: bot en silencio (no se responde)');\n            return;\n          }\n        }\n      }\n    } catch (e) {\n      // best-effort: si falla el check, continuar normal\n    }\n\n    // Mantener timeout por chat y detectar admin\n    try {\n      touchTimer(chatId);\n    } catch (e) {\n      logger.debug({ e }, 'touchTimer fallo');\n    }\n\n  // Business hours check: admins and ongoing processes always bypass\n  // Regular users can now use the menu and automatic options 24/7, but agent requests notify about off-hours\n  try {\n    const isInActiveProcess = awaitingReceipt.get(chatId) || pendingConfirmReceipt.has(chatId) || awaitingMonths.has(chatId) || agentMode.get(chatId) || menuShown.get(chatId);\n    const isMediaUpload = !!(message as any).hasMedia;\n    \n    // Solo bloqueamos mensajes completamente fuera de contexto cuando no hay horario\n    // El menú y las opciones automáticas ahora funcionan 24/7\n    if (! _isWithinBusinessHours() && !isAdminUserEarly && !isInActiveProcess && !isMediaUpload && lc !== 'menu' && lc !== 'inicio' && lc !== 'help') {\n      await message.reply(`Hola. Actualmente estamos fuera del horario de atención (${TIMEZONE}). Nuestro horario: ${formatBusinessHours()}.\\n\\n💡 Puedes usar el menú escribiendo \"menu\" para acceder a opciones automáticas disponibles 24/7.`);\n      return;\n    }\n  } catch (e) {\n    logger.debug({ e }, 'error verificando horario de atención');\n  }\n\n  // (silencio por contacto pausado) manejado arriba, para no duplicar llamadas.\n\n  // If we're awaiting a receipt from this chat, handle media uploads first\n    if (awaitingReceipt.get(chatId)) {\n      try {\n        if ((message as any).hasMedia) {\n          const media = await (message as any).downloadMedia();\n          const fname = (media.filename && media.filename.trim()) ? media.filename : `receipt-${chatId.replace(/[^0-9]/g,'')}-${Date.now()}`;\n          // save locally and notify admin\n          const saved = await saveReceipt(chatId, fname, media.data, media.mimetype, body);\n          // Create a backend Payment placeholder (in CRC) so it appears in UI even before months are applied.\n          // We'll attach the PDF if it's already a PDF; otherwise admin will receive the media via WhatsApp.\n          let backendPaymentId: number | null = null;\n          try {\n            // Ensure client exists\n            let client: any = null;\n            try { client = await apiClient.findCustomerByPhone(fromNorm); } catch (e) { /* ignore */ }\n            if (!client) {\n              try { client = await apiClient.upsertCustomer({ phone: fromNorm, name: fromUser }); } catch (e) { /* ignore */ }\n            }\n\n            const paymentPayload: any = {\n              client_id: client && client.id ? client.id : undefined,\n              amount: 0,\n              currency: 'CRC',\n              channel: 'whatsapp',\n              status: 'unverified',\n              reference: `bot:${saved.id}`,\n              metadata: { local_receipt_id: saved.id }\n            };\n\n            const pRes = await apiClient.createPayment(paymentPayload);\n            if (pRes && (pRes.id || pRes.payment_id)) {\n              backendPaymentId = pRes.id ?? pRes.payment_id;\n              await updateReceiptEntry(saved.id, { backend_payment_id: backendPaymentId, status: 'created' });\n            } else {\n              await updateReceiptEntry(saved.id, { status: 'created' });\n            }\n\n            // If we have a backend payment, try to attach the file. If it's an image, convert to PDF first.\n            if (backendPaymentId) {\n              try {\n                let attachBuf: Buffer | null = null;\n                let attachName = fname;\n                if (media.mimetype === 'application/pdf') {\n                  attachBuf = Buffer.from(media.data, 'base64');\n                } else if (/^image\\//.test(media.mimetype)) {\n                  try {\n                    const imgBuf = Buffer.from(media.data, 'base64');\n                    const pdfBuf = await imageBufferToPdfBuffer(imgBuf, fname + '.pdf');\n                    attachBuf = pdfBuf;\n                    attachName = (fname.endsWith('.pdf') ? fname : (fname + '.pdf'));\n                  } catch (e: any) {\n                    logger.debug({ e }, 'No se pudo convertir imagen a PDF para adjuntar, se omite attach');\n                    attachBuf = null;\n                  }\n                }\n                if (attachBuf) {\n                  const fdMod = await import('form-data');\n                  const FormDataCtor: any = fdMod && (fdMod as any).default ? (fdMod as any).default : fdMod;\n                  const form = new FormDataCtor();\n                  form.append('file', attachBuf, { filename: attachName, contentType: 'application/pdf' });\n                  form.append('received_at', new Date().toISOString());\n                  form.append('metadata', JSON.stringify([]));\n                  const headers = Object.assign({ Authorization: `Bearer ${config.apiToken}`, Accept: 'application/json' }, form.getHeaders());\n                  await axios.post(`${config.apiBaseUrl.replace(/\\/$/, '')}/payments/${backendPaymentId}/receipts`, form, { headers });\n                }\n              } catch (e: any) {\n                logger.debug({ e, backendPaymentId, saved }, 'No se pudo adjuntar PDF al payment (se continuará de todas formas)');\n              }\n            }\n          } catch (e: any) {\n            logger.warn({ e, chatId }, 'No se pudo crear payment placeholder en backend');\n          }\n\n          // After saving receipt and creating backend payment placeholder, ask client cuántos meses son\n          awaitingMonths.set(chatId, { receiptId: saved.id, backendPaymentId });\n          await message.reply('Gracias. ¿Cuántos meses estás pagando con este comprobante? Responde con un número, por ejemplo: 1');\n\n          // notify admin and forward media (include backend payment id if available)\n          try {\n            const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n            const adminChatId = normalizeToChatId(adminPhone);\n            if (adminChatId) {\n              const notifyText = backendPaymentId\n                ? `Nuevo comprobante de ${fromUser} (${chatId}). ID interno: ${saved.id} | backend payment: ${backendPaymentId}`\n                : `Nuevo comprobante de ${fromUser} (${chatId}). ID interno: ${saved.id}`;\n              await whatsappClient.sendText(adminChatId, notifyText);\n              await whatsappClient.sendMedia(adminChatId, media.data, media.mimetype, fname);\n              logger.info({ adminChatId, chatId, file: saved.filepath, backendPaymentId }, 'Enviado comprobante al admin');\n            }\n          } catch (e: any) {\n            logger.warn({ e }, 'Fallo notificando admin sobre comprobante recibido');\n          }\n\n          awaitingReceipt.delete(chatId);\n          await message.reply('✅ Recibimos tu comprobante. Un asesor lo revisará y te contactará si es necesario.');\n          return;\n        } else {\n          await message.reply('Por favor adjunta una foto o PDF del comprobante. Si no deseas continuar escribe \"salir\".');\n          return;\n        }\n      } catch (e: any) {\n        logger.error({ e }, 'Error procesando comprobante');\n        awaitingReceipt.delete(chatId);\n        await message.reply('❌ Ocurrió un error procesando el comprobante. Intenta de nuevo o escribe \"salir\" para cancelar.');\n        return;\n      }\n    }\n\n    // If user sent media but we are NOT in awaitingReceipt and NOT in agentMode, offer to register it as comprobante\n    try {\n      if (!(awaitingReceipt.get(chatId)) && !(agentMode.get(chatId)) && ((message as any).hasMedia)) {\n        // download and keep in-memory until user confirms\n        try {\n          const media = await (message as any).downloadMedia();\n          const fname = (media.filename && media.filename.trim()) ? media.filename : `receipt-${chatId.replace(/[^0-9]/g,'')}-${Date.now()}`;\n          pendingConfirmReceipt.set(chatId, { data: media.data, mimetype: media.mimetype, filename: fname, text: body });\n          await message.reply('Veo que enviaste un archivo. ¿Es un comprobante de pago? Responde \"si\" para registrarlo y notificar a un asesor, o \"no\" para cancelar.');\n          return;\n        } catch (e: any) {\n          logger.warn({ e, chatId }, 'Error descargando media para confirmación');\n          // continue to normal flow\n        }\n      }\n    } catch (e: any) {\n      logger.debug({ e }, 'Error en flujo de detección de media');\n    }\n\n  const isAdminUser = isAdminChatId(chatId) || fromNorm === '50672140974';\n\n    // Si hay un asistente admin en curso y el mensaje NO empieza con '*', procesarlo\n    if (isAdminUser && adminFlows.has(chatId) && !lc.startsWith('*')) {\n      const flow = adminFlows.get(chatId);\n      try {\n  // cleanup_chats flow (limpieza de chats no-clientes)\n        if (flow.type === 'cleanup_chats') {\n          if (flow.step === 1) {\n            const ans = (body || '').trim().toLowerCase();\n            if (ans === '1' || ans === 'simular' || ans === 'dry' || ans === 'dryrun') {\n              const summary = await whatsappClient.cleanupChats({\n                dryRun: true,\n                includeUnread: Boolean(flow.data?.includeUnread),\n                includeGroups: Boolean(flow.data?.includeGroups),\n                limit: 200,\n                isAllowedNumber: isAllowedForChatCleanup,\n              });\n\n              adminFlows.delete(chatId);\n              const lines: string[] = [];\n              lines.push('🧹 *Limpieza de chats (SIMULACIÓN)*');\n              lines.push('');\n              lines.push(`Chats revisados: ${summary.scanned}`);\n              lines.push(`Candidatos a limpiar (no-clientes): ${summary.candidates}`);\n              lines.push(`Saltados por no leídos: ${summary.skippedUnread}`);\n              lines.push(`Saltados por grupos: ${summary.skippedGroup}`);\n              lines.push(`Errores: ${summary.errors}`);\n              lines.push('');\n              if (summary.sample?.length) {\n                lines.push('*Muestra (hasta 20):*');\n                for (const s of summary.sample.slice(0, 20)) {\n                  const who = s.phone ? s.phone : s.chatId;\n                  lines.push(`• ${who}: ${s.action}${s.reason ? ` (${s.reason})` : ''}`);\n                }\n              }\n              lines.push('');\n              lines.push('Escribe *adminmenu* para volver');\n              await message.reply(lines.join('\\n'));\n              return;\n            }\n\n            if (ans === '3') {\n              flow.data.includeUnread = !Boolean(flow.data?.includeUnread);\n              await message.reply(`✅ includeUnread ahora es: ${flow.data.includeUnread ? 'SI' : 'NO'}\\n\\nResponde 1 (simular) o 2 (ejecutar) o 4 (grupos).`);\n              return;\n            }\n\n            if (ans === '4') {\n              flow.data.includeGroups = !Boolean(flow.data?.includeGroups);\n              await message.reply(`✅ includeGroups ahora es: ${flow.data.includeGroups ? 'SI' : 'NO'}\\n\\nResponde 1 (simular) o 2 (ejecutar) o 3 (no leídos).`);\n              return;\n            }\n\n            if (ans === '2' || ans === 'ejecutar' || ans === 'run') {\n              flow.step = 2;\n              await message.reply([\n                '⚠️ *Confirmación requerida*',\n                '',\n                'Esto intentará *borrar el chat* (si WhatsApp Web lo permite).',\n                'Si no se puede borrar, hará fallback a *limpiar mensajes* (sin archivar automáticamente).',\n                `Configuración: includeUnread=${Boolean(flow.data?.includeUnread) ? 'SI' : 'NO'}, includeGroups=${Boolean(flow.data?.includeGroups) ? 'SI' : 'NO'}.`,\n                '',\n                'Responde *CONFIRMAR* para ejecutar, o *cancelar* para salir.'\n              ].join('\\n'));\n              return;\n            }\n\n            await message.reply('Responde 1 (simular), 2 (ejecutar), 3 (toggle no leídos) o 4 (toggle grupos).');\n            return;\n          }\n\n          if (flow.step === 2) {\n            const ans = (body || '').trim().toLowerCase();\n            if (ans === 'cancelar' || ans === 'salir' || ans === 'no') {\n              adminFlows.delete(chatId);\n              await message.reply('Operación cancelada. Escribe *adminmenu* para volver');\n              return;\n            }\n\n            if (ans !== 'confirmar') {\n              await message.reply('Responde *CONFIRMAR* para ejecutar o *cancelar* para salir.');\n              return;\n            }\n\n            const summary = await whatsappClient.cleanupChats({\n              dryRun: false,\n              includeUnread: Boolean(flow.data?.includeUnread),\n              includeGroups: Boolean(flow.data?.includeGroups),\n              limit: 200,\n              isAllowedNumber: isAllowedForChatCleanup,\n            });\n\n            adminFlows.delete(chatId);\n            const lines: string[] = [];\n            lines.push('🧹 *Limpieza de chats (EJECUTADA)*');\n            lines.push('');\n            lines.push(`Chats revisados: ${summary.scanned}`);\n            lines.push(`Candidatos detectados: ${summary.candidates}`);\n            lines.push(`Acciones ejecutadas: ${summary.acted}`);\n            lines.push(`Errores: ${summary.errors}`);\n            lines.push('');\n            lines.push('Escribe *adminmenu* para volver');\n            await message.reply(lines.join('\\n'));\n            return;\n          }\n        }\n\n        // pause_contact flow (silenciar bot para un cliente)\n        if (flow.type === 'pause_contact') {\n          if (flow.step === 1) {\n            let ph = body === 'yo' ? fromNorm : normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) {\n              await message.reply('Ingresa un teléfono válido (8 dígitos CR o con código de país).');\n              return;\n            }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            flow.data.phone = ph;\n            flow.step = 2;\n            await message.reply('¿Qué deseas hacer? Responde con:\\n1) Pausar (silenciar bot)\\n2) Reanudar (activar bot)\\n3) Ver estado');\n            return;\n          }\n\n          if (flow.step === 2) {\n            const ans = (body || '').trim().toLowerCase();\n            let action: 'pause' | 'resume' | 'status' | null = null;\n            if (ans === '1' || ans === 'pausar' || ans === 'pause') action = 'pause';\n            if (ans === '2' || ans === 'reanudar' || ans === 'unpause' || ans === 'resume') action = 'resume';\n            if (ans === '3' || ans === 'estado' || ans === 'status') action = 'status';\n            if (!action) {\n              await message.reply('Responde 1 (pausar), 2 (reanudar) o 3 (estado).');\n              return;\n            }\n\n            const phone = String(flow.data.phone || '');\n            if (!phone) {\n              adminFlows.delete(chatId);\n              await message.reply('❌ Faltó el teléfono. Escribe *adminmenu* para volver.');\n              return;\n            }\n\n            if (action === 'status') {\n              try {\n                const paused = await apiClient.checkPausedContact(phone);\n                adminFlows.delete(chatId);\n                await message.reply(`📌 Estado para ${phone}: ${paused ? '⏸️ PAUSADO (bot en silencio)' : '✅ ACTIVO'}.\\n\\nEscribe *adminmenu* para volver`);\n                return;\n              } catch (e: any) {\n                adminFlows.delete(chatId);\n                await message.reply(`❌ No pude verificar el estado ahora. Error: ${String(e?.message || e)}\\n\\nEscribe *adminmenu* para volver`);\n                return;\n              }\n            }\n\n            // Intentar resolver client_id, pero NO es obligatorio.\n            let client: any = null;\n            try {\n              client = await apiClient.findCustomerByPhone(phone);\n            } catch (e) {\n              // ignore – puede no existir en el sistema\n            }\n\n            if (action === 'pause') {\n              try {\n                await apiClient.pauseContact({\n                  client_id: client?.id,\n                  whatsapp_number: phone,\n                  reason: 'paused via whatsapp admin menu',\n                });\n                const pausedNow = await apiClient.checkPausedContact(phone);\n                adminFlows.delete(chatId);\n                await message.reply(\n                  `✅ Contacto ${phone} pausado.\\nEstado actual: ${pausedNow ? '⏸️ PAUSADO (silencio)' : '⚠️ AÚN ACTIVO'}\\n\\nEscribe *adminmenu* para volver`\n                );\n                return;\n              } catch (e: any) {\n                logger.error({ err: e, phone, clientId: client?.id }, 'Error pausando contacto');\n                adminFlows.delete(chatId);\n                await message.reply(\n                  `❌ No pude pausar el contacto ${phone}.\\nError: ${String(e?.response?.data?.message || e?.message || e)}\\n\\nEscribe *adminmenu* para volver`\n                );\n                return;\n              }\n            }\n\n            if (action === 'resume') {\n              try {\n                if (client?.id) {\n                  await apiClient.resumeContact({ client_id: client.id, whatsapp_number: phone });\n                } else {\n                  await apiClient.resumeContactByNumber({ whatsapp_number: phone });\n                }\n                const pausedNow = await apiClient.checkPausedContact(phone);\n                adminFlows.delete(chatId);\n                await message.reply(\n                  `✅ Contacto ${phone} reanudado.\\nEstado actual: ${pausedNow ? '⚠️ AÚN PAUSADO' : '✅ ACTIVO'}\\n\\nEscribe *adminmenu* para volver`\n                );\n                return;\n              } catch (e: any) {\n                logger.error({ err: e, phone, clientId: client?.id }, 'Error reanudando contacto');\n                adminFlows.delete(chatId);\n                await message.reply(\n                  `❌ No pude reanudar el contacto ${phone}.\\nError: ${String(e?.response?.data?.message || e?.message || e)}\\n\\nEscribe *adminmenu* para volver`\n                );\n                return;\n              }\n            }\n          }\n        }\n\n        // create_subscription flow\n        if (flow.type === 'create_subscription') {\n          if (flow.step === 1) {\n            let ph = body === 'yo' ? fromNorm : normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('Ingresa un teléfono válido (8 dígitos CR o con código de país).'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            flow.data.phone = ph;\n            flow.step = 2;\n            await message.reply('Nombre del cliente:');\n            return;\n          }\n          if (flow.step === 2) {\n            const name = (body || '').trim();\n            if (!name) { await message.reply('Nombre inválido, intenta de nuevo:'); return; }\n            flow.data.name = name;\n            flow.step = 3;\n            await message.reply('Monto mensual en colones (solo números, ej: 8000):');\n            return;\n          }\n          if (flow.step === 3) {\n            const amount = parseAmountCRC(body);\n            if (!amount || amount <= 0) { await message.reply('Monto inválido. Escribe solo números, ej: 8000'); return; }\n            flow.data.amount = amount;\n            flow.step = 4;\n            await message.reply('Día de cobro (1-31):');\n            return;\n          }\n          if (flow.step === 4) {\n            const day = Number((body || '').replace(/[^0-9]/g, ''));\n            if (!day || day < 1 || day > 31) { await message.reply('Día inválido. Debe ser entre 1 y 31.'); return; }\n            flow.data.day_of_month = day;\n            flow.step = 5;\n            await message.reply('Hora de recordatorio HH:MM en 24h (Enter para 08:00):');\n            return;\n          }\n          if (flow.step === 5) {\n            const h = toHHMM(body, '08:00');\n            if (!h) { await message.reply('Hora inválida. Usa formato HH:MM, ej: 08:00'); return; }\n            flow.data.due_time = h;\n            flow.step = 6;\n            await message.reply('Concepto (opcional). Enter para usar \"Suscripción de Servicios de Entretenimiento\":');\n            return;\n          }\n          if (flow.step === 6) {\n            const concept = (body || '').trim();\n            flow.data.concept = concept || 'Suscripción de Servicios de Entretenimiento';\n            flow.step = 7;\n            const d = flow.data;\n            const resumen = [\n              'Vas a crear:',\n              `• Teléfono: ${d.phone}`,\n              `• Nombre: ${d.name}`,\n              `• Monto: ₡${Number(d.amount || 0).toLocaleString('es-CR')}`,\n              `• Día: ${d.day_of_month}`,\n              `• Hora: ${d.due_time}`,\n              `• Concepto: ${d.concept}`,\n              'Confirma con \"si\" o \"no\"'\n            ].join('\\n');\n            await message.reply(resumen);\n            return;\n          }\n          if (flow.step === 7) {\n            const ans = (body || '').trim().toLowerCase();\n            if (!['si', 'sí', 's', 'y', 'yes', 'confirmar'].includes(ans)) {\n              if (['no', 'n', 'cancelar', 'cancel'].includes(ans)) {\n                adminFlows.delete(chatId);\n                await message.reply('Operación cancelada.');\n                return;\n              }\n              await message.reply('Responde \"si\" para confirmar o \"no\" para cancelar.');\n              return;\n            }\n            try {\n              const d = flow.data;\n              // Upsert customer and create subscription via API\n              await apiClient.upsertCustomer({ phone: d.phone, name: d.name, active: 1 });\n              await apiClient.createSubscription({ phone: d.phone, day_of_month: d.day_of_month, due_time: d.due_time, amount: d.amount, concept: d.concept, active: 1, name: d.name });\n              // Intentar materializar pagos es responsabilidad del backend\n              await message.reply(`✅ Cliente y suscripción creados para ${d.name} (${d.phone}).`);\n            } catch (e: any) {\n              await message.reply(`Error creando registro: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // delete_customer\n        if (flow.type === 'delete_customer') {\n          if (flow.step === 1) {\n            let ph = body === 'yo' ? fromNorm : normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('Ingresa un teléfono válido (8 dígitos CR o con código de país).'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            flow.data.phone = ph;\n            // buscar cliente\n            const cust = await apiClient.findCustomerByPhone(ph);\n            if (!cust) { adminFlows.delete(chatId); await message.reply('No existe un cliente con ese teléfono.'); return; }\n            flow.data.customer_id = cust.id;\n            flow.step = 2;\n            await message.reply(`Vas a ELIMINAR al cliente ${cust.name || cust.phone} y TODO su historial (pagos, recordatorios y suscripciones). Escribe CONFIRMAR para continuar o CANCELAR para abortar.`);\n            return;\n          }\n          if (flow.step === 2) {\n            const ans = (body || '').trim().toLowerCase();\n            if (ans !== 'confirmar') { adminFlows.delete(chatId); await message.reply('Operación cancelada.'); return; }\n            try {\n              const res = await apiClient.deleteCustomer(flow.data.customer_id);\n              await message.reply(`✅ Eliminado. Resultado: ${JSON.stringify(res)}`);\n            } catch (e: any) {\n              await message.reply(`Error al eliminar: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // delete_subscriptions_by_phone\n        if (flow.type === 'delete_subscriptions_by_phone') {\n          if (flow.step === 1) {\n            let ph = body === 'yo' ? fromNorm : normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('Ingresa un teléfono válido (8 dígitos CR o con código de país).'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            flow.data.phone = ph;\n            flow.step = 2;\n            await message.reply(`Vas a ELIMINAR las suscripciones de ${ph} y los pagos FUTUROS asociados. Escribe CONFIRMAR para continuar o CANCELAR para abortar.`);\n            return;\n          }\n          if (flow.step === 2) {\n            const ans = (body || '').trim().toLowerCase();\n            if (ans !== 'confirmar') { adminFlows.delete(chatId); await message.reply('Operación cancelada.'); return; }\n            try {\n              const res = await apiClient.deleteSubscriptionsByPhone(flow.data.phone);\n              await message.reply(`✅ Eliminadas suscripciones: ${JSON.stringify(res)}`);\n            } catch (e: any) {\n              await message.reply(`Error eliminando suscripciones: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // delete_transaction (confirm flow)\n        if (flow.type === 'delete_transaction') {\n          if (flow.step === 1) {\n            const ans = (body || '').trim().toLowerCase();\n            if (ans !== 'confirmar') { adminFlows.delete(chatId); await message.reply('❌ Operación cancelada.'); return; }\n            try {\n              await apiClient.deleteTransaction(flow.data.txnId);\n              await message.reply(`✅ Transacción ${flow.data.txnId} eliminada correctamente`);\n            } catch (e: any) {\n              await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // view_details (from menu)\n        if (flow.type === 'view_details') {\n          if (flow.step === 1) {\n            let ph = body === 'yo' ? fromNorm : normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('Ingresa un teléfono válido (8 dígitos CR o con código de país).'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            try {\n              // Find client first\n              const client = await apiClient.findCustomerByPhone(ph);\n              if (!client) {\n                await message.reply(`❌ No encontré un cliente con ese teléfono.\\n\\nEscribe *adminmenu* para volver`);\n                adminFlows.delete(chatId);\n                return;\n              }\n              \n              // Get contracts instead of subscriptions\n              const contracts = await apiClient.listContracts({ client_id: client.id });\n              const lines: string[] = [];\n              lines.push(`📇 *Detalles de ${client.name || ph}*`);\n              lines.push(`📱 ${client.phone}`);\n              lines.push('');\n              \n              if (contracts && contracts.length) {\n                lines.push(`💼 *Contratos*: ${contracts.length}`);\n                contracts.slice(0, 5).forEach((c: any) => {\n                  lines.push(`  • ${c.name || 'Sin nombre'}`);\n                  lines.push(`    ₡${Number(c.amount || 0).toLocaleString('es-CR')} ${c.currency || 'CRC'}`);\n                  lines.push(`    Ciclo: ${c.billing_cycle || 'N/A'}`);\n                  if (c.next_due_date) lines.push(`    Próximo: ${c.next_due_date.split('T')[0]}`);\n                });\n                if (contracts.length > 5) lines.push(`  ...y ${contracts.length - 5} más`);\n              } else {\n                lines.push('💼 Sin contratos activos');\n              }\n              \n              lines.push('');\n              lines.push('Escribe *adminmenu* para volver al menú admin');\n              await message.reply(lines.join('\\n'));\n            } catch (e: any) {\n              logger.error({ e, phone: ph }, 'Error consultando detalles de cliente');\n              await message.reply(`❌ Error consultando detalles: ${String(e && e.message ? e.message : e)}\\n\\nEscribe *adminmenu* para volver`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // generate_receipt (from menu)\n        if (flow.type === 'generate_receipt') {\n          if (flow.step === 1) {\n            let ph = normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('❌ Teléfono inválido. Usa 8 dígitos.'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            try {\n              await message.reply('⏳ Generando comprobante...');\n              const res = await apiClient.createReceiptForClient({ phone: ph });\n              if (res && res.receipt_id) {\n                await apiClient.sendReceipt(res.receipt_id);\n                await message.reply(`✅ Comprobante generado y enviado a ${ph}\\nID: ${res.receipt_id}\\n\\nEscribe *adminmenu* para volver`);\n              } else {\n                await message.reply('Error generando comprobante (respuesta inesperada del backend).');\n              }\n            } catch (e: any) {\n              await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // send_receipt (from menu)\n        if (flow.type === 'send_receipt') {\n          if (flow.step === 1) {\n            const receiptId = parseInt(body);\n            if (isNaN(receiptId)) { await message.reply('❌ ID inválido. Ingresa solo números.'); return; }\n            try {\n              await apiClient.sendReceipt(receiptId);\n              await message.reply(`✅ Comprobante ${receiptId} enviado (o solicitado envío).\\n\\nEscribe *adminmenu* para volver`);\n            } catch (e: any) {\n              await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // list_transactions (from menu)\n        if (flow.type === 'list_transactions') {\n          if (flow.step === 1) {\n            let filterPhone: string | undefined;\n            const txt = body.trim();\n            if (txt && txt.length > 0) {\n              filterPhone = normalizeCR(txt);\n              if (filterPhone.length === 8) filterPhone = (config.defaultCountryCode || '506') + filterPhone;\n            }\n            try {\n              const transactions = await apiClient.listTransactions(filterPhone, 20);\n              if (!transactions || transactions.length === 0) {\n                await message.reply(filterPhone ? `📭 No hay transacciones para ${filterPhone}` : '📭 No hay transacciones registradas');\n                adminFlows.delete(chatId);\n                return;\n              }\n              const lines: string[] = [];\n              lines.push(filterPhone ? `💰 *Transacciones de ${filterPhone}* (${transactions.length})` : `💰 *Últimas transacciones* (${transactions.length})`, '');\n              for (const [idx, t] of transactions.entries()) {\n                lines.push(`*${idx + 1}.* ID: ${t.id}`);\n                lines.push(`   📅 ${t.created_at || t.txn_date}`);\n                lines.push(`   💵 ₡${Number(t.amount || 0).toLocaleString('es-CR')}`);\n                lines.push(`   📱 ${t.phone || 'N/A'}`);\n                lines.push(`   👤 ${t.client_name || '❓ Sin match'}`);\n                if (t.motivo) lines.push(`   📝 ${t.motivo}`);\n                if (t.ref) lines.push(`   🔖 Ref: ${String(t.ref).substring(0, 15)}...`);\n                lines.push('');\n              }\n              lines.push('Escribe *adminmenu* para volver al menú admin');\n              await message.reply(lines.join('\\n'));\n            } catch (e: any) {\n              await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // delete_transaction_input (from menu - collect ID first)\n        if (flow.type === 'delete_transaction_input') {\n          if (flow.step === 1) {\n            const txnId = parseInt(body);\n            if (isNaN(txnId)) { await message.reply('❌ ID inválido. Ingresa solo números.'); return; }\n            flow.data.txnId = txnId;\n            flow.type = 'delete_transaction';\n            flow.step = 1;\n            await message.reply(`⚠️ ¿Eliminar transacción?\\n\\nID: ${txnId}\\n\\nResponde CONFIRMAR para continuar`);\n            return;\n          }\n        }\n\n        // create_payment (registrar pago manual)\n        if (flow.type === 'create_payment') {\n          if (flow.step === 1) {\n            let ph = normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('❌ Teléfono inválido. Usa 8 dígitos.'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            const client = await apiClient.findCustomerByPhone(ph);\n            if (!client) {\n              await message.reply(`❌ No encontré un cliente con ese teléfono.\\n\\nEscribe *adminmenu* para volver`);\n              adminFlows.delete(chatId);\n              return;\n            }\n            flow.data.client = client;\n            flow.step = 2;\n            await message.reply(`Cliente: *${client.name}*\\n\\nIngresa el monto del pago (solo números, ej: 7000):`);\n            return;\n          }\n          if (flow.step === 2) {\n            const amount = parseAmountCRC(body);\n            if (!amount || amount <= 0) { await message.reply('❌ Monto inválido. Escribe solo números.'); return; }\n            flow.data.amount = amount;\n            flow.step = 3;\n            await message.reply('Moneda (CRC o USD):');\n            return;\n          }\n          if (flow.step === 3) {\n            const currency = body.trim().toUpperCase();\n            if (!['CRC', 'USD'].includes(currency)) { await message.reply('❌ Moneda inválida. Escribe CRC o USD.'); return; }\n            flow.data.currency = currency;\n            flow.step = 4;\n            await message.reply('Canal de pago (ej: sinpe, transferencia, efectivo):');\n            return;\n          }\n          if (flow.step === 4) {\n            flow.data.channel = body.trim() || 'manual';\n            flow.step = 5;\n            await message.reply('Referencia (opcional, Enter para omitir):');\n            return;\n          }\n          if (flow.step === 5) {\n            flow.data.reference = body.trim() || null;\n            flow.step = 6;\n            const d = flow.data;\n            const resumen = [\n              '📝 *Resumen del Pago*',\n              '',\n              `👤 Cliente: ${d.client.name}`,\n              `📱 Teléfono: ${d.client.phone}`,\n              `💵 Monto: ₡${Number(d.amount).toLocaleString('es-CR')} ${d.currency}`,\n              `📊 Canal: ${d.channel}`,\n              `🔖 Referencia: ${d.reference || 'Sin referencia'}`,\n              '',\n              'Confirma con \"si\" o \"no\"'\n            ].join('\\n');\n            await message.reply(resumen);\n            return;\n          }\n          if (flow.step === 6) {\n            const ans = body.trim().toLowerCase();\n            if (!['si', 'sí', 's', 'y', 'yes'].includes(ans)) {\n              if (['no', 'n', 'cancelar'].includes(ans)) {\n                adminFlows.delete(chatId);\n                await message.reply('❌ Registro de pago cancelado.\\n\\nEscribe *adminmenu* para volver');\n                return;\n              }\n              await message.reply('Responde \"si\" para confirmar o \"no\" para cancelar.');\n              return;\n            }\n            try {\n              const d = flow.data;\n              const paymentPayload = {\n                client_id: d.client.id,\n                amount: d.amount,\n                currency: d.currency,\n                channel: d.channel,\n                status: 'unverified',\n                reference: d.reference,\n                metadata: { registered_by: 'admin_via_bot', admin_phone: fromNorm }\n              };\n              const payment = await apiClient.createPayment(paymentPayload);\n              await message.reply(`✅ Pago registrado correctamente.\\n\\nID: ${payment.id}\\nEstado: ${payment.status}\\n\\nEscribe *adminmenu* para volver`);\n            } catch (e: any) {\n              logger.error({ e, data: flow.data }, 'Error creando pago manual');\n              await message.reply(`❌ Error registrando pago: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // conciliate_payment\n        if (flow.type === 'conciliate_payment') {\n          if (flow.step === 1) {\n            const paymentId = parseInt(body);\n            if (isNaN(paymentId)) { await message.reply('❌ ID inválido. Ingresa solo números.'); return; }\n            try {\n              const payment = await apiClient.getPayment(paymentId);\n              if (!payment) {\n                await message.reply(`❌ No encontré el pago con ID ${paymentId}.\\n\\nEscribe *adminmenu* para volver`);\n                adminFlows.delete(chatId);\n                return;\n              }\n              flow.data.payment = payment;\n              flow.step = 2;\n              const lines = [\n                '💰 *Pago a Conciliar*',\n                '',\n                `ID: ${payment.id}`,\n                `Cliente: ${payment.client?.name || payment.client_id}`,\n                `Monto: ₡${Number(payment.amount || 0).toLocaleString('es-CR')} ${payment.currency || 'CRC'}`,\n                `Estado actual: ${payment.status}`,\n                `Referencia: ${payment.reference || 'Sin referencia'}`,\n                '',\n                'Estado nuevo (verified, rejected, o Enter para verified):'\n              ].join('\\n');\n              await message.reply(lines);\n              return;\n            } catch (e: any) {\n              await message.reply(`❌ Error obteniendo pago: ${String(e && e.message ? e.message : e)}`);\n              adminFlows.delete(chatId);\n              return;\n            }\n          }\n          if (flow.step === 2) {\n            const newStatus = body.trim() || 'verified';\n            if (!['verified', 'rejected', 'pending', 'unverified'].includes(newStatus)) {\n              await message.reply('❌ Estado inválido. Usa: verified, rejected, pending o unverified');\n              return;\n            }\n            flow.data.newStatus = newStatus;\n            flow.step = 3;\n            await message.reply('Notas de conciliación (opcional, Enter para omitir):');\n            return;\n          }\n          if (flow.step === 3) {\n            const notes = body.trim() || null;\n            try {\n              const d = flow.data;\n              // Update payment status\n              await apiClient.updatePayment(d.payment.id, { status: d.newStatus });\n              \n              // Create conciliation record\n              const conciliationPayload = {\n                payment_id: d.payment.id,\n                status: d.newStatus,\n                notes: notes,\n                conciliated_by: fromNorm,\n                conciliated_at: new Date().toISOString()\n              };\n              await apiClient.createConciliation(conciliationPayload);\n              \n              await message.reply(`✅ Pago conciliado correctamente.\\n\\nID: ${d.payment.id}\\nNuevo estado: ${d.newStatus}\\n\\nEscribe *adminmenu* para volver`);\n            } catch (e: any) {\n              logger.error({ e, paymentId: flow.data.payment?.id }, 'Error conciliando pago');\n              await message.reply(`❌ Error conciliando pago: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n        // delete_contracts_by_phone\n        if (flow.type === 'delete_contracts_by_phone') {\n          if (flow.step === 1) {\n            let ph = normalizeCR(body);\n            if (!ph || !/^\\d{8,15}$/.test(ph)) { await message.reply('❌ Teléfono inválido.'); return; }\n            if (ph.length === 8) ph = (config.defaultCountryCode || '506') + ph;\n            flow.data.phone = ph;\n            flow.step = 2;\n            await message.reply(`⚠️ Vas a ELIMINAR los contratos de ${ph} y los pagos FUTUROS asociados.\\n\\nEscribe CONFIRMAR para continuar o CANCELAR para abortar.`);\n            return;\n          }\n          if (flow.step === 2) {\n            const ans = body.trim().toLowerCase();\n            if (ans !== 'confirmar') {\n              adminFlows.delete(chatId);\n              await message.reply('❌ Operación cancelada.');\n              return;\n            }\n            try {\n              const result = await apiClient.deleteContractsByPhone(flow.data.phone);\n              await message.reply(`✅ ${result.deleted} contrato(s) eliminado(s) correctamente.`);\n            } catch (e: any) {\n              await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n            }\n            adminFlows.delete(chatId);\n            return;\n          }\n        }\n\n      } catch (e: any) {\n        adminFlows.delete(chatId);\n        await message.reply(`Error en asistente: ${String(e && e.message ? e.message : e)}`);\n        return;\n      }\n    }\n\n    // If user confirms an unsolicited media (pendingConfirmReceipt) with 'si', process it as a receipt\n    if (lc === 'si' && pendingConfirmReceipt.has(chatId)) {\n      const pending = pendingConfirmReceipt.get(chatId)!;\n      try {\n        const saved = await saveReceipt(chatId, pending.filename || `receipt-${Date.now()}.bin`, pending.data, pending.mimetype, pending.text);\n        let backendPaymentId: number | null = null;\n        try {\n          // Ensure client exists\n          let client: any = null;\n          try { client = await apiClient.findCustomerByPhone(fromNorm); } catch (e) { /* ignore */ }\n          if (!client) {\n            try { client = await apiClient.upsertCustomer({ phone: fromNorm, name: fromUser }); } catch (e) { /* ignore */ }\n          }\n\n          const paymentPayload: any = {\n            client_id: client && client.id ? client.id : undefined,\n            amount: 0,\n            currency: 'CRC',\n            channel: 'whatsapp',\n            status: 'unverified',\n            reference: `bot:${saved.id}`,\n            metadata: { local_receipt_id: saved.id }\n          };\n\n          const pRes = await apiClient.createPayment(paymentPayload);\n          if (pRes && (pRes.id || pRes.payment_id)) {\n            backendPaymentId = pRes.id ?? pRes.payment_id;\n            await updateReceiptEntry(saved.id, { backend_payment_id: backendPaymentId, status: 'created' });\n          } else {\n            await updateReceiptEntry(saved.id, { status: 'created' });\n          }\n\n          if (backendPaymentId && pending.mimetype === 'application/pdf') {\n            try {\n              const fileBuf = Buffer.from(pending.data, 'base64');\n              const fdMod2 = await import('form-data');\n              const FormDataCtor2: any = fdMod2 && (fdMod2 as any).default ? (fdMod2 as any).default : fdMod2;\n              const form2 = new FormDataCtor2();\n              form2.append('file', fileBuf, { filename: pending.filename, contentType: pending.mimetype });\n              form2.append('received_at', new Date().toISOString());\n              form2.append('metadata', JSON.stringify([]));\n              const headers2 = Object.assign({ Authorization: `Bearer ${config.apiToken}`, Accept: 'application/json' }, form2.getHeaders());\n              await axios.post(`${config.apiBaseUrl.replace(/\\/$/, '')}/payments/${backendPaymentId}/receipts`, form2, { headers: headers2 });\n            } catch (e: any) {\n              logger.debug({ e, backendPaymentId, saved }, 'No se pudo adjuntar PDF al payment (confirmación)');\n            }\n          }\n        } catch (e: any) {\n          logger.warn({ e, chatId }, 'No se pudo crear payment placeholder en backend (confirmación)');\n        }\n        // After saving receipt and creating backend payment placeholder, ask client cuántos meses pagó\n        awaitingMonths.set(chatId, { receiptId: saved.id, backendPaymentId });\n        await message.reply('Gracias. ¿Cuántos meses estás pagando con este comprobante? Responde con un número, por ejemplo: 1');\n\n        // notify admin\n        try {\n          const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n          const adminChatId = normalizeToChatId(adminPhone);\n          if (adminChatId) {\n            const notifyText = backendPaymentId\n              ? `Nuevo comprobante de ${fromUser} (${chatId}). ID interno: ${saved.id} | backend payment: ${backendPaymentId}`\n              : `Nuevo comprobante de ${fromUser} (${chatId}). ID interno: ${saved.id}`;\n            await whatsappClient.sendText(adminChatId, notifyText);\n            await whatsappClient.sendMedia(adminChatId, pending.data, pending.mimetype, pending.filename);\n            logger.info({ adminChatId, chatId, file: saved.filepath, backendPaymentId }, 'Enviado comprobante al admin (confirmación)');\n          }\n        } catch (e: any) {\n          logger.warn({ e }, 'Fallo notificando admin sobre comprobante recibido (confirmación)');\n        }\n\n        pendingConfirmReceipt.delete(chatId);\n        return;\n      } catch (e: any) {\n        pendingConfirmReceipt.delete(chatId);\n        logger.error({ e }, 'Error procesando comprobante confirmado');\n        await message.reply('❌ Ocurrió un error procesando el comprobante. Intenta de nuevo o escribe \"salir\" para cancelar.');\n        return;\n      }\n    }\n\n    // If user cancels an unsolicited media\n    if (lc === 'no' && pendingConfirmReceipt.has(chatId)) {\n      pendingConfirmReceipt.delete(chatId);\n      await message.reply('He cancelado el registro del archivo. Si necesitas enviar el comprobante usa la opción 6 del menú.');\n      return;\n    }\n\n    // If we're awaiting number of months for a previously uploaded receipt\n  if (awaitingMonths.has(chatId)) {\n  const payload = awaitingMonths.get(chatId)!;\n  const asNum = Number(body.replace(/[^0-9]/g, ''));\n      if (!Number.isNaN(asNum) && asNum > 0) {\n        // try to inform backend about months / create payments for those months\n        let monthlyAmount: number | null = null;\n        try {\n          // Try to fetch subscription info to compute total amount\n          try {\n            // Try to find client and contract to infer monthly amount\n            let clientForAmount: any = null;\n            try { clientForAmount = await apiClient.findCustomerByPhone(fromNorm); } catch (e) { /* ignore */ }\n            if (!clientForAmount) {\n              try { clientForAmount = await apiClient.upsertCustomer({ phone: fromNorm, name: fromUser }); } catch (e) { /* ignore */ }\n            }\n            if (clientForAmount && clientForAmount.id) {\n              const contracts = await apiClient.listContracts({ client_id: clientForAmount.id });\n              if (Array.isArray(contracts) && contracts.length) {\n                const c = contracts[0];\n                if (c && (c.amount || c.monto)) {\n                  monthlyAmount = Number(c.amount || c.monto) || null;\n                }\n              }\n            }\n          } catch (e: any) {\n            logger.debug({ e, chatId }, 'No se pudo obtener contrato para calcular monto mensual');\n          }\n\n          // Resolve or create client in backend\n          let client: any = null;\n          try {\n            client = await apiClient.findCustomerByPhone(fromNorm);\n          } catch (e: any) {\n            logger.debug({ e, fromNorm }, 'findCustomerByPhone fallo');\n          }\n          if (!client) {\n            try {\n              client = await apiClient.upsertCustomer({ phone: fromNorm, name: fromUser });\n            } catch (e: any) {\n              logger.warn({ e, fromNorm }, 'No se pudo upsertCustomer, continuando sin cliente backend');\n            }\n          }\n\n          // Compute amount\n          const amount = monthlyAmount ? monthlyAmount * asNum : 0;\n\n          // If we previously created a backend payment placeholder, update it instead of creating a new payment\n          let appliedResult: any = null;\n          if (payload.backendPaymentId) {\n            try {\n              const updatePayload: any = {\n                amount: amount,\n                currency: 'CRC',\n                metadata: Object.assign({}, { months: asNum, backend_receipt_id: payload.backendPaymentId, local_receipt_id: payload.receiptId })\n              };\n              appliedResult = await apiClient.updatePayment(payload.backendPaymentId, updatePayload);\n              await updateReceiptEntry(payload.receiptId, { months: asNum, status: 'applied', backend_apply_result: appliedResult, backend_payment_id: appliedResult && (appliedResult.id || appliedResult.payment_id) ? (appliedResult.id ?? appliedResult.payment_id) : payload.backendPaymentId, monthly_amount: monthlyAmount, total_amount: amount });\n            } catch (e: any) {\n              throw e;\n            }\n          } else {\n            const paymentPayload: any = {\n              client_id: client && client.id ? client.id : undefined,\n              amount: amount,\n              currency: 'CRC',\n              channel: 'whatsapp',\n              status: 'unverified',\n              reference: payload.backendReceiptId ? `receipt:${payload.backendReceiptId}` : `bot:${payload.receiptId}`,\n              metadata: { months: asNum, backend_receipt_id: payload.backendReceiptId }\n            };\n            const res = await apiClient.createPayment(paymentPayload);\n            appliedResult = res;\n            await updateReceiptEntry(payload.receiptId, { months: asNum, status: 'applied', backend_apply_result: res, backend_payment_id: res && (res.id || res.payment_id) ? (res.id ?? res.payment_id) : null, monthly_amount: monthlyAmount, total_amount: amount });\n          }\n\n          // notify admin with details\n          try {\n            const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n            const adminChatId = normalizeToChatId(adminPhone);\n            if (adminChatId) {\n              const txt = `El cliente ${fromUser} (${chatId}) indicó que paga ${asNum} mes(es) para el comprobante ${payload.receiptId}` + (payload.backendReceiptId ? ` (backend receipt ${payload.backendReceiptId})` : '');\n              await whatsappClient.sendText(adminChatId, txt);\n              logger.info({ adminChatId, chatId, months: asNum, receiptId: payload.receiptId }, 'Admin notificado: meses aplicados al comprobante');\n            }\n          } catch (e: any) {\n            logger.warn({ e }, 'No se pudo notificar al admin sobre meses aplicados');\n          }\n\n          awaitingMonths.delete(chatId);\n          await message.reply(`✅ Gracias. He registrado que pagas ${asNum} mes(es). Un asesor validará y conciliará el pago.`);\n          return;\n        } catch (e: any) {\n          // Log detailed error info (include axios response payload when available)\n          const errInfo: any = { message: String(e && e.message ? e.message : e) };\n          try {\n            if (e && e.response) {\n              errInfo.status = e.response.status;\n              errInfo.data = e.response.data;\n            }\n            if (e && e.code) errInfo.code = e.code;\n          } catch (ee) {\n            // ignore\n          }\n          logger.warn({ errInfo, chatId, payload: { phone: fromNorm, months: asNum, backendReceiptId: payload.backendReceiptId } }, 'Error informando al backend sobre meses');\n\n          // Persist error details in the receipt index so admins can inspect later\n          try {\n            await updateReceiptEntry(payload.receiptId, { status: 'apply_failed', apply_error: errInfo, attempted_months: asNum });\n          } catch (ee: any) {\n            logger.debug({ ee }, 'No se pudo actualizar índice con error de aplicación de meses');\n          }\n\n          // Inform the user with a friendlier message and inform that we'll retry once automatically\n          await message.reply('❌ No pude registrar el número de meses en este momento. Intentaré de nuevo automáticamente en unos minutos y, si sigue fallando, un asesor te ayudará. Mientras tanto puedes escribir \"salir\" para cancelar.');\n\n          // schedule a single retry in the background (non-blocking)\n          try {\n            const retryDelayMs = 60 * 1000; // 1 minute\n            setTimeout(async () => {\n              try {\n                // Retry creating payment in backend\n                let clientRetry: any = null;\n                try { clientRetry = await apiClient.findCustomerByPhone(fromNorm); } catch (e) { /* ignore */ }\n                if (!clientRetry) {\n                  try { clientRetry = await apiClient.upsertCustomer({ phone: fromNorm, name: fromUser }); } catch (e) { /* ignore */ }\n                }\n                const amountRetry = monthlyAmount ? monthlyAmount * asNum : 0;\n                const paymentPayloadRetry: any = {\n                  client_id: clientRetry && clientRetry.id ? clientRetry.id : undefined,\n                  amount: amountRetry,\n                  currency: 'CRC',\n                  channel: 'whatsapp',\n                  status: 'unverified',\n                  reference: payload.backendReceiptId ? `receipt:${payload.backendReceiptId}` : `bot:${payload.receiptId}`,\n                  metadata: { months: asNum, backend_receipt_id: payload.backendReceiptId }\n                };\n                const retryRes = await apiClient.createPayment(paymentPayloadRetry);\n                await updateReceiptEntry(payload.receiptId, { status: 'applied', backend_apply_result: retryRes, backend_payment_id: retryRes && (retryRes.id || retryRes.payment_id) ? (retryRes.id ?? retryRes.payment_id) : null, monthly_amount: monthlyAmount, total_amount: amountRetry });\n                // notify admin about successful retry\n                try {\n                  const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n                  const adminChatId = normalizeToChatId(adminPhone);\n                  if (adminChatId) {\n                    const txt = `Reintento exitoso: aplicados ${asNum} mes(es) para el comprobante ${payload.receiptId} del cliente ${fromUser} (${chatId}).`;\n                    await whatsappClient.sendText(adminChatId, txt);\n                  }\n                } catch (e2: any) {\n                  logger.debug({ e2 }, 'No se pudo notificar al admin tras reintento exitoso');\n                }\n              } catch (e2: any) {\n                logger.warn({ e2, chatId }, 'Reintento fallido aplicando meses');\n                try { await updateReceiptEntry(payload.receiptId, { status: 'apply_failed', apply_error_retry: String(e2 && e2.message ? e2.message : e2) }); } catch (ee) { /* ignore */ }\n              }\n            }, retryDelayMs);\n          } catch (ee) {\n            logger.debug({ ee }, 'No se pudo programar reintento');\n          }\n\n          return;\n        }\n      } else {\n        await message.reply('Por favor responde con un número entero de meses (ej: 1). Escribe \"salir\" para cancelar.');\n        return;\n      }\n    }\n\n    // Nota: el comando `adminmenu` para admins se maneja arriba con un atajo temprano\n    // (para evitar waits de backend en modo polling fallback). No duplicar aquí.\n\n    // If admin menu is active, process numeric selections\n    if (isAdminUser && menuShown.get(chatId) && lastMenuItems.get(chatId)?.[0]?.type === 'admin_menu') {\n      const selection = (body || '').trim().replace(/\\s+/g, '');\n      \n      if (selection === '1') {\n        // Crear cliente + suscripción\n        adminFlows.set(chatId, { type: 'create_subscription', step: 1, data: {} });\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Asistente: Crear cliente + suscripción.\\nTeléfono del cliente (8 dígitos o con código de país). Escribe \"yo\" para usar tu número.');\n        return;\n      }\n      \n      if (selection === '2') {\n        // Ver detalles de cliente\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el teléfono del cliente (8 dígitos) o escribe \"yo\" para ver tus detalles:');\n        adminFlows.set(chatId, { type: 'view_details', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '3') {\n        // Ver mis detalles (ejecutar inmediatamente)\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        try {\n          const phone = fromUser;\n          const client = await apiClient.findCustomerByPhone(phone);\n          \n          if (!client) {\n            await message.reply(`📇 *Tus Detalles*\\n\\n❌ No estás registrado como cliente.\\n\\nEscribe *adminmenu* para volver`);\n            return;\n          }\n          \n          const contracts = await apiClient.listContracts({ client_id: client.id });\n          const lines: string[] = [];\n          lines.push(`📇 *Tus Detalles*`);\n          lines.push(`👤 ${client.name || phone}`);\n          lines.push(`📱 ${client.phone}`);\n          lines.push('');\n          \n          if (contracts && contracts.length) {\n            lines.push(`💼 *Contratos*: ${contracts.length}`);\n            contracts.slice(0, 3).forEach((c: any) => {\n              lines.push(`  • ${c.name || 'Sin nombre'}`);\n              lines.push(`    ₡${Number(c.amount || 0).toLocaleString('es-CR')} ${c.currency || 'CRC'}`);\n              lines.push(`    Ciclo: ${c.billing_cycle || 'N/A'}`);\n              if (c.next_due_date) lines.push(`    Próximo: ${c.next_due_date.split('T')[0]}`);\n            });\n            if (contracts.length > 3) lines.push(`  ...y ${contracts.length - 3} más`);\n          } else {\n            lines.push('💼 Sin contratos activos');\n          }\n          \n          lines.push('');\n          lines.push('Escribe *adminmenu* para volver al menú admin');\n          await message.reply(lines.join('\\n'));\n        } catch (e: any) {\n          logger.error({ e, phone: fromUser }, 'Error consultando mis detalles');\n          await message.reply(`❌ Error consultando detalles: ${String(e && e.message ? e.message : e)}`);\n        }\n        return;\n      }\n\n  if (selection === '16') {\n        // Pausar / reanudar contacto (silenciar bot)\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        adminFlows.set(chatId, { type: 'pause_contact', step: 1, data: {} });\n        await message.reply([\n          'Pausar/Reanudar contacto (silenciar bot).',\n          '',\n          '1) Enviame el teléfono del cliente (8 dígitos CR o con código de país, ej: 5067xxxxxxx).',\n          'También puedes escribir \"yo\" para usar tu número.'\n        ].join('\\n'));\n        return;\n      }\n\n      if (selection === '17') {\n        // Limpiar chats no-clientes\n  menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        adminFlows.set(chatId, { type: 'cleanup_chats', step: 1, data: { dryRun: true, includeUnread: false } });\n        await message.reply([\n          '🧹 Limpieza de chats (no-clientes)',\n          '',\n          'Esto revisa los chats del WhatsApp del BOT y limpia/archiva chats que NO sean clientes.',\n          'Por seguridad primero corre en modo simulación (dry-run).',\n          '',\n          'Selecciona una opción:',\n          '1) Simular (dry-run) y mostrar resumen',\n          '2) Ejecutar limpieza REAL (requiere confirmación)',\n          '3) Configurar: incluir chats con NO LEÍDOS (por defecto NO)',\n          '4) Configurar: incluir GRUPOS (por defecto NO)',\n          '',\n          'Escribe *adminmenu* para volver'\n        ].join('\\n'));\n        return;\n      }\n      \n      if (selection === '4') {\n        // Listar comprobantes del día\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        try {\n          const today = new Date().toISOString().split('T')[0];\n          const receipts = await apiClient.listReceiptsByDate(today);\n          if (!receipts || receipts.length === 0) {\n            await message.reply('📄 No hay comprobantes generados hoy.\\n\\nEscribe *adminmenu* para volver');\n            return;\n          }\n          const lines: string[] = [];\n          lines.push(`📄 *Comprobantes de hoy* (${receipts.length})`, '');\n          receipts.forEach((r: any, idx: number) => {\n            const status = r.sent_at ? '✅ Enviado' : '📤 Pendiente';\n            const time = new Date(r.created_at).toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });\n            lines.push(`*${idx + 1}.* ID: ${r.id} | ${status}`);\n            lines.push(`   Cliente: ${r.customer_name || r.customer_phone}`);\n            lines.push(`   Hora: ${time}`);\n            lines.push('');\n          });\n          lines.push('Escribe *adminmenu* para volver al menú admin');\n          await message.reply(lines.join('\\n'));\n        } catch (e: any) {\n          await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n        }\n        return;\n      }\n      \n      if (selection === '5') {\n        // Generar comprobante para cliente\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el teléfono del cliente para generar el comprobante (8 dígitos):');\n        adminFlows.set(chatId, { type: 'generate_receipt', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '6') {\n        // Enviar comprobante por ID\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el ID del comprobante a enviar:');\n        adminFlows.set(chatId, { type: 'send_receipt', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '7') {\n        // Listar transacciones\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el teléfono del cliente para filtrar transacciones, o presiona Enter para ver todas (últimas 20):');\n        adminFlows.set(chatId, { type: 'list_transactions', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '8') {\n        // Ejecutar scheduler\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        try {\n          await processor.runBatch();\n          await message.reply('✅ Scheduler ejecutado (runBatch).\\n\\nEscribe *adminmenu* para volver');\n        } catch (e) {\n          await message.reply('❌ Error ejecutando scheduler: ' + String(e));\n        }\n        return;\n      }\n      \n      if (selection === '9') {\n        // Registrar pago manual\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('📝 *Registrar Pago Manual*\\n\\nIngresa el teléfono del cliente (8 dígitos):');\n        adminFlows.set(chatId, { type: 'create_payment', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '10') {\n        // Conciliar pago\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('🔄 *Conciliar Pago*\\n\\nIngresa el ID del pago a conciliar:');\n        adminFlows.set(chatId, { type: 'conciliate_payment', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '11') {\n        // Listar pagos pendientes\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        try {\n          const payments = await apiClient.listPayments({ status: ['pending', 'unverified'], per_page: 20 });\n          if (!payments || payments.length === 0) {\n            await message.reply('📭 No hay pagos pendientes.\\n\\nEscribe *adminmenu* para volver');\n            return;\n          }\n          const lines: string[] = [];\n          lines.push(`💰 *Pagos Pendientes* (${payments.length})`, '');\n          for (const [idx, p] of payments.entries()) {\n            lines.push(`*${idx + 1}.* ID: ${p.id}`);\n            lines.push(`   💵 ₡${Number(p.amount || 0).toLocaleString('es-CR')} ${p.currency || 'CRC'}`);\n            lines.push(`   👤 ${p.client?.name || p.client_id || 'Sin cliente'}`);\n            lines.push(`   📋 Estado: ${p.status}`);\n            if (p.reference) lines.push(`   🔖 Ref: ${p.reference}`);\n            lines.push('');\n          }\n          lines.push('Escribe *adminmenu* para volver');\n          await message.reply(lines.join('\\n'));\n        } catch (e: any) {\n          await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`);\n        }\n        return;\n      }\n      \n      if (selection === '12') {\n        // Eliminar cliente\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el teléfono del cliente a ELIMINAR (8 dígitos o con código de país):');\n        adminFlows.set(chatId, { type: 'delete_customer', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '13') {\n        // Eliminar contrato\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el teléfono del cliente para eliminar sus contratos (8 dígitos):');\n        adminFlows.set(chatId, { type: 'delete_contracts_by_phone', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '14') {\n        // Eliminar transacción\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        await message.reply('Ingresa el ID de la transacción a eliminar:');\n        adminFlows.set(chatId, { type: 'delete_transaction_input', step: 1, data: {} });\n        return;\n      }\n      \n      if (selection === '15') {\n        // Estado del bot\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        try {\n          const uptime = process.uptime();\n          const hours = Math.floor(uptime / 3600);\n          const minutes = Math.floor((uptime % 3600) / 60);\n          const statusText = [\n            '🤖 *Estado del Bot*',\n            '',\n            `⏱️ Uptime: ${hours}h ${minutes}m`,\n            `📊 Memoria: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`,\n            `🌐 Node: ${process.version}`,\n            `⚙️ Timezone: ${TIMEZONE}`,\n            `🕐 Horario: ${formatBusinessHours()}`,\n            '',\n            'Escribe *adminmenu* para volver'\n          ].join('\\n');\n          await message.reply(statusText);\n        } catch (e: any) {\n          await message.reply(`Error obteniendo estado: ${String(e && e.message ? e.message : e)}`);\n        }\n        return;\n      }\n      \n      // Opción no reconocida en menú admin\n      await message.reply('Opción no reconocida. Escribe *adminmenu* para ver el menú o *help para ver comandos de texto.');\n      menuShown.delete(chatId);\n      lastMenuItems.delete(chatId);\n      return;\n    }\n\n    // Procesar comandos admin simples (prefijo '*')\n    if (isAdminUser && lc.startsWith('*')) {\n      const cmd = lc.slice(1).trim();\n      if (cmd === 'help' || cmd === 'ayuda') {\n        const helpText = [\n          '🔧 *Comandos admin disponibles:*',\n          '',\n          '*adminmenu* — menú interactivo admin',\n          '*ping* — healthcheck',\n          '*status* — estado del bot',\n          '*cancelar* — cancelar asistente admin',\n          '*runscheduler* — ejecutar procesamiento de recordatorios (batch)',\n          '*nuevo* — crear cliente + suscripción (asistente)',\n          '*detalles <telefono>* — ver cliente y sus suscripciones',\n          '*yo* — ver mis propios detalles',\n          '*comprobantes* — listar comprobantes del día',\n          '*comprobante <telefono>* — generar y enviar comprobante',\n          '*enviar <id>* — enviar comprobante por ID',\n          '*transacciones* — listar transacciones',\n          '*eliminar cliente <telefono>* — eliminar cliente',\n          '*eliminar suscripcion <telefono>* — eliminar suscripciones por teléfono',\n          '*eliminar trans <id>* — eliminar transacción por ID',\n        ].join('\\n');\n        await message.reply(helpText);\n        return;\n      }\n      if (cmd === 'cancelar' || cmd === 'cancel') {\n        if (adminFlows.has(chatId)) {\n          adminFlows.delete(chatId);\n          await message.reply('Asistente admin cancelado.');\n        } else {\n          await message.reply('No hay asistente admin en curso.');\n        }\n        return;\n      }\n      if (cmd === 'ping') { await message.reply('pong'); return; }\n      if (cmd === 'runscheduler' || cmd === 'run') { try { await processor.runBatch(); await message.reply('Scheduler ejecutado (runBatch).'); } catch (e) { await message.reply('Error ejecutando scheduler: ' + String(e)); } return; }\n\n      // *nuevo -> iniciar asistente de creación\n      if (cmd === 'nuevo' || cmd === 'crear' || cmd === 'add') {\n        adminFlows.set(chatId, { type: 'create_subscription', step: 1, data: {} });\n        await message.reply('Asistente: Crear cliente + suscripción.\\nTeléfono del cliente (8 dígitos o con código de país). Escribe \"yo\" para usar tu número.');\n        return;\n      }\n\n      // eliminar cliente\n      if (cmd.startsWith('eliminar cliente')) {\n        const parts = cmd.split(/\\s+/);\n        const p0 = parts[2] ? normalizeCR(parts[2]) : '';\n        adminFlows.set(chatId, { type: 'delete_customer', step: 1, data: {} });\n        const p = p0 && /^\\d{8,15}$/.test(p0) ? (p0.length === 8 ? (config.defaultCountryCode || '506') + p0 : p0) : '';\n        if (!p) { await message.reply('Ingresa el teléfono del cliente a ELIMINAR (8 dígitos o con código de país). Puedes escribir \"yo\".'); return; }\n        try {\n          const flow = adminFlows.get(chatId);\n          flow.data.phone = p;\n          const cust = await apiClient.findCustomerByPhone(p);\n          if (!cust) { adminFlows.delete(chatId); await message.reply('No existe un cliente con ese teléfono.'); return; }\n          flow.data.customer_id = cust.id;\n          flow.step = 2;\n          await message.reply(`Vas a ELIMINAR al cliente ${cust.name || cust.phone} y TODO su historial (pagos, recordatorios y suscripciones). Escribe CONFIRMAR para continuar o CANCELAR para abortar.`);\n        } catch (e: any) { adminFlows.delete(chatId); await message.reply(`Error preparando eliminación: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      // eliminar suscripcion\n      if (cmd.startsWith('eliminar suscripcion') || cmd.startsWith('eliminar suscripción')) {\n        const parts = cmd.split(/\\s+/);\n        const p0 = parts[2] ? normalizeCR(parts[2]) : '';\n        adminFlows.set(chatId, { type: 'delete_subscriptions_by_phone', step: 1, data: {} });\n        const p = p0 && /^\\d{8,15}$/.test(p0) ? (p0.length === 8 ? (config.defaultCountryCode || '506') + p0 : p0) : '';\n        if (!p) { await message.reply('Ingresa el teléfono del cliente para eliminar sus suscripciones (8 dígitos o con código de país). Puedes escribir \"yo\".'); return; }\n        try { const flow = adminFlows.get(chatId); flow.data.phone = p; flow.step = 2; await message.reply(`Vas a ELIMINAR las suscripciones de ${p} y los pagos FUTUROS asociados. Escribe CONFIRMAR para continuar o CANCELAR para abortar.`); } catch (e: any) { adminFlows.delete(chatId); await message.reply(`Error preparando eliminación: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      // detalles <phone>\n      if (cmd === 'yo') {\n        // atajo para ver detalles del propio admin\n        try {\n          const phone = fromUser;\n          const client = await apiClient.findCustomerByPhone(phone);\n          \n          if (!client) {\n            await message.reply(`📇 *Tus Detalles*\\n\\n❌ No estás registrado como cliente.`);\n            return;\n          }\n          \n          const contracts = await apiClient.listContracts({ client_id: client.id });\n          const lines: string[] = [];\n          lines.push(`📇 *Detalles de ${client.name || phone}*`);\n          lines.push(`📱 ${client.phone}`);\n          lines.push('');\n          \n          if (contracts && contracts.length) {\n            lines.push(`💼 *Contratos*: ${contracts.length}`);\n            contracts.slice(0, 3).forEach((c: any) => {\n              lines.push(`  • ${c.name || 'Sin nombre'}`);\n              lines.push(`    ₡${Number(c.amount || 0).toLocaleString('es-CR')} ${c.currency || 'CRC'}`);\n              if (c.next_due_date) lines.push(`    Próximo: ${c.next_due_date.split('T')[0]}`);\n            });\n            if (contracts.length > 3) lines.push(`  ...y ${contracts.length - 3} más`);\n          } else {\n            lines.push('💼 Sin contratos activos');\n          }\n          \n          await message.reply(lines.join('\\n'));\n        } catch (e: any) { \n          logger.error({ e, phone: fromUser }, 'Error en comando *yo');\n          await message.reply(`Error consultando detalles: ${String(e && e.message ? e.message : e)}`); \n        }\n        return;\n      }\n\n      if (cmd.startsWith('detalles')) {\n        try {\n          const parts = cmd.split(/\\s+/);\n          let phone = parts[1] ? parts[1].replace(/[^0-9]/g, '') : '';\n          if (!phone) phone = fromUser;\n          \n          const client = await apiClient.findCustomerByPhone(phone);\n          if (!client) {\n            await message.reply(`❌ No encontré un cliente con ese teléfono: ${phone}`);\n            return;\n          }\n          \n          const contracts = await apiClient.listContracts({ client_id: client.id });\n          const lines: string[] = [];\n          lines.push(`📇 *Detalles de ${client.name || phone}*`);\n          lines.push(`📱 ${client.phone}`);\n          lines.push('');\n          \n          if (contracts && contracts.length) {\n            lines.push(`💼 *Contratos*: ${contracts.length}`);\n            contracts.slice(0, 3).forEach((c: any) => {\n              lines.push(`  • ${c.name || 'Sin nombre'}`);\n              lines.push(`    ₡${Number(c.amount || 0).toLocaleString('es-CR')} ${c.currency || 'CRC'}`);\n              if (c.next_due_date) lines.push(`    Próximo: ${c.next_due_date.split('T')[0]}`);\n            });\n            if (contracts.length > 3) lines.push(`  ...y ${contracts.length - 3} más`);\n          } else {\n            lines.push('💼 Sin contratos activos');\n          }\n          \n          await message.reply(lines.join('\\n'));\n        } catch (e: any) { \n          logger.error({ e, phone: cmd.split(/\\s+/)[1] }, 'Error en comando *detalles');\n          await message.reply(`Error consultando detalles: ${String(e && e.message ? e.message : e)}`); \n        }\n        return;\n      }\n\n      // comprobantes\n      if (cmd === 'comprobantes') {\n        try {\n          const today = new Date().toISOString().split('T')[0];\n          const receipts = await apiClient.listReceiptsByDate(today);\n          if (!receipts || receipts.length === 0) { await message.reply('📄 No hay comprobantes generados hoy.'); return; }\n          const lines: string[] = [];\n          lines.push(`📄 *Comprobantes de hoy (${receipts.length})*`, '');\n          receipts.forEach((r: any, idx: number) => {\n            const status = r.sent_at ? '✅ Enviado' : '📤 Pendiente';\n            const time = new Date(r.created_at).toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });\n            lines.push(`*${idx + 1}.* ID: ${r.id} | ${status}`);\n            lines.push(`   Cliente: ${r.customer_name || r.customer_phone}`);\n            lines.push(`   Hora: ${time}`);\n            lines.push(`   Para enviar: *enviar ${r.id}*`);\n            lines.push('');\n          });\n          await message.reply(lines.join('\\n'));\n        } catch (e: any) { await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      if (cmd.startsWith('comprobante ')) {\n        try {\n          const parts = cmd.split(/\\s+/);\n          let phone = parts[1] ? normalizeCR(parts[1]) : '';\n          if (!phone || !/^\\d{8,15}$/.test(phone)) { await message.reply('❌ Teléfono inválido. Usa: *comprobante 87654321*'); return; }\n          if (phone.length === 8) phone = (config.defaultCountryCode || '506') + phone;\n          await message.reply('⏳ Generando comprobante...');\n          const res = await apiClient.createReceiptForClient({ phone });\n          if (res && res.receipt_id) {\n            await apiClient.sendReceipt(res.receipt_id);\n            await message.reply(`✅ Comprobante generado y enviado a ${phone}\\nID: ${res.receipt_id}`);\n          } else {\n            await message.reply('Error generando comprobante (respuesta inesperada del backend).');\n          }\n        } catch (e: any) { await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      if (cmd.startsWith('enviar ')) {\n        try {\n          const parts = cmd.split(/\\s+/);\n          const receiptId = parseInt(parts[1]);\n          if (isNaN(receiptId)) { await message.reply('❌ ID inválido. Usa: *enviar 123*'); return; }\n          await apiClient.sendReceipt(receiptId);\n          await message.reply(`✅ Comprobante ${receiptId} enviado (o solicitado envío).`);\n        } catch (e: any) { await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      // transacciones\n      if (cmd === 'transacciones' || cmd === 'trans' || cmd.startsWith('transacciones ') || cmd.startsWith('trans ')) {\n        try {\n          const parts = cmd.split(/\\s+/);\n          let filterPhone: string | undefined;\n          if (parts.length > 1) {\n            filterPhone = normalizeCR(parts[1]);\n            if (filterPhone.length === 8) filterPhone = (config.defaultCountryCode || '506') + filterPhone;\n          }\n          const transactions = await apiClient.listTransactions(filterPhone, 20);\n          if (!transactions || transactions.length === 0) { await message.reply(filterPhone ? `📭 No hay transacciones para ${filterPhone}` : '📭 No hay transacciones registradas'); return; }\n          const lines: string[] = [];\n          lines.push(filterPhone ? `💰 *Transacciones de ${filterPhone}* (${transactions.length})` : `💰 *Últimas transacciones* (${transactions.length})`, '');\n          for (const [idx, t] of transactions.entries()) {\n            lines.push(`*${idx + 1}.* ID: ${t.id}`);\n            lines.push(`   📅 ${t.created_at || t.txn_date}`);\n            lines.push(`   💵 ₡${Number(t.amount || 0).toLocaleString('es-CR')}`);\n            lines.push(`   📱 ${t.phone || 'N/A'}`);\n            lines.push(`   👤 ${t.client_name || '❓ Sin match'}`);\n            if (t.motivo) lines.push(`   📝 ${t.motivo}`);\n            if (t.ref) lines.push(`   🔖 Ref: ${String(t.ref).substring(0, 15)}...`);\n            lines.push('');\n          }\n          await message.reply(lines.join('\\n'));\n        } catch (e: any) { await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      if (cmd.startsWith('eliminar trans ')) {\n        try {\n          const parts = cmd.split(/\\s+/);\n          const txnId = parseInt(parts[2]);\n          if (isNaN(txnId)) { await message.reply('❌ ID inválido. Usa: *eliminar trans 123*'); return; }\n          // preguntar confirmación\n          await message.reply(`⚠️ ¿Eliminar transacción?\\n\\nID: ${txnId}\\n\\nResponde CONFIRMAR para continuar`);\n          adminFlows.set(chatId, { type: 'delete_transaction', step: 1, data: { txnId } });\n        } catch (e: any) { await message.reply(`❌ Error: ${String(e && e.message ? e.message : e)}`); }\n        return;\n      }\n\n      // Si hay prefijo * pero no coincide, responder ayuda\n      await message.reply('Comando admin no reconocido. Escribe *help para ver los comandos disponibles.');\n      return;\n    }\n\n    // simple health check\n    if (lc === 'ping') {\n      await message.reply('pong');\n      return;\n    }\n\n    // Handle payment status query\n    if (lc === 'pagos' || lc === 'estado') {\n      try {\n        const paymentStatus = await apiClient.getPaymentStatus(fromNorm);\n        if (!paymentStatus || !paymentStatus.success) {\n          await message.reply('❌ No encontramos información sobre tu cuenta. Por favor contáctanos directamente.');\n          return;\n        }\n\n        const { client, summary, payments } = paymentStatus;\n        const lines: string[] = [];\n        lines.push(`📊 *Estado de Pagos*`);\n        lines.push(`👤 ${client.name}`);\n        lines.push(`📱 ${client.phone}`);\n        lines.push('');\n        lines.push(`📈 *Resumen:*`);\n        lines.push(`  • Total de pagos: ${summary.total_payments}`);\n        lines.push(`  • Completados: ${summary.completed}`);\n        lines.push(`  • Pendientes: ${summary.pending}`);\n        \n        if (payments && payments.length > 0) {\n          lines.push('');\n          lines.push(`📋 *Últimos pagos:*`);\n          payments.slice(0, 5).forEach((p: any, idx: number) => {\n            const date = p.paid_at ? p.paid_at.split('T')[0] : '❓ Sin fecha';\n            const status = p.status === 'completed' ? '✅' : p.status === 'pending' ? '⏳' : '❌';\n            lines.push(`${idx + 1}. ${status} ₡${Number(p.amount).toLocaleString('es-CR')} ${p.currency} (${date})`);\n          });\n          if (payments.length > 5) {\n            lines.push(`...y ${payments.length - 5} pagos más`);\n          }\n        }\n\n        lines.push('');\n        lines.push('Para más información contáctanos o escribe \"menu\" para volver al menú principal.');\n        await message.reply(lines.join('\\n'));\n      } catch (error: any) {\n        logger.error({ err: error, fromNorm }, 'Error consultando estado de pagos');\n        await message.reply('❌ No pudimos obtener tu información de pagos. Intenta más tarde o contáctanos directamente.');\n      }\n      return;\n    }\n\n    // Handle explicit exit command: clear any pending menu or agent mode\n    if (lc === 'salir' || lc === 'exit') {\n      const wasAgent = !!agentMode.get(chatId);\n      menuShown.delete(chatId);\n      lastMenuItems.delete(chatId);\n      agentMode.delete(chatId);\n      // reset any per-chat timeout to default\n      chatTimeoutMs.delete(chatId);\n      clearTimer(chatId);\n      if (wasAgent) {\n        await message.reply('Has salido del modo agente. Si deseas volver a ver las opciones escribe \"menu\".');\n      } else {\n        await message.reply('Has salido del menú. Si deseas volver a ver las opciones escribe \"menu\".');\n      }\n      return;\n    }\n\n    // If user asks for menu, display and mark menu active for this chat\n    if (lc === 'menu' || lc === 'inicio' || lc === 'help') {\n      try {\n        const menuToUse = await resolveMenu();\n        if (!menuToUse || !Array.isArray(menuToUse) || menuToUse.length === 0) {\n          await message.reply('Lo siento, el menú no está disponible en este momento. Intenta más tarde.');\n          return;\n        }\n\n        const lines: string[] = [];\n        lines.push('Hola! Bienvenido a nuestro 🤖 CHATBOT');\n        lines.push('Somos Tecno Servicios Artavia, por favor envía el número de una de las siguientes opciones:');\n        lines.push('');\n        menuToUse.forEach((item) => {\n          const label = (item.reply_message ?? '').split('\\n')[0] || '';\n          lines.push(`${item.keyword} - ${label}`);\n        });\n        lines.push('');\n        lines.push('Escribe \"menu\" para volver al inicio o \"salir\" para finalizar la conversación.');\n\n        await message.reply(lines.join('\\n'));\n        menuShown.set(chatId, true);\n        lastMenuItems.set(chatId, menuToUse);\n        return;\n      } catch (error) {\n        logger.error({ err: error }, 'No se pudo resolver el menú');\n        await message.reply('Lo siento, el menú no está disponible en este momento. Intenta más tarde.');\n        return;\n      }\n    }\n\n    // Handle explicit \"agente\" request to transfer to human support\n    if (lc === 'agente' || lc === 'asesor' || lc === 'soporte') {\n      const isOutsideHours = !_isWithinBusinessHours();\n      \n      if (isOutsideHours) {\n        await message.reply(`⏰ Actualmente estamos fuera del horario de atención.\\n\\nNuestro horario: ${formatBusinessHours()}\\n\\n✅ He registrado tu solicitud y un asesor te contactará cuando inicie el horario de atención.\\n\\n💡 Mientras tanto, puedes usar el menú (escribe \"menu\") para acceder a opciones automáticas disponibles 24/7.`);\n      } else {\n        await message.reply('Perfecto, te estoy conectando con un asesor. Un miembro de nuestro equipo te atenderá en breve. Por favor espera un momento.');\n      }\n      \n      // Activate agent mode\n      agentMode.set(chatId, true);\n      chatTimeoutMs.set(chatId, _AGENT_TIMEOUT_MS);\n      try { touchTimer(chatId); } catch (e) { /* ignore */ }\n      menuShown.delete(chatId);\n      lastMenuItems.delete(chatId);\n      logger.info({ chatId, trigger: lc }, 'Chat puesto en modo agente (palabra clave)');\n\n      // Notify admin\n      try {\n        const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n        const adminChatId = normalizeToChatId(adminPhone);\n        const now = Date.now();\n        const lastNotified = adminNotifiedAt.get(chatId) || 0;\n        if (adminChatId && (now - lastNotified > AGENT_NOTIFY_THROTTLE_MS)) {\n          const isOutsideHours = !_isWithinBusinessHours();\n          const offHoursPrefix = isOutsideHours ? '⚠️ FUERA DE HORARIO - ' : '';\n          const offHoursSuffix = isOutsideHours ? `\\n\\n⏰ Nota: Esta solicitud se realizó FUERA del horario de atención (${formatBusinessHours()}). El cliente será atendido cuando inicien las operaciones.` : '';\n          const notifyText = `${offHoursPrefix}🔔 Cliente ${fromUser} (${chatId}) solicitó hablar con un agente.\\n\\nÚltimo mensaje: \"${String(body).slice(0, 200)}\"${offHoursSuffix}\\n\\nPor favor responde directamente a este chat para atender al cliente.`;\n          await whatsappClient.sendText(adminChatId, notifyText);\n          adminNotifiedAt.set(chatId, now);\n          logger.info({ adminChatId, chatId, outsideHours: isOutsideHours }, 'Admin notificado sobre solicitud de agente (palabra clave)');\n        } else {\n          logger.debug({ chatId, lastNotified }, 'Omitida notificación admin por throttle (palabra clave)');\n        }\n      } catch (e: any) {\n        logger.warn({ e }, 'No se pudo notificar al admin sobre solicitud de agente (palabra clave)');\n      }\n      return;\n    }\n\n    // If menu is active for this chat (awaiting selection), treat the incoming message as a menu selection\n    if (menuShown.get(chatId)) {\n      try {\n        const menu = lastMenuItems.get(chatId) ?? (await resolveMenu());\n\n        let matched = null;\n\n        // allow numeric selection (1-based index)\n        const asNum = parseInt(body, 10);\n        if (!Number.isNaN(asNum) && Array.isArray(menu) && asNum >= 1 && asNum <= menu.length) {\n          matched = menu[asNum - 1];\n        } else {\n          // support two types of menu arrays:\n          // - main menu items with .keyword\n          // - submenu items with .key (a/b/c)\n          if (Array.isArray(menu) && menu.length && (menu[0].key || menu[0].keyword)) {\n            matched = menu.find((m: any) => {\n              if (m.keyword) return (m.keyword.toLowerCase() === lc || m.keyword === body);\n              if (m.key) return (String(m.key).toLowerCase() === lc || String(m.key) === body);\n              return false;\n            });\n          } else {\n            matched = null;\n          }\n        }\n\n        if (matched) {\n          // If the matched item has a submenu, present it and keep menu active\n          if (matched.submenu && Array.isArray(matched.submenu) && matched.submenu.length) {\n            await message.reply(matched.reply_message);\n            // store submenu entries for the chat (expect letter like a/b/c)\n            lastMenuItems.set(chatId, matched.submenu.map((s: any) => ({ key: (s.key || s.key_text || '').toString().toLowerCase(), text: s.text || s.reply_message || '' })));\n            menuShown.set(chatId, true);\n            return;\n          }\n\n          // Regular selection: reply. If this option transfers to an agent, activate agent mode and PAUSE the bot.\n          const replyText = matched.reply_message || matched.text || matched.response || '';\n\n          // Special-case: if the selected option is numeric 5 (o keyword/key '5'),\n          // instruct the user to contact an agent and put the chat into agent mode.\n          const isOptionFive = (typeof asNum === 'number' && asNum === 5)\n            || (matched.keyword && String(matched.keyword).trim() === '5')\n            || (matched.key && String(matched.key).trim() === '5');\n\n          if (isOptionFive) {\n            const isOutsideHours = !_isWithinBusinessHours();\n            \n            let agentMsg = '';\n            if (isOutsideHours) {\n              agentMsg = `⏰ Actualmente estamos fuera del horario de atención.\\n\\nNuestro horario: ${formatBusinessHours()}\\n\\n✅ He registrado tu solicitud y un asesor te contactará cuando inicie el horario de atención.\\n\\n💡 Mientras tanto, puedes usar el menú (escribe \"menu\") para acceder a opciones automáticas disponibles 24/7.`;\n            } else {\n              agentMsg = 'Para hablar con un asesor, por favor comunícate con nuestro equipo de soporte o escribe \"agente\" para que te transferamos. Un asesor te contactará a la brevedad.';\n            }\n            \n            await message.reply(agentMsg);\n\n            // Activate agent mode and notify admin just like the generic agent transfer flow\n            agentMode.set(chatId, true);\n            chatTimeoutMs.set(chatId, _AGENT_TIMEOUT_MS);\n            try { touchTimer(chatId); } catch (e) { /* ignore */ }\n            menuShown.delete(chatId);\n            lastMenuItems.delete(chatId);\n            logger.info({ chatId }, 'Chat puesto en modo agente (opción 5)');\n\n            try {\n              const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n              const adminChatId = normalizeToChatId(adminPhone);\n              const now = Date.now();\n              const lastNotified = adminNotifiedAt.get(chatId) || 0;\n              if (adminChatId && (now - lastNotified > AGENT_NOTIFY_THROTTLE_MS)) {\n                const isOutsideHours = !_isWithinBusinessHours();\n                const offHoursPrefix = isOutsideHours ? '⚠️ FUERA DE HORARIO - ' : '';\n                const offHoursSuffix = isOutsideHours ? `\\n\\n⏰ Nota: Esta solicitud se realizó FUERA del horario de atención (${formatBusinessHours()}). El cliente será atendido cuando inicien las operaciones.` : '';\n                const notifyText = `${offHoursPrefix}Cliente ${fromUser} (${chatId}) solicita atención de un asesor (opción 5). Mensaje: \"${String(body).slice(0,200)}\"${offHoursSuffix}`;\n                await whatsappClient.sendText(adminChatId, notifyText);\n                adminNotifiedAt.set(chatId, now);\n                logger.info({ adminChatId, chatId, outsideHours: isOutsideHours }, 'Admin notificado sobre solicitud de agente (opción 5)');\n              } else {\n                logger.debug({ chatId, lastNotified, throttleMs: AGENT_NOTIFY_THROTTLE_MS }, 'Omitida notificación admin por throttle (opción 5)');\n              }\n            } catch (e: any) {\n              logger.warn({ e }, 'No se pudo notificar al admin sobre la solicitud de agente (opción 5)');\n            }\n\n            return;\n          }\n\n          // Special case: option 8 - Account statement / Estado de cuenta\n          const isOptionEight = (typeof asNum === 'number' && asNum === 8)\n            || (matched.keyword && String(matched.keyword).trim() === '8')\n            || (matched.key && String(matched.key).trim() === '8');\n\n          if (isOptionEight) {\n            try {\n              // Mensaje corto inmediato para que el usuario sepa que estamos trabajando.\n              // Importante: NO dependemos del reply_message almacenado en BD (que hoy dice \"Consultando...\")\n              // porque si el flujo falla quedaría la sensación de que se quedó pegado.\n              await message.reply('🔍 Consultando tu información, un momento por favor...');\n\n              // Get client by phone\n              const client = await apiClient.findCustomerByPhone(fromUser);\n              \n              if (!client || !client.id) {\n                await message.reply('❌ No encontramos tu información en nuestro sistema. Por favor contacta con un asesor escribiendo \"agente\".');\n                return;\n              }\n\n              // Get client's contracts\n              const contracts = await apiClient.listContracts({ client_id: client.id });\n              \n              if (!contracts || contracts.length === 0) {\n                await message.reply('ℹ️ No tienes contratos activos en este momento.\\n\\nPara más información, escribe \"agente\" para hablar con un asesor.');\n                return;\n              }\n\n              // Build account statement message\n              const lines: string[] = [];\n              lines.push('📊 *ESTADO DE CUENTA*');\n              lines.push('');\n              lines.push(`👤 Cliente: ${client.name || 'N/A'}`);\n              lines.push(`📱 Teléfono: ${client.phone || fromUser}`);\n              lines.push('');\n              lines.push('📋 *Tus Contratos:*');\n              lines.push('');\n\n              for (const contract of contracts) {\n                const status = contract.status === 'active' ? '✅ Activo' : \n                              contract.status === 'paused' ? '⏸️ Pausado' : \n                              contract.status === 'cancelled' ? '❌ Cancelado' : \n                              '⚪ ' + (contract.status || 'Desconocido');\n                \n                lines.push(`🔹 *Contrato #${contract.id}*`);\n                lines.push(`   Servicio: ${contract.service_description || contract.contract_type?.name || 'N/A'}`);\n                lines.push(`   Estado: ${status}`);\n                lines.push(`   Monto: ${contract.currency || 'CRC'} ${Number(contract.amount || 0).toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);\n                \n                if (contract.next_due_date) {\n                  const dueDate = new Date(contract.next_due_date);\n                  const today = new Date();\n                  const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n                  \n                  if (diffDays < 0) {\n                    lines.push(`   ⚠️ Próximo pago: VENCIDO (${Math.abs(diffDays)} días de retraso)`);\n                  } else if (diffDays === 0) {\n                    lines.push(`   ⚠️ Próximo pago: HOY`);\n                  } else if (diffDays <= 7) {\n                    lines.push(`   ⏰ Próximo pago: En ${diffDays} día${diffDays !== 1 ? 's' : ''}`);\n                  } else {\n                    lines.push(`   📅 Próximo pago: ${dueDate.toLocaleDateString('es-CR')}`);\n                  }\n                }\n                \n                if (contract.notes && contract.notes.trim().length > 0) {\n                  lines.push(`   📝 Nota: ${contract.notes.substring(0, 100)}${contract.notes.length > 100 ? '...' : ''}`);\n                }\n                \n                lines.push('');\n              }\n\n              lines.push('━━━━━━━━━━━━━━━━━');\n              lines.push('');\n              lines.push('💡 *Opciones:*');\n              lines.push('• Escribe *6* para enviar comprobante de pago');\n              lines.push('• Escribe *menu* para volver al menú principal');\n              lines.push('• Escribe *agente* para hablar con un asesor');\n\n              await message.reply(lines.join('\\n'));\n              \n              logger.info({ chatId, clientId: client.id, contractsCount: contracts.length }, 'Estado de cuenta enviado');\n              return;\n            } catch (error: any) {\n              logger.error({ err: error, chatId }, 'Error obteniendo estado de cuenta');\n              await message.reply('❌ Ocurrió un error al obtener tu estado de cuenta. Por favor intenta más tarde o escribe \"agente\" para hablar con un asesor.');\n              return;\n            }\n          }\n\n          await message.reply(replyText);\n\n          // Heurística para detectar acciones especiales en el reply\n          const lower = String(replyText || '').toLowerCase();\n          // If this option expects a payment receipt (ej: opción 6), enter awaitingReceipt mode\n          const isAwaitingReceipt = (matched.keyword && String(matched.keyword).toLowerCase() === '6') || (matched.key && String(matched.key).toLowerCase() === '6') || /comprobante|recibo|pago|comprobante de pago|enviar comprobante/i.test(lower);\n          if (isAwaitingReceipt) {\n            awaitingReceipt.set(chatId, true);\n            // keep short timeout for receipt upload\n            chatTimeoutMs.set(chatId, BOT_TIMEOUT_MS);\n            try { touchTimer(chatId); } catch (e) { /* ignore */ }\n            await message.reply('Por favor adjunta una foto o PDF del comprobante ahora. Si deseas cancelar escribe \"salir\".');\n            return;\n          }\n\n          // Heurística para detectar transferencia a agente (si el reply contiene palabras clave)\n          const isAgentTransfer = /transfer|asesor|agente|asesores|te vamos a transferir|transferir|transferencia/i.test(lower);\n          if (isAgentTransfer) {\n            agentMode.set(chatId, true);\n            // set a longer timeout so agent mode will expire after agent timeout\n            chatTimeoutMs.set(chatId, _AGENT_TIMEOUT_MS);\n            try { touchTimer(chatId); } catch (e) { logger.debug({ e }, 'touchTimer fallo al activar agentMode'); }\n            // clear menu state but keep agentMode active\n            menuShown.delete(chatId);\n            lastMenuItems.delete(chatId);\n            logger.info({ chatId }, 'Chat puesto en modo agente');\n\n            // Notify admin (first configured admin phone) that a client awaits an agent, with throttle\n            try {\n              const adminPhone = Array.isArray(ADMIN_PHONES) && ADMIN_PHONES.length ? ADMIN_PHONES[0] : '50672140974';\n              const adminChatId = normalizeToChatId(adminPhone);\n              const now = Date.now();\n              const lastNotified = adminNotifiedAt.get(chatId) || 0;\n              if (adminChatId && (now - lastNotified > AGENT_NOTIFY_THROTTLE_MS)) {\n                const isOutsideHours = !_isWithinBusinessHours();\n                const offHoursPrefix = isOutsideHours ? '⚠️ FUERA DE HORARIO - ' : '';\n                const offHoursSuffix = isOutsideHours ? `\\n\\n⏰ Nota: Esta solicitud se realizó FUERA del horario de atención (${formatBusinessHours()}). El cliente será atendido cuando inicien las operaciones.` : '';\n                const notifyText = `${offHoursPrefix}Cliente ${fromUser} (${chatId}) solicita atención de un asesor. Mensaje: \"${String(body).slice(0, 200)}\"${offHoursSuffix}`;\n                await whatsappClient.sendText(adminChatId, notifyText);\n                adminNotifiedAt.set(chatId, now);\n                logger.info({ adminChatId, chatId, outsideHours: isOutsideHours }, 'Admin notificado sobre solicitud de agente');\n              } else {\n                logger.debug({ chatId, lastNotified, throttleMs: AGENT_NOTIFY_THROTTLE_MS }, 'Omitida notificación admin por throttle');\n              }\n            } catch (e: any) {\n              logger.warn({ e }, 'No se pudo notificar al admin sobre la solicitud de agente');\n            }\n\n            return;\n          }\n\n          // otherwise behave normally: clear shown state so next message will show menu again\n          menuShown.delete(chatId);\n          lastMenuItems.delete(chatId);\n          return;\n        }\n\n        // not a valid option while menu active: reply and clear shown state so next message will show menu again\n        await send('No reconozco esa opción. Por favor elige un número del menú o escribe \"menu\" para volver a ver las opciones o \"salir\" para finalizar.');\n        menuShown.delete(chatId);\n        lastMenuItems.delete(chatId);\n        return;\n      } catch (error) {\n        logger.error({ err: error }, 'Error manejando opción de menú');\n        return;\n      }\n    }\n\n\n    // Menu not active (idle): by default DO NOT spam the menu.\n    // Only show the full menu when the user explicitly asks for it (handled above via lc === 'menu'|'inicio'|'help'),\n    // or when we are already in menuShown state.\n    try {\n      // If chat is in agent mode, do not show the menu (agent handles conversation)\n      if (agentMode.get(chatId)) {\n        logger.debug({ chatId }, 'Ignorando mensaje: chat en modo agente, no mostrar menú');\n        return;\n      }\n\n      // Para admins: no mostrar el menú normal automáticamente.\n      // El admin debe invocar explícitamente `adminmenu` para ver su menú.\n      if (isAdminUser) {\n        logger.debug({ chatId }, 'Admin: no mostrar menú normal automáticamente');\n        return;\n      }\n\n      // Si el usuario no pidió explícitamente el menú y no está en un proceso,\n      // no enviamos el menú automáticamente para evitar que vuelva a aparecer tras una respuesta válida.\n      // (En modo polling fallback esto se siente como \"spam\".)\n      if (!(lc === 'menu' || lc === 'inicio' || lc === 'help')) {\n        logger.debug({ chatId, lc }, 'No mostrar menú automáticamente (usuario no lo pidió)');\n        return;\n      }\n      const menuToUse = await resolveMenu();\n      if (!menuToUse || !Array.isArray(menuToUse) || menuToUse.length === 0) {\n        await send('Lo siento, el menú no está disponible en este momento. Intenta más tarde.');\n        return;\n      }\n\n      const lines: string[] = [];\n      lines.push('Hola! Bienvenido a nuestro 🤖 CHATBOT');\n      lines.push('Somos Tecno Servicios Artavia, por favor envía el número de una de las siguientes opciones:');\n      lines.push('👇👇👇');\n      lines.push('');\n\n      // Build numbered list from menuToUse\n      let idx = 1;\n      for (const item of menuToUse) {\n        const label = (item.reply_message ?? '').split('\\n')[0] || 'Opción';\n        lines.push(`${idx}- ${label}`);\n        idx += 1;\n      }\n\n      lines.push('');\n      lines.push('Escribe menu para volver al inicio o salir para finalizar la conversación.');\n\n      await message.reply(lines.join('\\n'));\n      menuShown.set(chatId, true);\n      lastMenuItems.set(chatId, menuToUse);\n      // If the selected menu includes option '6' (Enviar comprobante), we will set awaitingReceipt when chosen; handled in menu selection branch\n      return;\n    } catch (error: any) {\n      logger.error({\n        errMsg: error?.message,\n        errStack: error?.stack,\n        error,\n      }, 'Error mostrando el menú');\n      try {\n        await message.reply('Lo siento, el menú no está disponible en este momento. Intenta más tarde.');\n      } catch (replyErr: any) {\n        logger.error({\n          errMsg: replyErr?.message,\n          errStack: replyErr?.stack,\n          replyErr,\n        }, 'No se pudo enviar mensaje de menú no disponible');\n      }\n      return;\n    }\n  });\n\n  // helper: save receipt file and index\n  async function ensureReceiptsDir() {\n    try { await fs.mkdir(RECEIPTS_DIR, { recursive: true }); } catch {}\n    try {\n      await fs.access(RECEIPTS_INDEX);\n    } catch {\n      await fs.writeFile(RECEIPTS_INDEX, JSON.stringify([]), { encoding: 'utf8' });\n    }\n  }\n\n  async function saveReceipt(chatId: string, filename: string, base64Data: string, mime: string, text?: string) {\n    await ensureReceiptsDir();\n    const now = Date.now();\n    const id = `${chatId.replace(/[^0-9]/g,'')}-${now}`;\n    const filepath = path.join(RECEIPTS_DIR, filename);\n    // save file (base64)\n    const buffer = Buffer.from(base64Data, 'base64');\n    await fs.writeFile(filepath, buffer);\n\n    // append to index (keep for backward compatibility)\n    const raw = await fs.readFile(RECEIPTS_INDEX, { encoding: 'utf8' });\n    const arr = JSON.parse(raw || '[]');\n    const entry = { id, chatId, filename, filepath, mime, text: text || '', ts: now, status: 'pending' } as any;\n    arr.push(entry);\n    await fs.writeFile(RECEIPTS_INDEX, JSON.stringify(arr, null, 2), { encoding: 'utf8' });\n\n    // Also save to database via API\n    try {\n      const phone = chatId.replace(/[^0-9]/g, '');\n      await apiClient.storeReceiptFromBot({\n        client_phone: phone,\n        file_path: filepath,\n        file_name: filename,\n        mime_type: mime,\n        received_at: new Date(now).toISOString(),\n        metadata: {\n          bot_receipt_id: id,\n          chat_id: chatId,\n          status: 'pending',\n          text: text || '',\n          saved_from_bot: true,\n        },\n      });\n      logger.info({ id, chatId, filename }, 'Comprobante guardado en DB via API');\n    } catch (err: any) {\n      logger.warn({ err, id, chatId }, 'Error guardando comprobante en DB, solo guardado en JSON');\n    }\n\n    return { id, filepath, entry };\n  }\n\n  // Convert image buffer (jpg/png) to a single-page PDF buffer\n  async function imageBufferToPdfBuffer(imageBuf: Buffer, filename: string) {\n    // dynamic import to avoid build-time ESM issues\n    const mod = await import('pdfkit');\n    const PDFDocument: any = mod && (mod as any).default ? (mod as any).default : mod;\n    return await new Promise<Buffer>((resolve, reject) => {\n      try {\n        const doc = new PDFDocument({ autoFirstPage: false });\n  const chunks: Buffer[] = [];\n  doc.on('data', (chunk: Uint8Array) => chunks.push(Buffer.from(chunk)));\n  doc.on('end', () => resolve(Buffer.concat(chunks)));\n  doc.on('error', (err: any) => reject(err));\n        // add a page sized to the image\n        const img = doc.openImage ? doc.openImage(imageBuf) : undefined;\n        if (img) {\n          doc.addPage({ size: [img.width, img.height] });\n          doc.image(img, 0, 0);\n        } else {\n          // fallback: add A4 and scale image\n          doc.addPage('A4');\n          doc.image(imageBuf, { fit: [500, 700], align: 'center', valign: 'center' });\n        }\n        doc.end();\n      } catch (e) {\n        reject(e);\n      }\n    });\n  }\n\n  async function updateReceiptEntry(id: string, patch: Record<string, any>) {\n    try {\n      await ensureReceiptsDir();\n      const raw = await fs.readFile(RECEIPTS_INDEX, { encoding: 'utf8' });\n      const arr = JSON.parse(raw || '[]');\n      let changed = false;\n      let entry: any = null;\n      for (const it of arr) {\n        if (it && it.id === id) {\n          Object.assign(it, patch);\n          changed = true;\n          entry = it;\n          break;\n        }\n      }\n      if (changed) {\n        await fs.writeFile(RECEIPTS_INDEX, JSON.stringify(arr, null, 2), { encoding: 'utf8' });\n        \n        // Also update in database if it has backend_id or backend_payment_id\n        const backendId = entry?.backend_id || entry?.backend_payment_id;\n        if (backendId) {\n          try {\n            // For now, we'll just log this. Future enhancement: create update endpoint\n            logger.debug({ id, backendId, patch }, 'Comprobante actualizado (backend sync pending)');\n          } catch (err: any) {\n            logger.debug({ err, id }, 'Error sincronizando actualización con DB');\n          }\n        }\n      }\n      return changed;\n    } catch (e) {\n      logger.warn({ e, id, patch }, 'No se pudo actualizar índice de comprobantes');\n      return false;\n    }\n  }\n\n  await whatsappClient.initialize();\n\n  // Inicializar procesador de admin queue (si existe)\n  try {\n  const DATA_DIR = path.join(process.cwd(), 'data');\n    const QUEUE_FILE = path.join(DATA_DIR, 'admin_queue.json');\n    const RESULTS_FILE = path.join(DATA_DIR, 'admin_results.json');\n    // asegurar carpeta\n    try { await fs.mkdir(DATA_DIR, { recursive: true }); } catch {}\n\n    async function loadJson<T = any>(file: string, fallback: T): Promise<T> {\n      try {\n        const raw = await fs.readFile(file, { encoding: 'utf8' });\n        return JSON.parse(raw || 'null') ?? fallback;\n      } catch {\n        return fallback;\n      }\n    }\n\n    async function saveJson(file: string, data: any) {\n      await fs.writeFile(file, JSON.stringify(data, null, 2), { encoding: 'utf8' });\n    }\n\n    let _adminQueueRunning = false;\n    async function processAdminQueueOnce() {\n      if (_adminQueueRunning) return;\n      _adminQueueRunning = true;\n      const q = await loadJson(QUEUE_FILE, { queue: [] } as any);\n      const results = await loadJson(RESULTS_FILE, {} as any);\n      const remaining: any[] = [];\n\n      for (const item of q.queue || []) {\n        if (!item || !item.id || !item.type) continue;\n        if (results[item.id]) continue;\n\n        if (item.type === 'ping') {\n          results[item.id] = { ok: true, time: new Date().toISOString(), uptimeSec: Math.floor(process.uptime()) };\n        } else if (item.type === 'sendText') {\n          try {\n            const chatId = normalizeToChatId(item.phone);\n            if (!chatId) throw new Error('phone inválido');\n            const text = String(item.text || '').trim() || 'Mensaje de prueba';\n            await whatsappClient.sendText(chatId, text);\n            results[item.id] = { ok: true, sent: true };\n          } catch (e: any) {\n            results[item.id] = { ok: false, error: String(e && e.message ? e.message : e) };\n          }\n        } else if (item.type === 'runScheduler') {\n          try {\n            await processor.runBatch();\n            results[item.id] = { ok: true, ran: true, time: new Date().toISOString() };\n          } catch (e: any) {\n            results[item.id] = { ok: false, error: String(e && e.message ? e.message : e) };\n          }\n        } else if (item.type === 'state') {\n          try {\n            const state = await whatsappClient.getState();\n            results[item.id] = { ok: true, ...state };\n          } catch (e: any) {\n            results[item.id] = { ok: false, error: String(e && e.message ? e.message : e) };\n          }\n        } else {\n          results[item.id] = { ok: false, error: 'tipo no soportado' };\n        }\n      }\n\n      // Guardar resultados e identificar pendientes\n      await saveJson(RESULTS_FILE, results);\n      for (const it of q.queue || []) {\n        if (!it || !it.id) continue;\n        if (!results[it.id]) remaining.push(it);\n      }\n      q.queue = remaining;\n      await saveJson(QUEUE_FILE, q);\n      _adminQueueRunning = false;\n    }\n\n    setInterval(() => {\n      processAdminQueueOnce().catch(e => logger.warn({ e }, 'Admin queue error'));\n    }, 2000);\n  } catch (e) {\n    logger.debug({ e }, 'No se pudo inicializar admin queue processor');\n  }\n\n  // --- small webhook receiver so backend/admin can notify the bot about reconciled receipts\n  function startWebhookServer() {\n    const basePort = Number(process.env.BOT_WEBHOOK_PORT || 3001);\n    const server = http.createServer(async (req, res) => {\n      try {\n        const remoteAddress = req.socket?.remoteAddress || '';\n        const isLocal =\n          remoteAddress === '127.0.0.1' ||\n          remoteAddress === '::1' ||\n          remoteAddress === '::ffff:127.0.0.1';\n\n        const u = new URL(req.url || '/', `http://${req.headers.host}`);\n\n        // --- Debug endpoints (solo localhost) ---\n        if (req.method === 'GET' && u.pathname === '/debug/state') {\n          if (!isLocal) {\n            res.writeHead(403, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'forbidden' }));\n            return;\n          }\n\n          const state = await whatsappClient.getState();\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify({ ok: true, ...state }));\n          return;\n        }\n\n        if (req.method === 'GET' && u.pathname === '/debug/chats') {\n          if (!isLocal) {\n            res.writeHead(403, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'forbidden' }));\n            return;\n          }\n\n          const summary = await whatsappClient.debugGetChatsSummary();\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify(summary));\n          return;\n        }\n\n        if (req.method === 'POST' && u.pathname === '/debug/ping_admin') {\n          if (!isLocal) {\n            res.writeHead(403, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'forbidden' }));\n            return;\n          }\n\n          const adminPhone = ADMIN_PHONES[0] || null;\n          const adminChatId = adminPhone ? normalizeToChatId(adminPhone) : null;\n          if (!adminChatId) {\n            res.writeHead(400, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'admin chatId not configured' }));\n            return;\n          }\n\n          const ts = new Date().toISOString();\n          await whatsappClient.sendText(adminChatId, `Ping del bot (${ts}). Si ves esto, el envío funciona.`);\n          res.writeHead(200, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify({ ok: true, to: adminChatId }));\n          return;\n        }\n\n        if (req.method === 'POST' && u.pathname === '/webhook/receipt_reconciled') {\n          let raw = '';\n          for await (const chunk of req) raw += chunk;\n          const payload = raw ? JSON.parse(raw) : {};\n          const backendId = payload.backend_id ?? payload.receipt_id ?? null;\n          const localId = payload.receipt_local_id ?? payload.receipt_id_local ?? null;\n          const pdfBase64 = payload.pdf_base64 ?? null;\n          const pdfUrl = payload.pdf_url ?? null;\n          const pdfPath = payload.pdf_path ?? null;\n          const message = payload.message ?? null;\n\n          if (!backendId && !localId) {\n            res.writeHead(400, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'backend_id or receipt_local_id required' }));\n            return;\n          }\n\n          // find local receipt entry\n          let indexRaw = '[]';\n          try { indexRaw = await fs.readFile(RECEIPTS_INDEX, { encoding: 'utf8' }); } catch {}\n          const arr = JSON.parse(indexRaw || '[]');\n          const entry = arr.find((r: any) => \n            (localId && r.id === localId) || \n            (backendId && (r.backend_id === backendId || r.backend_payment_id === backendId))\n          );\n          if (!entry) {\n            res.writeHead(404, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'receipt not found' }));\n            return;\n          }\n\n          // determine PDF base64\n          let base64data: string | null = null;\n          let filename = `reconciled-${entry.id}.pdf`;\n          if (pdfBase64) {\n            base64data = pdfBase64.replace(/^data:application\\/(pdf);base64,/, '');\n          } else if (pdfPath) {\n            try {\n              const buff = await fs.readFile(pdfPath);\n              base64data = buff.toString('base64');\n              filename = path.basename(pdfPath);\n            } catch (e) {\n              // ignore\n            }\n          } else if (pdfUrl) {\n            try {\n              const resp = await axios.get(pdfUrl, { responseType: 'arraybuffer' });\n              base64data = Buffer.from(resp.data).toString('base64');\n              const urlObj = new URL(pdfUrl);\n              filename = path.basename(urlObj.pathname) || filename;\n            } catch (e) {\n              // ignore\n            }\n          } else if (entry.reconciled_pdf) {\n            try {\n              const buff = await fs.readFile(entry.reconciled_pdf);\n              base64data = buff.toString('base64');\n              filename = path.basename(entry.reconciled_pdf);\n            } catch (e) {\n              // ignore\n            }\n          }\n\n          if (!base64data) {\n            // no pdf available to send\n            await updateReceiptEntry(entry.id, { reconciled: true, reconciled_sent: false });\n            res.writeHead(200, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: true, note: 'marked reconciled, no pdf to send' }));\n            return;\n          }\n\n          // send to client via WhatsApp\n          try {\n            const chatId = entry.chatId || entry.chat_id;\n            if (!chatId) throw new Error('chatId missing');\n            \n            // Enviar el PDF\n            await whatsappClient.sendMedia(chatId, base64data, 'application/pdf', filename);\n            \n            // Enviar el mensaje de texto si se proporcionó\n            if (message && message.trim().length > 0) {\n              await whatsappClient.sendText(chatId, message);\n            }\n            \n            await updateReceiptEntry(entry.id, { reconciled: true, reconciled_sent: true, reconciled_sent_ts: Date.now() });\n            res.writeHead(200, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: true }));\n            return;\n          } catch (e: any) {\n            logger.warn({ e, entry }, 'Error enviando PDF reconciliado al cliente');\n            await updateReceiptEntry(entry.id, { reconciled: true, reconciled_sent: false });\n            res.writeHead(500, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: String(e && e.message ? e.message : e) }));\n            return;\n          }\n        }\n\n        // Endpoint para enviar PDF directamente a un cliente (para pagos manuales)\n        if (req.method === 'POST' && u.pathname === '/webhook/send_pdf') {\n          let raw = '';\n          for await (const chunk of req) raw += chunk;\n          const payload = raw ? JSON.parse(raw) : {};\n          const phone = payload.phone ?? null;\n          const message = payload.message ?? null;\n          const pdfBase64 = payload.pdf_base64 ?? null;\n          const pdfPath = payload.pdf_path ?? null;\n          const paymentId = payload.payment_id ?? null;\n\n          if (!phone) {\n            res.writeHead(400, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'phone required' }));\n            return;\n          }\n\n          // Normalizar el teléfono al formato chatId\n          const chatId = normalizeToChatId(phone);\n          if (!chatId) {\n            res.writeHead(400, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'invalid phone format' }));\n            return;\n          }\n\n          // Obtener el PDF en base64\n          let base64data: string | null = null;\n          let filename = `payment-${paymentId || Date.now()}.pdf`;\n          \n          if (pdfBase64) {\n            base64data = pdfBase64.replace(/^data:application\\/(pdf);base64,/, '');\n          } else if (pdfPath) {\n            try {\n              const buff = await fs.readFile(pdfPath);\n              base64data = buff.toString('base64');\n              filename = path.basename(pdfPath);\n            } catch (e) {\n              logger.warn({ e, pdfPath }, 'Error leyendo PDF desde path');\n            }\n          }\n\n          if (!base64data) {\n            res.writeHead(400, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: 'no pdf data provided' }));\n            return;\n          }\n\n          // Enviar el PDF al cliente\n          try {\n            await whatsappClient.sendMedia(chatId, base64data, 'application/pdf', filename);\n            \n            // Enviar el mensaje de texto si se proporcionó\n            if (message && message.trim().length > 0) {\n              await whatsappClient.sendText(chatId, message);\n            }\n            \n            logger.info({ chatId, paymentId, filename }, 'PDF de pago manual enviado al cliente');\n            res.writeHead(200, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: true }));\n            return;\n          } catch (e: any) {\n            logger.warn({ e, chatId, paymentId }, 'Error enviando PDF de pago manual al cliente');\n            res.writeHead(500, { 'Content-Type': 'application/json' });\n            res.end(JSON.stringify({ ok: false, error: String(e && e.message ? e.message : e) }));\n            return;\n          }\n        }\n\n        res.writeHead(404, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({ ok: false, error: 'not found' }));\n      } catch (err: any) {\n        logger.warn({ err }, 'Webhook handler error');\n        res.writeHead(500, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({ ok: false, error: String(err && err.message ? err.message : err) }));\n      }\n    });\n\n    const tryListen = (port: number) => {\n      server.once('error', (err: any) => {\n        if (err && (err.code === 'EADDRINUSE' || err.code === 'EACCES')) {\n          logger.warn({ err, port }, 'Webhook server no pudo abrir puerto; intentando alternativo');\n          // Intentar 3002 y luego un puerto efímero\n          const next = port === basePort ? basePort + 1 : 0;\n          // Si next=0, el OS asigna uno libre\n          tryListen(next);\n          return;\n        }\n        logger.error({ err, port }, 'Webhook server error');\n      });\n\n      server.listen(port, () => {\n        const addr = server.address();\n        logger.info({ port, addr }, 'Webhook server listening');\n      });\n    };\n\n    tryListen(basePort);\n  }\n\n  startWebhookServer();\n\n  // Load settings from backend API and refresh periodically\n  async function loadSettingsFromApi() {\n    try {\n      const s = await apiClient.getSettings();\n      if (!s) return;\n      // payment contact\n      if (s.payment_contact) {\n        (config as any).paymentContact = String(s.payment_contact);\n      }\n      // bank accounts: accept newline or ; separators\n      if (s.bank_accounts) {\n        (config as any).bankAccounts = String(s.bank_accounts)\n          .split(/\\r?\\n|;/)\n          .map((x: string) => x.trim())\n          .filter(Boolean);\n      }\n      if (s.service_name) {\n        (config as any).serviceName = String(s.service_name);\n      }\n      if (s.beneficiary_name) {\n        (config as any).beneficiaryName = String(s.beneficiary_name);\n      }\n      // Allow backend to configure business hours and timezone\n      if (s.business_hours) {\n        try {\n          // business_hours can be an object or a JSON string\n          const bh = typeof s.business_hours === 'string' ? JSON.parse(s.business_hours) : s.business_hours;\n          if (bh && typeof bh === 'object') {\n            // normalize keys to numbers 0-6\n            const parsed: Record<number, { open: string; close: string }> = {} as any;\n            for (const k of Object.keys(bh)) {\n              const nk = Number(k);\n              if (!Number.isNaN(nk)) parsed[nk] = bh[k];\n            }\n            BUSINESS_HOURS = Object.assign({}, BUSINESS_HOURS, parsed);\n          }\n        } catch (e) {\n          logger.debug({ e }, 'invalid business_hours in settings');\n        }\n      }\n\n      if (s.bot_timezone || s.timezone) {\n        try {\n          TIMEZONE = String(s.bot_timezone || s.timezone || TIMEZONE);\n        } catch (e) {\n          logger.debug({ e }, 'invalid timezone in settings');\n        }\n      }\n      logger.info({ loaded: Object.keys(s) }, 'Settings cargadas desde API');\n    } catch (e: any) {\n      logger.warn({ e }, 'No se pudieron cargar settings desde API');\n    }\n  }\n\n  // initial load and refresh every 5 minutes\n  await loadSettingsFromApi();\n  setInterval(loadSettingsFromApi, Number(process.env.BOT_SETTINGS_POLL_MS || 5 * 60 * 1000));\n\n  await runBatch();\n  const interval = setInterval(runBatch, config.pollIntervalMs);\n\n  logger.info({ intervalMs: config.pollIntervalMs }, 'Servicio de recordatorios iniciado');\n\n  const gracefulShutdown = async (signal: string) => {\n    logger.info({ signal }, 'Recibida señal de apagado, cerrando bot.');\n    clearInterval(interval);\n\n    try {\n      await whatsappClient.shutdown();\n    } catch (error) {\n      logger.warn({ err: error }, 'Error cerrando el cliente de WhatsApp');\n    }\n\n    process.exit(0);\n  };\n\n  process.on('SIGINT', () => {\n    void gracefulShutdown('SIGINT');\n  });\n\n  process.on('SIGTERM', () => {\n    void gracefulShutdown('SIGTERM');\n  });\n}\n\nmain().catch((error) => {\n  logger.fatal({ err: error }, 'El bot de WhatsApp se detuvo por un error inesperado');\n  // Try to shutdown WhatsApp client to avoid leaving Chromium processes running\n  void (async () => {\n    try {\n      await whatsappClient.shutdown();\n    } catch (err) {\n      logger.warn({ err }, 'Error cerrando WhatsAppClient después de un fallo fatal');\n    }\n    process.exit(1);\n  })();\n});\n"],"mappings":"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","names":["pRetry","path","pRetry","axios","parsed","e","isOutsideHours"]}